<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>应用安装-开机安装应用 | 得一</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="AndroidPackageManagerServicePKMS">
  
  
  
  
  <meta name="description" content="一、应用安装类型1. 安装方式：  安装系统APK和预制APK时，通过PMS的构造函数中安装，即第一次开机时安装应用，没有安装界面。 网络下载安装，通过应用商店等，即调用PackageManager.installPackage()，有安装界面。 通过adb工具安装，没有安装界面，它通过启动pm脚本的形式，然后调用com.android.commands.pm.Pm类，之后调用到PMS.insta">
<meta name="keywords" content="Android,PackageManagerService,PKMS">
<meta property="og:type" content="article">
<meta property="og:title" content="应用安装-开机安装应用">
<meta property="og:url" content="https://mouzishuo.github.io/2018/07/22/应用安装-开机安装应用/index.html">
<meta property="og:site_name" content="得一">
<meta property="og:description" content="一、应用安装类型1. 安装方式：  安装系统APK和预制APK时，通过PMS的构造函数中安装，即第一次开机时安装应用，没有安装界面。 网络下载安装，通过应用商店等，即调用PackageManager.installPackage()，有安装界面。 通过adb工具安装，没有安装界面，它通过启动pm脚本的形式，然后调用com.android.commands.pm.Pm类，之后调用到PMS.insta">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-01-16T01:14:47.520Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="应用安装-开机安装应用">
<meta name="twitter:description" content="一、应用安装类型1. 安装方式：  安装系统APK和预制APK时，通过PMS的构造函数中安装，即第一次开机时安装应用，没有安装界面。 网络下载安装，通过应用商店等，即调用PackageManager.installPackage()，有安装界面。 通过adb工具安装，没有安装界面，它通过启动pm脚本的形式，然后调用com.android.commands.pm.Pm类，之后调用到PMS.insta">
  

  

  <link rel="icon" href="/css/images/avatar.jpg">
  <link rel="apple-touch-icon" href="/css/images/avatar.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">

  
    <link rel="stylesheet" href="/css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css">
  

  
  
  

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 5px;" href="#" data-toggle="modal" data-target="#myModal">
                  <img width="93px" height="93px" alt="Hike News" src="/css/images/avatar.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">分类</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div></li>
            </ul></div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-应用安装-开机安装应用" style="width: 75%; float:left;" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      应用安装-开机安装应用
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/07/22/应用安装-开机安装应用/" class="article-date">
	  <time datetime="2018-07-22T07:25:08.000Z" itemprop="datePublished">2018-07-22</time>
	</a>

      
    <a class="article-category-link" href="/categories/Android/">Android</a><a class="article-category-link" href="/categories/Android/应用安装/">应用安装</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、应用安装类型"><a href="#一、应用安装类型" class="headerlink" title="一、应用安装类型"></a>一、应用安装类型</h2><p><strong>1. 安装方式：</strong></p>
<ol>
<li>安装系统APK和预制APK时，通过PMS的构造函数中安装，即第一次开机时安装应用，没有安装界面。</li>
<li>网络下载安装，通过应用商店等，即调用PackageManager.installPackage()，有安装界面。</li>
<li>通过adb工具安装，没有安装界面，它通过启动pm脚本的形式，然后调用com.android.commands.pm.Pm类，之后调用到PMS.installStage()完成安装。</li>
<li>安装本地apk，有安装界面，由PackageInstaller系统应用安装。<br>上述几种方式均通过PackageInstallObserver来监听安装是否成功。</li>
</ol>
<p><strong>2. 涉及到的路径</strong><br>应用安装涉及到如下几个目录：        </p>
<ul>
<li>/system/app：系统自带的应用程序，获得adb root权限才能删除</li>
<li>data/app  —————用户程序安装的目录。安装时把apk文件复制到此目录</li>
<li>data/data —————存放应用程序的数据</li>
<li>data/dalvik-cache——–将apk中的dex文件安装到dalvik-cache目录下(dex文件是dalvik虚拟机的可执行文件,其大小约为原始apk文件大小的四分之一)</li>
</ul>
<p>安装过程中复制APK安装包到data/app目录下，解压并扫描安装包，把dex文件(Dalvik字节码)保存到dalvik-cache目录，并data/data目录下创建对应的应用数据目录。</p>
<p>卸载时删除安装过程中在上述几个目录下创建的文件及目录。</p>
<p>以上内容参考<a href="https://www.cnblogs.com/meizixiong/p/3551891.html。" target="_blank" rel="noopener">https://www.cnblogs.com/meizixiong/p/3551891.html。</a></p>
<h2 id="二、安装过程"><a href="#二、安装过程" class="headerlink" title="二、安装过程"></a>二、安装过程</h2><p><a href="https://www.cnblogs.com/z1987/p/8974719.html提供了四种安装方式的时序图。" target="_blank" rel="noopener">https://www.cnblogs.com/z1987/p/8974719.html提供了四种安装方式的时序图。</a></p>
<p><a href="https://www.jianshu.com/p/4f16421d5c7f系统讲解了PKMS。" target="_blank" rel="noopener">https://www.jianshu.com/p/4f16421d5c7f系统讲解了PKMS。</a></p>
<h3 id="首次开机安装"><a href="#首次开机安装" class="headerlink" title="首次开机安装"></a>首次开机安装</h3><p>该过程在PKMS的构造方法中进行，主要的工作是解析预置app的相关信息，写入到/data/system/packages.xml中，并处理应用的数据。之后开机的扫描过程用于处理应用发生改变的情况，比如通过adb改变包，ota升级改变apk等。</p>
<ol>
<li>首先是设置scanFlags:</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> scanFlags = SCAN_BOOTING | SCAN_INITIAL;</span><br><span class="line"><span class="keyword">if</span> (mIsUpgrade || mFirstBoot) &#123;</span><br><span class="line">    scanFlags = scanFlags | SCAN_FIRST_BOOT_OR_UPGRADE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>收集系统目录下的app，包括以下几个目录：</p>
<blockquote>
<p>/vendor/overlay<br>/system/framework<br>/system/priv-app<br>/system/app<br>/vendor/priv-app<br>/vendor/app<br>/oem/app</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">// Collect vendor overlay packages. (Do this before scanning any apps.)</span></span><br><span class="line">      <span class="comment">// For security and version matching reason, only consider</span></span><br><span class="line">      <span class="comment">// overlay packages if they reside in the right directory.</span></span><br><span class="line">      scanDirTracedLI(<span class="keyword">new</span> File(VENDOR_OVERLAY_DIR), mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">              | PackageParser.PARSE_TRUSTED_OVERLAY, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line"><span class="comment">//记录AndroidManifest文件的android:isStatic为true的package</span></span><br><span class="line">      mParallelPackageParserCallback.findStaticOverlayPackages();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Find base frameworks (resource packages without code).</span></span><br><span class="line">      scanDirTracedLI(frameworkDir, mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">              | PackageParser.PARSE_IS_PRIVILEGED,</span><br><span class="line">              scanFlags | SCAN_NO_DEX, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Collected privileged system packages.</span></span><br><span class="line">      <span class="keyword">final</span> File privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>);</span><br><span class="line">      scanDirTracedLI(privilegedAppDir, mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">              | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Collect ordinary system packages.</span></span><br><span class="line">      <span class="keyword">final</span> File systemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</span><br><span class="line">      scanDirTracedLI(systemAppDir, mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Collect all vendor packages.</span></span><br><span class="line">      File vendorAppDir = <span class="keyword">new</span> File(<span class="string">"/vendor/app"</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          vendorAppDir = vendorAppDir.getCanonicalFile();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">      &#125;</span><br><span class="line">      scanDirTracedLI(vendorAppDir, mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Collect all OEM packages.</span></span><br><span class="line">      <span class="keyword">final</span> File oemAppDir = <span class="keyword">new</span> File(Environment.getOemDirectory(), <span class="string">"app"</span>);</span><br><span class="line">      scanDirTracedLI(oemAppDir, mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>几个目录下的扫描过程类似，/vendor/overay比较特殊，该目录下的app用于进行运行时资源替换（RRO）。该部分扫描只会处理framework-res.apk之外apk的rro，因为framework-res.apk比较特殊，必须在系统启动的时候就进行处理，该过程在native层进行，这里不做了解。/vendor/overay下的app扫描完之后，相比其他目录多了<code>mParallelPackageParserCallback.findStaticOverlayPackages();</code>的操作，用于找出rro中的staticOverlay，staticOverlay是在Android O中才出现的，非static的overlay默认是disable的，但是可以在adb中进行enable，具体可以了解OverlayManagerService及其他资源管理相关内容。</p>
<p>​</p>
<p><code>scanDirTracedLI</code>的实现如下：</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirTracedLI</span><span class="params">(File dir, <span class="keyword">final</span> <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"scanDir ["</span> + dir.getAbsolutePath() + <span class="string">"]"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        scanDirLI(dir, parseFlags, scanFlags, currentTime);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanDirLI</span><span class="params">(File dir, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> File[] files = dir.listFiles();</span><br><span class="line">      <span class="keyword">if</span> (ArrayUtils.isEmpty(files)) &#123;</span><br><span class="line">          Log.d(TAG, <span class="string">"No files in app dir "</span> + dir);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">          Log.d(TAG, <span class="string">"Scanning app dir "</span> + dir + <span class="string">" scanFlags="</span> + scanFlags</span><br><span class="line">                  + <span class="string">" flags=0x"</span> + Integer.toHexString(parseFlags));</span><br><span class="line">      &#125;</span><br><span class="line">      ParallelPackageParser parallelPackageParser = <span class="keyword">new</span> ParallelPackageParser(</span><br><span class="line">              mSeparateProcesses, mOnlyCore, mMetrics, mCacheDir,</span><br><span class="line">              mParallelPackageParserCallback);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Submit files for parsing in parallel</span></span><br><span class="line">      <span class="keyword">int</span> fileCount = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">boolean</span> isPackage = (isApkFile(file) || file.isDirectory())</span><br><span class="line">                  &amp;&amp; !PackageInstallerService.isStageName(file.getName());</span><br><span class="line">          <span class="keyword">if</span> (!isPackage) &#123;</span><br><span class="line">              <span class="comment">// Ignore entries which are not packages</span></span><br><span class="line">              <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          parallelPackageParser.submit(file, parseFlags);</span><br><span class="line">          fileCount++;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Process results one by one</span></span><br><span class="line">      <span class="keyword">for</span> (; fileCount &gt; <span class="number">0</span>; fileCount--) &#123;</span><br><span class="line">          ParallelPackageParser.ParseResult parseResult = parallelPackageParser.take();</span><br><span class="line">          Throwable throwable = parseResult.throwable;</span><br><span class="line">          <span class="keyword">int</span> errorCode = PackageManager.INSTALL_SUCCEEDED;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (throwable == <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// Static shared libraries have synthetic package names</span></span><br><span class="line">              <span class="keyword">if</span> (parseResult.pkg.applicationInfo.isStaticSharedLibrary()) &#123;</span><br><span class="line">                  renameStaticSharedLibraryPackage(parseResult.pkg);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="keyword">if</span> (errorCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                      scanPackageLI(parseResult.pkg, parseResult.scanFile, parseFlags, scanFlags,</span><br><span class="line">                              currentTime, <span class="keyword">null</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                  errorCode = e.error;</span><br><span class="line">                  Slog.w(TAG, <span class="string">"Failed to scan "</span> + parseResult.scanFile + <span class="string">": "</span> + e.getMessage());</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> PackageParser.PackageParserException) &#123;</span><br><span class="line">              PackageParser.PackageParserException e = (PackageParser.PackageParserException)</span><br><span class="line">                      throwable;</span><br><span class="line">              errorCode = e.error;</span><br><span class="line">              Slog.w(TAG, <span class="string">"Failed to parse "</span> + parseResult.scanFile + <span class="string">": "</span> + e.getMessage());</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unexpected exception occurred while parsing "</span></span><br><span class="line">                      + parseResult.scanFile, throwable);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Delete invalid userdata apps</span></span><br><span class="line">          <span class="keyword">if</span> ((parseFlags &amp; PackageParser.PARSE_IS_SYSTEM) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                  errorCode == PackageManager.INSTALL_FAILED_INVALID_APK) &#123;</span><br><span class="line">              logCriticalInfo(Log.WARN,</span><br><span class="line">                      <span class="string">"Deleting invalid package at "</span> + parseResult.scanFile);</span><br><span class="line">              removeCodePathLI(parseResult.scanFile);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      parallelPackageParser.close();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>scanDirTracedLI调用了scanDirLI方法,该方法的逻辑很简单，扫描/vendor/overlay目录下的所有文件，将apk文件和文件夹提交给<code>ParallelPackageParser</code>进行解析，<code>ParallelPackageParser</code>中采用了线程池和BlockingQueue进行并发的解析，解析类为PackageParser，主要是解析app的AndroidManifest.xml文件/解析结果放到<code>BlockingQueue</code>中，再通过take方法取出，关于ParallelPackageParser会另行总结，现在先关心主线 。解析正常的话，将结果传递给<code>scanPackageLI</code>方法进行进一步处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, File scanFile,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, @Nullable UserHandle user)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">        <span class="comment">// If the package has children and this is the first dive in the function</span></span><br><span class="line">        <span class="comment">// we scan the package with the SCAN_CHECK_ONLY flag set to see whether all</span></span><br><span class="line">        <span class="comment">// packages (parent and children) would be successfully scanned before the</span></span><br><span class="line">        <span class="comment">// actual scan since scanning mutates internal state and we want to atomically</span></span><br><span class="line">        <span class="comment">// install the package and its children.</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pkg.childPackages != <span class="keyword">null</span> &amp;&amp; pkg.childPackages.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                scanFlags |= SCAN_CHECK_ONLY;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            scanFlags &amp;= ~SCAN_CHECK_ONLY;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Scan the parent</span></span><br><span class="line">        PackageParser.Package scannedPkg = scanPackageInternalLI(pkg, scanFile, policyFlags,</span><br><span class="line">                scanFlags, currentTime, user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Scan the children</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = (pkg.childPackages != <span class="keyword">null</span>) ? pkg.childPackages.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">            PackageParser.Package childPackage = pkg.childPackages.get(i);</span><br><span class="line">            scanPackageInternalLI(childPackage, scanFile, policyFlags, scanFlags,</span><br><span class="line">                    currentTime, user);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> scanPackageLI(pkg, scanFile, policyFlags, scanFlags, currentTime, user);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> scannedPkg;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里有个问题，既然已经解析出了Package信息，为什么还要对得到的Package对象再次进行解析呢？这里主要是为了处理应用升级的情况。</p>
<p>关于children package还不清楚是什么，这里先不去了解，还是先关心主线再说。除去children package相关的内容，其实这个方法里只有一行关键代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PackageParser.Package scannedPkg = scanPackageInternalLI(pkg, scanFile, policyFlags,</span><br><span class="line">        scanFlags, currentTime, user);</span><br></pre></td></tr></table></figure>
<p><code>scanPackageInternalLI</code>方法很长，里面包含很多和升级相关的代码，这里暂时只了解应用的安装过程，<strong>应用升级以后再做了解</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PackageParser.Package scannedPkg = scanPackageLI(pkg, policyFlags, scanFlags</span><br><span class="line">        | SCAN_UPDATE_SIGNATURE, currentTime, user);</span><br></pre></td></tr></table></figure>
<p><code>scanPackageLI</code>方法中调用了<code>scanPackageLI</code>方法来实现package的扫描：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(PackageParser.Package pkg, <span class="keyword">final</span> <span class="keyword">int</span> policyFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, @Nullable UserHandle user)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package res = scanPackageDirtyLI(pkg, policyFlags, scanFlags,</span><br><span class="line">                currentTime, user);</span><br><span class="line">        success = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!success &amp;&amp; (scanFlags &amp; SCAN_DELETE_DATA_ON_FAILURES) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// DELETE_DATA_ON_FAILURES is only used by frozen paths</span></span><br><span class="line">  <span class="comment">//……</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>scanPackageDirtyLI</code>的代码太多，一部分一部分的来看。</p>
<p>1) applyPolicy</p>
<p><code>applyPolicy(pkg, policyFlags);</code>该方法根据发起扫描时传递的parseFlags设置Package对象中的一些属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Applies policy to the parsed package based upon the given policy flags.</span></span><br><span class="line"><span class="comment"> * Ensures the package is in a good state.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Implementation detail: This method must NOT have any side effect. It would</span></span><br><span class="line"><span class="comment"> * ideally be static, but, it requires locks to read system state.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyPolicy</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> policyFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.isDirectBootAware()) &#123;<span class="comment">//加密时不输入密码即可访问</span></span><br><span class="line">            <span class="comment">// we're direct boot aware; set for all components</span></span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Service s : pkg.services) &#123;</span><br><span class="line">                s.info.encryptionAware = s.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Provider p : pkg.providers) &#123;</span><br><span class="line">                p.info.encryptionAware = p.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Activity a : pkg.activities) &#123;</span><br><span class="line">                a.info.encryptionAware = a.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (PackageParser.Activity r : pkg.receivers) &#123;</span><br><span class="line">                r.info.encryptionAware = r.info.directBootAware = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (compressedFileExists(pkg.codePath)) &#123;</span><br><span class="line">            pkg.isStub = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Only allow system apps to be flagged as core apps.</span></span><br><span class="line">        pkg.coreApp = <span class="keyword">false</span>;<span class="comment">//也就是说不是systemapp设置了coreApp的属性也是没用的</span></span><br><span class="line">        <span class="comment">// clear flags not applicable to regular apps</span></span><br><span class="line">        pkg.applicationInfo.privateFlags &amp;=</span><br><span class="line">                ~ApplicationInfo.PRIVATE_FLAG_DEFAULT_TO_DEVICE_PROTECTED_STORAGE;</span><br><span class="line">        pkg.applicationInfo.privateFlags &amp;=</span><br><span class="line">                ~ApplicationInfo.PRIVATE_FLAG_DIRECT_BOOT_AWARE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//表示/vendor/overlay下的app</span></span><br><span class="line">    pkg.mTrustedOverlay = (policyFlags&amp;PackageParser.PARSE_TRUSTED_OVERLAY) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_IS_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">        pkg.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isSystemApp(pkg)) &#123;</span><br><span class="line">        <span class="comment">// Only system apps can use these features.</span></span><br><span class="line">        pkg.mOriginalPackages = <span class="keyword">null</span>;<span class="comment">//关于origin-package可以参考另一个</span></span><br><span class="line">        pkg.mRealPackage = <span class="keyword">null</span>;</span><br><span class="line">        pkg.mAdoptPermissions = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2) assertPackageIsValid</p>
<p><code>assertPackageIsValid(pkg, policyFlags, scanFlags);</code>验证pkg是否有效，如返回PackageManagerException异常会被<code>scanDirLI</code>方法捕获。该方法中进行了包名重复apk的检验、StaticSharedLibrary相关检验、child package检验、路径检测和content provider冲突检测等工作，逻辑比较简单但是代码比较多，就不贴出来了，需要的时候去看下代码就好。</p>
<p>3) 变量初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initialize package source and resource directories</span></span><br><span class="line"><span class="keyword">final</span> File scanFile = <span class="keyword">new</span> File(pkg.codePath);</span><br><span class="line"><span class="keyword">final</span> File destCodeFile = <span class="keyword">new</span> File(pkg.applicationInfo.getCodePath());</span><br><span class="line"><span class="keyword">final</span> File destResourceFile = <span class="keyword">new</span> File(pkg.applicationInfo.getResourcePath());</span><br><span class="line"></span><br><span class="line">SharedUserSetting suid = <span class="keyword">null</span>;</span><br><span class="line">PackageSetting pkgSetting = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Getting the package setting may have a side-effect, so if we</span></span><br><span class="line"><span class="comment">// are only checking if scan would succeed, stash a copy of the</span></span><br><span class="line"><span class="comment">// old setting to restore at the end.</span></span><br><span class="line">PackageSetting nonMutatedPs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We keep references to the derived CPU Abis from settings in oder to reuse</span></span><br><span class="line"><span class="comment">// them in the case where we're not upgrading or booting for the first time.</span></span><br><span class="line">String primaryCpuAbiFromSettings = <span class="keyword">null</span>;</span><br><span class="line">String secondaryCpuAbiFromSettings = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<p>4) <strong>之后的代码会锁mPackages.</strong>该部分代码的分洗直接添加再注释中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pkg.mSharedUserId != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// SIDE EFFECTS; may potentially allocate a new shared user</span></span><br><span class="line">        <span class="comment">// 根据ｐｋｇ中信息生成新的ｕｉｄ，不存在则创建一个</span></span><br><span class="line">        suid = mSettings.getSharedUserLPw(</span><br><span class="line">                pkg.mSharedUserId, <span class="number">0</span> <span class="comment">/*pkgFlags*/</span>, <span class="number">0</span> <span class="comment">/*pkgPrivateFlags*/</span>, <span class="keyword">true</span> <span class="comment">/*create*/</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ……origin-package相关内容，该部分摘出去，单独了解</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// See comments in nonMutatedPs declaration</span></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">        PackageSetting foundPs = mSettings.getPackageLPr(pkg.packageName);</span><br><span class="line">        <span class="keyword">if</span> (foundPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            nonMutatedPs = <span class="keyword">new</span> PackageSetting(foundPs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如不是第一次启动或者升级，则直接从Settings中读取ABI信息</span></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_FIRST_BOOT_OR_UPGRADE) == <span class="number">0</span>) &#123;</span><br><span class="line">        PackageSetting foundPs = mSettings.getPackageLPr(pkg.packageName);</span><br><span class="line">        <span class="keyword">if</span> (foundPs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            primaryCpuAbiFromSettings = foundPs.primaryCpuAbiString;</span><br><span class="line">            secondaryCpuAbiFromSettings = foundPs.secondaryCpuAbiString;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pkgSetting = mSettings.getPackageLPr(pkg.packageName);</span><br><span class="line">    <span class="comment">//　pkg新扫描生成的uid和原本保存的不一致</span></span><br><span class="line">    <span class="keyword">if</span> (pkgSetting != <span class="keyword">null</span> &amp;&amp; pkgSetting.sharedUser != suid) &#123;</span><br><span class="line">      　<span class="comment">//打印关键信息ｌｏｇ</span></span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                <span class="string">"Package "</span> + pkg.packageName + <span class="string">" shared user changed from "</span></span><br><span class="line">                        + (pkgSetting.sharedUser != <span class="keyword">null</span></span><br><span class="line">                                ? pkgSetting.sharedUser.name : <span class="string">"&lt;nothing&gt;"</span>)</span><br><span class="line">                        + <span class="string">" to "</span></span><br><span class="line">                        + (suid != <span class="keyword">null</span> ? suid.name : <span class="string">"&lt;nothing&gt;"</span>)</span><br><span class="line">                        + <span class="string">"; replacing with new"</span>);</span><br><span class="line">        pkgSetting = <span class="keyword">null</span>;<span class="comment">//需要更新PackageSetting信息</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//更新PackageSetting信息｛｛</span></span><br><span class="line">    <span class="keyword">final</span> PackageSetting oldPkgSetting =</span><br><span class="line">            pkgSetting == <span class="keyword">null</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> PackageSetting(pkgSetting);</span><br><span class="line">    <span class="keyword">final</span> PackageSetting disabledPkgSetting =</span><br><span class="line">            mSettings.getDisabledSystemPkgLPr(pkg.packageName);</span><br><span class="line"></span><br><span class="line">    String[] usesStaticLibraries = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (pkg.usesStaticLibraries != <span class="keyword">null</span>) &#123;</span><br><span class="line">        usesStaticLibraries = <span class="keyword">new</span> String[pkg.usesStaticLibraries.size()];</span><br><span class="line">        pkg.usesStaticLibraries.toArray(usesStaticLibraries);</span><br><span class="line">    &#125;</span><br><span class="line">　　　　　　 <span class="comment">//package的信息不存在（第一次扫描到该应用）或者uid发生改变</span></span><br><span class="line">    <span class="keyword">if</span> (pkgSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> String parentPackageName = (pkg.parentPackage != <span class="keyword">null</span>)</span><br><span class="line">                ? pkg.parentPackage.packageName : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> instantApp = (scanFlags &amp; SCAN_AS_INSTANT_APP) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> virtualPreload = (scanFlags &amp; SCAN_AS_VIRTUAL_PRELOAD) != <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// REMOVE SharedUserSetting from method; update in a separate call</span></span><br><span class="line">        pkgSetting = Settings.createNewSetting(pkg.packageName, origPackage,</span><br><span class="line">                disabledPkgSetting, realName, suid, destCodeFile, destResourceFile,</span><br><span class="line">                pkg.applicationInfo.nativeLibraryRootDir, pkg.applicationInfo.primaryCpuAbi,</span><br><span class="line">                pkg.applicationInfo.secondaryCpuAbi, pkg.mVersionCode,</span><br><span class="line">                pkg.applicationInfo.flags, pkg.applicationInfo.privateFlags, user,</span><br><span class="line">                <span class="keyword">true</span> <span class="comment">/*allowInstall*/</span>, instantApp, virtualPreload,</span><br><span class="line">                parentPackageName, pkg.getChildPackageNames(),</span><br><span class="line">                UserManagerService.getInstance(), usesStaticLibraries,</span><br><span class="line">                pkg.usesStaticLibrariesVersions);</span><br><span class="line">        <span class="comment">// SIDE EFFECTS; updates system state; move elsewhere</span></span><br><span class="line">        <span class="keyword">if</span> (origPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSettings.addRenamedPackageLPw(pkg.packageName, origPackage.name);</span><br><span class="line">        &#125;</span><br><span class="line">        mSettings.addUserToSettingLPw(pkgSetting);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// REMOVE SharedUserSetting from method; update in a separate call.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// TODO(narayan): This update is bogus. nativeLibraryDir &amp; primaryCpuAbi,</span></span><br><span class="line">        <span class="comment">// secondaryCpuAbi are not known at this point so we always update them</span></span><br><span class="line">        <span class="comment">// to null here, only to reset them at a later point.</span></span><br><span class="line">        Settings.updatePackageSetting(pkgSetting, disabledPkgSetting, suid, destCodeFile,</span><br><span class="line">                pkg.applicationInfo.nativeLibraryDir, pkg.applicationInfo.primaryCpuAbi,</span><br><span class="line">                pkg.applicationInfo.secondaryCpuAbi, pkg.applicationInfo.flags,</span><br><span class="line">                pkg.applicationInfo.privateFlags, pkg.getChildPackageNames(),</span><br><span class="line">                UserManagerService.getInstance(), usesStaticLibraries,</span><br><span class="line">                pkg.usesStaticLibrariesVersions);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// SIDE EFFECTS; persists system state to files on disk; move elsewhere</span></span><br><span class="line">    <span class="comment">// 写入信息到/ｄａｔａ/system/users/下的文件</span></span><br><span class="line">    mSettings.writeUserRestrictionsLPw(pkgSetting, oldPkgSetting);</span><br><span class="line">    <span class="comment">//更新ＰａｃｋａｇｅＳｅｔｔｉｎｇ信息｝｝</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SIDE EFFECTS; modifies system state; move elsewhere</span></span><br><span class="line">    <span class="keyword">if</span> (pkgSetting.origPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">        pkg.setPackageName(origPackage.name);</span><br><span class="line">        <span class="comment">// File a report about this.</span></span><br><span class="line">        String msg = <span class="string">"New package "</span> + pkgSetting.realName</span><br><span class="line">                + <span class="string">" renamed to replace old package "</span> + pkgSetting.name;</span><br><span class="line">        reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">        <span class="comment">// Make a note of it.</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123;</span><br><span class="line">            mTransferedPackages.add(origPackage.name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// No longer need to retain this.</span></span><br><span class="line">        pkgSetting.origPackage = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SIDE EFFECTS; modifies system state; move elsewhere</span></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span> &amp;&amp; realName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Make a note of it.</span></span><br><span class="line">        mTransferedPackages.add(pkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(pkg.packageName)) &#123;</span><br><span class="line">        pkg.applicationInfo.flags |= ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_BOOTING) == <span class="number">0</span></span><br><span class="line">            &amp;&amp; (policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Check all shared libraries and map to their actual file path.</span></span><br><span class="line">        <span class="comment">// We only do this here for apps not on a system dir, because those</span></span><br><span class="line">        <span class="comment">// are the only ones that can fail an install due to this.  We</span></span><br><span class="line">        <span class="comment">// will take care of the system apps by updating all of their</span></span><br><span class="line">        <span class="comment">// library paths after the scan is done. Also during the initial</span></span><br><span class="line">        <span class="comment">// scan don't update any libs as we do this wholesale after all</span></span><br><span class="line">        <span class="comment">// apps are scanned to avoid dependency based scanning.</span></span><br><span class="line">        updateSharedLibrariesLPr(pkg, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mFoundPolicyFile) &#123;</span><br><span class="line">        SELinuxMMAC.assignSeInfoValue(pkg);</span><br><span class="line">    &#125;</span><br><span class="line">    pkg.applicationInfo.uid = pkgSetting.appId;</span><br><span class="line">    pkg.mExtras = pkgSetting;</span><br><span class="line"></span><br><span class="line">　　　　　　 <span class="comment">//获取签名信息（代码细节未了解）ＢＥＧＩＮ</span></span><br><span class="line">    <span class="comment">// Static shared libs have same package with different versions where</span></span><br><span class="line">    <span class="comment">// we internally use a synthetic package name to allow multiple versions</span></span><br><span class="line">    <span class="comment">// of the same package, therefore we need to compare signatures against</span></span><br><span class="line">    <span class="comment">// the package setting for the latest library version.</span></span><br><span class="line">    PackageSetting signatureCheckPs = pkgSetting;</span><br><span class="line">    <span class="keyword">if</span> (pkg.applicationInfo.isStaticSharedLibrary()) &#123;</span><br><span class="line">        SharedLibraryEntry libraryEntry = getLatestSharedLibraVersionLPr(pkg);</span><br><span class="line">        <span class="keyword">if</span> (libraryEntry != <span class="keyword">null</span>) &#123;</span><br><span class="line">            signatureCheckPs = mSettings.getPackageLPr(libraryEntry.apk);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldCheckUpgradeKeySetLP(signatureCheckPs, scanFlags)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (checkUpgradeKeySetLP(signatureCheckPs, pkg)) &#123;</span><br><span class="line">            <span class="comment">// We just determined the app is signed correctly, so bring</span></span><br><span class="line">            <span class="comment">// over the latest parsed certs.</span></span><br><span class="line">            pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</span><br><span class="line">                        <span class="string">"Package "</span> + pkg.packageName + <span class="string">" upgrade keys do not match the "</span></span><br><span class="line">                        + <span class="string">"previously installed version"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                String msg = <span class="string">"System package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" signature changed; retaining data."</span>;</span><br><span class="line">                reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// SIDE EFFECTS; compareSignaturesCompat() changes KeysetManagerService</span></span><br><span class="line">            verifySignaturesLP(signatureCheckPs, pkg);</span><br><span class="line">            <span class="comment">// We just determined the app is signed correctly, so bring</span></span><br><span class="line">            <span class="comment">// over the latest parsed certs.</span></span><br><span class="line">            pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// The signature has changed, but this package is in the system</span></span><br><span class="line">            <span class="comment">// image...  let's recover!</span></span><br><span class="line">            pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">            <span class="comment">// However...  if this package is part of a shared user, but it</span></span><br><span class="line">            <span class="comment">// doesn't match the signature of the shared user, let's fail.</span></span><br><span class="line">            <span class="comment">// What this means is that you can't change the signatures</span></span><br><span class="line">            <span class="comment">// associated with an overall shared user, which doesn't seem all</span></span><br><span class="line">            <span class="comment">// that unreasonable.</span></span><br><span class="line">            <span class="keyword">if</span> (signatureCheckPs.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (compareSignatures(signatureCheckPs.sharedUser.signatures.mSignatures,</span><br><span class="line">                        pkg.mSignatures) != PackageManager.SIGNATURE_MATCH) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(</span><br><span class="line">                            INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES,</span><br><span class="line">                            <span class="string">"Signature mismatch for shared user: "</span></span><br><span class="line">                                    + pkgSetting.sharedUser);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// File a report about this.</span></span><br><span class="line">            String msg = <span class="string">"System package "</span> + pkg.packageName</span><br><span class="line">                    + <span class="string">" signature changed; retaining data."</span>;</span><br><span class="line">            reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取签名信息END</span></span><br><span class="line">　　　　　　　<span class="comment">//更新权限的所有者，更新mSettings中的权限信息</span></span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span> &amp;&amp; pkg.mAdoptPermissions != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// This package wants to adopt ownership of permissions from</span></span><br><span class="line">        <span class="comment">// another package.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = pkg.mAdoptPermissions.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">final</span> String origName = pkg.mAdoptPermissions.get(i);</span><br><span class="line">            <span class="keyword">final</span> PackageSetting orig = mSettings.getPackageLPr(origName);</span><br><span class="line">            <span class="keyword">if</span> (orig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (verifyPackageUpdateLPr(orig, pkg)) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Adopting permissions from "</span> + origName + <span class="string">" to "</span></span><br><span class="line">                            + pkg.packageName);</span><br><span class="line">                    <span class="comment">// SIDE EFFECTS; updates permissions system state; move elsewhere</span></span><br><span class="line">                    mSettings.transferPermissionsLPw(origName, pkg.packageName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结一下加锁的代码里做了哪些事：更新uid、origin-package处理、ABI初始值、更新或者生成新的PackageSetting对象、处理签名信息、权限继承。</p>
<p>5) Package中ApplicationInfo对象属性设置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">pkg.applicationInfo.processName = fixProcessName(</span><br><span class="line">        pkg.applicationInfo.packageName,</span><br><span class="line">        pkg.applicationInfo.processName);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pkg != mPlatformPackage) &#123;</span><br><span class="line">    <span class="comment">// Get all of our default paths setup</span></span><br><span class="line">    pkg.applicationInfo.initForUser(UserHandle.USER_SYSTEM);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> String cpuAbiOverride = deriveAbiOverride(pkg.cpuAbiOverride, pkgSetting);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((scanFlags &amp; SCAN_NEW_INSTALL) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_FIRST_BOOT_OR_UPGRADE) != <span class="number">0</span>) &#123;</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"derivePackageAbi"</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> extractNativeLibs = !pkg.isLibrary();</span><br><span class="line">        derivePackageAbi(pkg, scanFile, cpuAbiOverride, extractNativeLibs,</span><br><span class="line">                mAppLib32InstallDir);</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Some system apps still use directory structure for native libraries</span></span><br><span class="line">        <span class="comment">// in which case we might end up not detecting abi solely based on apk</span></span><br><span class="line">        <span class="comment">// structure. Try to detect abi based on directory structure.</span></span><br><span class="line">        <span class="keyword">if</span> (isSystemApp(pkg) &amp;&amp; !pkg.isUpdatedSystemApp() &amp;&amp;</span><br><span class="line">                pkg.applicationInfo.primaryCpuAbi == <span class="keyword">null</span>) &#123;</span><br><span class="line">            setBundledAppAbisAndRoots(pkg, pkgSetting);</span><br><span class="line">            setNativeLibraryPaths(pkg, mAppLib32InstallDir);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This is not a first boot or an upgrade, don't bother deriving the</span></span><br><span class="line">        <span class="comment">// ABI during the scan. Instead, trust the value that was stored in the</span></span><br><span class="line">        <span class="comment">// package setting.</span></span><br><span class="line">        pkg.applicationInfo.primaryCpuAbi = primaryCpuAbiFromSettings;</span><br><span class="line">        pkg.applicationInfo.secondaryCpuAbi = secondaryCpuAbiFromSettings;</span><br><span class="line"></span><br><span class="line">        setNativeLibraryPaths(pkg, mAppLib32InstallDir);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ABI_SELECTION) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Using ABIS and native lib paths from settings : "</span> +</span><br><span class="line">                pkg.packageName + <span class="string">" "</span> + pkg.applicationInfo.primaryCpuAbi + <span class="string">", "</span> +</span><br><span class="line">                pkg.applicationInfo.secondaryCpuAbi);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((scanFlags &amp; SCAN_MOVE) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// We haven't run dex-opt for this move (since we've moved the compiled output too)</span></span><br><span class="line">        <span class="comment">// but we already have this packages package info in the PackageSetting. We just</span></span><br><span class="line">        <span class="comment">// use that and derive the native library path based on the new codepath.</span></span><br><span class="line">        pkg.applicationInfo.primaryCpuAbi = pkgSetting.primaryCpuAbiString;</span><br><span class="line">        pkg.applicationInfo.secondaryCpuAbi = pkgSetting.secondaryCpuAbiString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set native library paths again. For moves, the path will be updated based on the</span></span><br><span class="line">    <span class="comment">// ABIs we've determined above. For non-moves, the path will be updated based on the</span></span><br><span class="line">    <span class="comment">// ABIs we determined during compilation, but the path will depend on the final</span></span><br><span class="line">    <span class="comment">// package path (after the rename away from the stage path).</span></span><br><span class="line">    setNativeLibraryPaths(pkg, mAppLib32InstallDir);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is a special case for the "system" package, where the ABI is</span></span><br><span class="line"><span class="comment">// dictated by the zygote configuration (and init.rc). We should keep track</span></span><br><span class="line"><span class="comment">// of this ABI so that we can deal with "normal" applications that run under</span></span><br><span class="line"><span class="comment">// the same UID correctly.</span></span><br><span class="line"><span class="keyword">if</span> (mPlatformPackage == pkg) &#123;</span><br><span class="line">    pkg.applicationInfo.primaryCpuAbi = VMRuntime.getRuntime().is64Bit() ?</span><br><span class="line">            Build.SUPPORTED_64_BIT_ABIS[<span class="number">0</span>] : Build.SUPPORTED_32_BIT_ABIS[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If there's a mismatch between the abi-override in the package setting</span></span><br><span class="line"><span class="comment">// and the abiOverride specified for the install. Warn about this because we</span></span><br><span class="line"><span class="comment">// would've already compiled the app without taking the package setting into</span></span><br><span class="line"><span class="comment">// account.</span></span><br><span class="line"><span class="keyword">if</span> ((scanFlags &amp; SCAN_NO_DEX) == <span class="number">0</span> &amp;&amp; (scanFlags &amp; SCAN_NEW_INSTALL) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cpuAbiOverride == <span class="keyword">null</span> &amp;&amp; pkgSetting.cpuAbiOverrideString != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Ignoring persisted ABI override "</span> + cpuAbiOverride +</span><br><span class="line">                <span class="string">" for package "</span> + pkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pkgSetting.primaryCpuAbiString = pkg.applicationInfo.primaryCpuAbi;</span><br><span class="line">pkgSetting.secondaryCpuAbiString = pkg.applicationInfo.secondaryCpuAbi;</span><br><span class="line">pkgSetting.cpuAbiOverrideString = cpuAbiOverride;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Copy the derived override back to the parsed package, so that we can</span></span><br><span class="line"><span class="comment">// update the package settings accordingly.</span></span><br><span class="line">pkg.cpuAbiOverride = cpuAbiOverride;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (DEBUG_ABI_SELECTION) &#123;</span><br><span class="line">    Slog.d(TAG, <span class="string">"Resolved nativeLibraryRoot for "</span> + pkg.applicationInfo.packageName</span><br><span class="line">            + <span class="string">" to root="</span> + pkg.applicationInfo.nativeLibraryRootDir + <span class="string">", isa="</span></span><br><span class="line">            + pkg.applicationInfo.nativeLibraryRootRequiresIsa);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Push the derived path down into PackageSettings so we know what to</span></span><br><span class="line"><span class="comment">// clean up at uninstall time.</span></span><br><span class="line">pkgSetting.legacyNativeLibraryPathString = pkg.applicationInfo.nativeLibraryRootDir;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (DEBUG_ABI_SELECTION) &#123;</span><br><span class="line">    Log.d(TAG, <span class="string">"Abis for package["</span> + pkg.packageName + <span class="string">"] are"</span> +</span><br><span class="line">            <span class="string">" primary="</span> + pkg.applicationInfo.primaryCpuAbi +</span><br><span class="line">            <span class="string">" secondary="</span> + pkg.applicationInfo.secondaryCpuAbi);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SIDE EFFECTS; removes DEX files from disk; move elsewhere</span></span><br><span class="line"><span class="keyword">if</span> ((scanFlags &amp; SCAN_BOOTING) == <span class="number">0</span> &amp;&amp; pkgSetting.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// We don't do this here during boot because we can do it all</span></span><br><span class="line">    <span class="comment">// at once after scanning all existing packages.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// We also do this *before* we perform dexopt on this package, so that</span></span><br><span class="line">    <span class="comment">// we can avoid redundant dexopts, and also to make sure we've got the</span></span><br><span class="line">    <span class="comment">// code and package path correct.</span></span><br><span class="line">    adjustCpuAbisForSharedUserLPw(pkgSetting.sharedUser.packages, pkg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mFactoryTest &amp;&amp; pkg.requestedPermissions.contains(</span><br><span class="line">        android.Manifest.permission.FACTORY_TEST)) &#123;</span><br><span class="line">    pkg.applicationInfo.flags |= ApplicationInfo.FLAG_FACTORY_TEST;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isSystemApp(pkg)) &#123;</span><br><span class="line">    pkgSetting.isOrphaned = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先是设置ApplicationInfo中的进程名，然后调用ApplicationInfo#initForUser初始化System用户(0)下的应用相关路径：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initForUser</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    uid = UserHandle.getUid(userId, UserHandle.getAppId(uid));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"android"</span>.equals(packageName)) &#123;<span class="comment">//路径：/data/system/</span></span><br><span class="line">        dataDir = Environment.getDataSystemDirectory().getAbsolutePath();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    deviceProtectedDataDir = Environment</span><br><span class="line">            .getDataUserDePackageDirectory(volumeUuid, userId, packageName)</span><br><span class="line">            .getAbsolutePath();<span class="comment">// 路径：/data/user_de/0(或其他用户id，比如1000)/packageName</span></span><br><span class="line">    credentialProtectedDataDir = Environment</span><br><span class="line">            .getDataUserCePackageDirectory(volumeUuid, userId, packageName)</span><br><span class="line">            .getAbsolutePath();<span class="comment">//路径：/data/user/0(或其他用户id，比如1000)/packageName</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((privateFlags &amp; PRIVATE_FLAG_DEFAULT_TO_DEVICE_PROTECTED_STORAGE) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; PackageManager.APPLY_DEFAULT_TO_DEVICE_PROTECTED_STORAGE) &#123;</span><br><span class="line">        dataDir = deviceProtectedDataDir;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dataDir = credentialProtectedDataDir;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后主要就是确定cpuAbi的过程，该过程在<strong>ABI确定过程</strong>中有详细介绍，这里就不再多说了。</p>
<p>6) 设置时间戳</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Take care of first install / last update times.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">long</span> scanFileTime = getLastModifiedTime(pkg, scanFile);</span><br><span class="line"><span class="keyword">if</span> (currentTime != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pkgSetting.firstInstallTime == <span class="number">0</span>) &#123;</span><br><span class="line">        pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = currentTime;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags &amp; SCAN_UPDATE_TIME) != <span class="number">0</span>) &#123;</span><br><span class="line">        pkgSetting.lastUpdateTime = currentTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pkgSetting.firstInstallTime == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// We need *something*.  Take time time stamp of the file.</span></span><br><span class="line">    pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = scanFileTime;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (scanFileTime != pkgSetting.timeStamp) &#123;</span><br><span class="line">        <span class="comment">// A package on the system image has changed; consider this</span></span><br><span class="line">        <span class="comment">// to be an update.</span></span><br><span class="line">        pkgSetting.lastUpdateTime = scanFileTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">pkgSetting.setTimeStamp(scanFileTime);</span><br></pre></td></tr></table></figure>
<p>设置第一次安装时间/上次更新时间，以及时间戳。</p>
<p>7) 提交Package信息到Settings中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nonMutatedPs != <span class="keyword">null</span>) &#123;<span class="comment">//仅用于检测扫描是否能成功</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            mSettings.mPackages.put(nonMutatedPs.name, nonMutatedPs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = user == <span class="keyword">null</span> ? <span class="number">0</span> : user.getIdentifier();</span><br><span class="line">    <span class="comment">// Modify state for the given package setting</span></span><br><span class="line">    commitPackageSettings(pkg, pkgSetting, user, scanFlags,</span><br><span class="line">            (policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span> <span class="comment">/*chatty*/</span>);</span><br><span class="line">    <span class="keyword">if</span> (pkgSetting.getInstantApp(userId)) &#123;<span class="comment">//Instant app以后专门了解下</span></span><br><span class="line">        mInstantAppRegistry.addInstantAppLPw(userId, pkgSetting.appId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前面提过scanFlags只有在存在child package的情况下<code>&amp; SCAN_CHECK_ONLY</code>才不为0，这种情况上面跳过了，这里继续跳过……</p>
<p>前面说了那么多内容，其实都是在往PackageSetting里面填东西，最终还是要解析得到的信息吧保存到mSettings和mPackages里，该过程是在<code>commitPackageSettings</code>中进行的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Adds a scanned package to the system. When this method is finished, the package will</span></span><br><span class="line"><span class="comment">  * be available for query, resolution, etc...</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">commitPackageSettings</span><span class="params">(PackageParser.Package pkg, PackageSetting pkgSetting,</span></span></span><br><span class="line"><span class="function"><span class="params">         UserHandle user, <span class="keyword">int</span> scanFlags, <span class="keyword">boolean</span> chatty)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">     <span class="keyword">final</span> String pkgName = pkg.packageName;</span><br><span class="line">     <span class="comment">//自定义的ResolverActivity，可以在xml资源中配置</span></span><br><span class="line">     <span class="keyword">if</span> (mCustomResolverComponentName != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">             mCustomResolverComponentName.getPackageName().equals(pkg.packageName)) &#123;</span><br><span class="line">         setUpCustomResolverActivity(pkg);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (pkg.packageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">         <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">             <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123;</span><br><span class="line">                 <span class="comment">// Set up information for our fall-back user intent resolution activity.</span></span><br><span class="line">                 mPlatformPackage = pkg;</span><br><span class="line">                 pkg.mVersionCode = mSdkVersion;</span><br><span class="line">                 mAndroidApplication = pkg.applicationInfo;</span><br><span class="line">                 <span class="keyword">if</span> (!mResolverReplaced) &#123;</span><br><span class="line">                     mResolveActivity.applicationInfo = mAndroidApplication;</span><br><span class="line">                     <span class="comment">//系统默认的ResolverActivity，用于在存在多个匹配Activity的情况下</span></span><br><span class="line">                     <span class="comment">//显示，让用户选择</span></span><br><span class="line">                     mResolveActivity.name = ResolverActivity.class.getName();</span><br><span class="line">                     <span class="comment">//从这里看出来包名为android的不一定就是framework-res.apk</span></span><br><span class="line">                     mResolveActivity.packageName = mAndroidApplication.packageName;</span><br><span class="line">                     mResolveActivity.processName = <span class="string">"system:ui"</span>;</span><br><span class="line">                     mResolveActivity.launchMode = ActivityInfo.LAUNCH_MULTIPLE;</span><br><span class="line">                     mResolveActivity.documentLaunchMode = ActivityInfo.DOCUMENT_LAUNCH_NEVER;</span><br><span class="line">                     mResolveActivity.flags = ActivityInfo.FLAG_EXCLUDE_FROM_RECENTS;</span><br><span class="line">                     mResolveActivity.theme = R.style.Theme_Material_Dialog_Alert;</span><br><span class="line">                     mResolveActivity.exported = <span class="keyword">true</span>;</span><br><span class="line">                     mResolveActivity.enabled = <span class="keyword">true</span>;</span><br><span class="line">                     mResolveActivity.resizeMode = ActivityInfo.RESIZE_MODE_RESIZEABLE;</span><br><span class="line">                     mResolveActivity.configChanges = ActivityInfo.CONFIG_SCREEN_SIZE</span><br><span class="line">                             | ActivityInfo.CONFIG_SMALLEST_SCREEN_SIZE</span><br><span class="line">                             | ActivityInfo.CONFIG_SCREEN_LAYOUT</span><br><span class="line">                             | ActivityInfo.CONFIG_ORIENTATION</span><br><span class="line">                             | ActivityInfo.CONFIG_KEYBOARD</span><br><span class="line">                             | ActivityInfo.CONFIG_KEYBOARD_HIDDEN;</span><br><span class="line">                     mResolveInfo.activityInfo = mResolveActivity;</span><br><span class="line">                     mResolveInfo.priority = <span class="number">0</span>;</span><br><span class="line">                     mResolveInfo.preferredOrder = <span class="number">0</span>;</span><br><span class="line">                     mResolveInfo.match = <span class="number">0</span>;</span><br><span class="line">                     mResolveComponentName = <span class="keyword">new</span> ComponentName(</span><br><span class="line">                             mAndroidApplication.packageName, mResolveActivity.name);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     ArrayList&lt;PackageParser.Package&gt; clientLibPkgs = <span class="keyword">null</span>;</span><br><span class="line">     <span class="comment">// writer</span></span><br><span class="line">     <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">         <span class="keyword">boolean</span> hasStaticSharedLibs = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Any app can add new static shared libraries</span></span><br><span class="line">         <span class="keyword">if</span> (pkg.staticSharedLibName != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="comment">// Static shared libs don't allow renaming as they have synthetic package</span></span><br><span class="line">             <span class="comment">// names to allow install of multiple versions, so use name from manifest.</span></span><br><span class="line">             <span class="keyword">if</span> (addSharedLibraryLPw(<span class="keyword">null</span>, pkg.packageName, pkg.staticSharedLibName,</span><br><span class="line">                     pkg.staticSharedLibVersion, SharedLibraryInfo.TYPE_STATIC,</span><br><span class="line">                     pkg.manifestPackageName, pkg.mVersionCode)) &#123;</span><br><span class="line">                 hasStaticSharedLibs = <span class="keyword">true</span>;</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" library "</span></span><br><span class="line">                             + pkg.staticSharedLibName + <span class="string">" already exists; skipping"</span>);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">// Static shared libs cannot be updated once installed since they</span></span><br><span class="line">             <span class="comment">// use synthetic package name which includes the version code, so</span></span><br><span class="line">             <span class="comment">// not need to update other packages's shared lib dependencies.</span></span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (!hasStaticSharedLibs</span><br><span class="line">                 &amp;&amp; (pkg.applicationInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="comment">// Only system apps can add new dynamic shared libraries.</span></span><br><span class="line">             <span class="keyword">if</span> (pkg.libraryNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pkg.libraryNames.size(); i++) &#123;</span><br><span class="line">                     String name = pkg.libraryNames.get(i);</span><br><span class="line">                     <span class="keyword">boolean</span> allowed = <span class="keyword">false</span>;</span><br><span class="line">                     <span class="keyword">if</span> (pkg.isUpdatedSystemApp()) &#123;</span><br><span class="line">                         <span class="comment">// New library entries can only be added through the</span></span><br><span class="line">                         <span class="comment">// system image.  This is important to get rid of a lot</span></span><br><span class="line">                         <span class="comment">// of nasty edge cases: for example if we allowed a non-</span></span><br><span class="line">                         <span class="comment">// system update of the app to add a library, then uninstalling</span></span><br><span class="line">                         <span class="comment">// the update would make the library go away, and assumptions</span></span><br><span class="line">                         <span class="comment">// we made such as through app install filtering would now</span></span><br><span class="line">                         <span class="comment">// have allowed apps on the device which aren't compatible</span></span><br><span class="line">                         <span class="comment">// with it.  Better to just have the restriction here, be</span></span><br><span class="line">                         <span class="comment">// conservative, and create many fewer cases that can negatively</span></span><br><span class="line">                         <span class="comment">// impact the user experience.</span></span><br><span class="line">                         <span class="keyword">final</span> PackageSetting sysPs = mSettings</span><br><span class="line">                                 .getDisabledSystemPkgLPr(pkg.packageName);</span><br><span class="line">                         <span class="keyword">if</span> (sysPs.pkg != <span class="keyword">null</span> &amp;&amp; sysPs.pkg.libraryNames != <span class="keyword">null</span>) &#123;</span><br><span class="line">                             <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; sysPs.pkg.libraryNames.size(); j++) &#123;</span><br><span class="line">                                 <span class="keyword">if</span> (name.equals(sysPs.pkg.libraryNames.get(j))) &#123;</span><br><span class="line">                                     allowed = <span class="keyword">true</span>;</span><br><span class="line">                                     <span class="keyword">break</span>;</span><br><span class="line">                                 &#125;</span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         allowed = <span class="keyword">true</span>;</span><br><span class="line">                     &#125;</span><br><span class="line">                     <span class="keyword">if</span> (allowed) &#123;</span><br><span class="line">                         <span class="keyword">if</span> (!addSharedLibraryLPw(<span class="keyword">null</span>, pkg.packageName, name,</span><br><span class="line">                                 SharedLibraryInfo.VERSION_UNDEFINED,</span><br><span class="line">                                 SharedLibraryInfo.TYPE_DYNAMIC,</span><br><span class="line">                                 pkg.packageName, pkg.mVersionCode)) &#123;</span><br><span class="line">                             Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" library "</span></span><br><span class="line">                                     + name + <span class="string">" already exists; skipping"</span>);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         Slog.w(TAG, <span class="string">"Package "</span> + pkg.packageName + <span class="string">" declares lib "</span></span><br><span class="line">                                 + name + <span class="string">" that is not declared on system image; skipping"</span>);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 <span class="keyword">if</span> ((scanFlags &amp; SCAN_BOOTING) == <span class="number">0</span>) &#123;</span><br><span class="line">                     <span class="comment">// If we are not booting, we need to update any applications</span></span><br><span class="line">                     <span class="comment">// that are clients of our shared library.  If we are booting,</span></span><br><span class="line">                     <span class="comment">// this will all be done once the scan is complete.</span></span><br><span class="line">                     clientLibPkgs = updateAllSharedLibrariesLPw(pkg);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> ((scanFlags &amp; SCAN_BOOTING) != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// No apps can run during boot scan, so they don't need to be frozen</span></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags &amp; SCAN_DONT_KILL_APP) != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// Caller asked to not kill app, so it's probably not frozen</span></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags &amp; SCAN_IGNORE_FROZEN) != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// Caller asked us to ignore frozen check for some reason; they</span></span><br><span class="line">         <span class="comment">// probably didn't know the package name</span></span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// We're doing major surgery on this package, so it better be frozen</span></span><br><span class="line">         <span class="comment">// right now to keep it from launching</span></span><br><span class="line">         checkPackageFrozen(pkgName);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Also need to kill any apps that are dependent on the library.</span></span><br><span class="line">     <span class="keyword">if</span> (clientLibPkgs != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;clientLibPkgs.size(); i++) &#123;</span><br><span class="line">             PackageParser.Package clientPkg = clientLibPkgs.get(i);</span><br><span class="line">             killApplication(clientPkg.applicationInfo.packageName,</span><br><span class="line">                     clientPkg.applicationInfo.uid, <span class="string">"update lib"</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// writer</span></span><br><span class="line">     Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"updateSettings"</span>);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">         <span class="comment">// We don't expect installation to fail beyond this point</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">// Add the new setting to mSettings</span></span><br><span class="line">         mSettings.insertPackageSettingLPw(pkgSetting, pkg);</span><br><span class="line">         <span class="comment">// Add the new setting to mPackages</span></span><br><span class="line">         mPackages.put(pkg.applicationInfo.packageName, pkg);</span><br><span class="line">         <span class="comment">// Make sure we don't accidentally delete its data.</span></span><br><span class="line">         <span class="keyword">final</span> Iterator&lt;PackageCleanItem&gt; iter = mSettings.mPackagesToBeCleaned.iterator();</span><br><span class="line">         <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">             PackageCleanItem item = iter.next();</span><br><span class="line">             <span class="keyword">if</span> (pkgName.equals(item.packageName)) &#123;</span><br><span class="line">                 iter.remove();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Add the package's KeySets to the global KeySetManagerService</span></span><br><span class="line">         KeySetManagerService ksms = mSettings.mKeySetManagerService;</span><br><span class="line">         ksms.addScannedPackageLPw(pkg);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">         StringBuilder r = <span class="keyword">null</span>;</span><br><span class="line">         <span class="keyword">int</span> i;</span><br><span class="line">         <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">             PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">             p.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                     p.info.processName);</span><br><span class="line">             mProviders.addProvider(p);</span><br><span class="line">             p.syncable = p.info.isSyncable;</span><br><span class="line">             <span class="keyword">if</span> (p.info.authority != <span class="keyword">null</span>) &#123;</span><br><span class="line">                 String names[] = p.info.authority.split(<span class="string">";"</span>);</span><br><span class="line">                 p.info.authority = <span class="keyword">null</span>;</span><br><span class="line">                 <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; names.length; j++) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (j == <span class="number">1</span> &amp;&amp; p.syncable) &#123;</span><br><span class="line">                         <span class="comment">// We only want the first authority for a provider to possibly be</span></span><br><span class="line">                         <span class="comment">// syncable, so if we already added this provider using a different</span></span><br><span class="line">                         <span class="comment">// authority clear the syncable flag. We copy the provider before</span></span><br><span class="line">                         <span class="comment">// changing it because the mProviders object contains a reference</span></span><br><span class="line">                         <span class="comment">// to a provider that we don't want to change.</span></span><br><span class="line">                         <span class="comment">// Only do this for the second authority since the resulting provider</span></span><br><span class="line">                         <span class="comment">// object can be the same for all future authorities for this provider.</span></span><br><span class="line">                         p = <span class="keyword">new</span> PackageParser.Provider(p);</span><br><span class="line">                         p.syncable = <span class="keyword">false</span>;</span><br><span class="line">                     &#125;</span><br><span class="line">                     <span class="keyword">if</span> (!mProvidersByAuthority.containsKey(names[j])) &#123;</span><br><span class="line">                         mProvidersByAuthority.put(names[j], p);</span><br><span class="line">                         <span class="keyword">if</span> (p.info.authority == <span class="keyword">null</span>) &#123;</span><br><span class="line">                             p.info.authority = names[j];</span><br><span class="line">                         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                             p.info.authority = p.info.authority + <span class="string">";"</span> + names[j];</span><br><span class="line">                         &#125;</span><br><span class="line">                         <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                             <span class="keyword">if</span> (chatty)</span><br><span class="line">                                 Log.d(TAG, <span class="string">"Registered content provider: "</span> + names[j]</span><br><span class="line">                                         + <span class="string">", className = "</span> + p.info.name + <span class="string">", isSyncable = "</span></span><br><span class="line">                                         + p.info.isSyncable);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         PackageParser.Provider other = mProvidersByAuthority.get(names[j]);</span><br><span class="line">                         Slog.w(TAG, <span class="string">"Skipping provider name "</span> + names[j] +</span><br><span class="line">                                 <span class="string">" (in package "</span> + pkg.applicationInfo.packageName +</span><br><span class="line">                                 <span class="string">"): name already used by "</span></span><br><span class="line">                                 + ((other != <span class="keyword">null</span> &amp;&amp; other.getComponentName() != <span class="keyword">null</span>)</span><br><span class="line">                                         ? other.getComponentName().getPackageName() : <span class="string">"?"</span>));</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">if</span> (chatty) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                     r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     r.append(<span class="string">' '</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">                 r.append(p.info.name);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Providers: "</span> + r);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         N = pkg.services.size();</span><br><span class="line">         r = <span class="keyword">null</span>;</span><br><span class="line">         <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">             PackageParser.Service s = pkg.services.get(i);</span><br><span class="line">             s.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                     s.info.processName);</span><br><span class="line">             mServices.addService(s);</span><br><span class="line">             <span class="keyword">if</span> (chatty) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                     r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     r.append(<span class="string">' '</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">                 r.append(s.info.name);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Services: "</span> + r);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         N = pkg.receivers.size();</span><br><span class="line">         r = <span class="keyword">null</span>;</span><br><span class="line">         <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">             PackageParser.Activity a = pkg.receivers.get(i);</span><br><span class="line">             a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                     a.info.processName);</span><br><span class="line">             mReceivers.addActivity(a, <span class="string">"receiver"</span>);</span><br><span class="line">             <span class="keyword">if</span> (chatty) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                     r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     r.append(<span class="string">' '</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">                 r.append(a.info.name);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Receivers: "</span> + r);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         N = pkg.activities.size();</span><br><span class="line">         r = <span class="keyword">null</span>;</span><br><span class="line">         <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">             PackageParser.Activity a = pkg.activities.get(i);</span><br><span class="line">             a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                     a.info.processName);</span><br><span class="line">             mActivities.addActivity(a, <span class="string">"activity"</span>);</span><br><span class="line">             <span class="keyword">if</span> (chatty) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                     r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     r.append(<span class="string">' '</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">                 r.append(a.info.name);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Activities: "</span> + r);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         N = pkg.permissionGroups.size();</span><br><span class="line">         r = <span class="keyword">null</span>;</span><br><span class="line">         <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">             PackageParser.PermissionGroup pg = pkg.permissionGroups.get(i);</span><br><span class="line">             PackageParser.PermissionGroup cur = mPermissionGroups.get(pg.info.name);</span><br><span class="line">             <span class="keyword">final</span> String curPackageName = cur == <span class="keyword">null</span> ? <span class="keyword">null</span> : cur.info.packageName;</span><br><span class="line">             <span class="comment">// Dont allow ephemeral apps to define new permission groups.</span></span><br><span class="line">             <span class="keyword">if</span> ((scanFlags &amp; SCAN_AS_INSTANT_APP) != <span class="number">0</span>) &#123;</span><br><span class="line">                 Slog.w(TAG, <span class="string">"Permission group "</span> + pg.info.name + <span class="string">" from package "</span></span><br><span class="line">                         + pg.info.packageName</span><br><span class="line">                         + <span class="string">" ignored: instant apps cannot define new permission groups."</span>);</span><br><span class="line">                 <span class="keyword">continue</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">final</span> <span class="keyword">boolean</span> isPackageUpdate = pg.info.packageName.equals(curPackageName);</span><br><span class="line">             <span class="keyword">if</span> (cur == <span class="keyword">null</span> || isPackageUpdate) &#123;</span><br><span class="line">                 mPermissionGroups.put(pg.info.name, pg);</span><br><span class="line">                 <span class="keyword">if</span> (chatty) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                         r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         r.append(<span class="string">' '</span>);</span><br><span class="line">                     &#125;</span><br><span class="line">                     <span class="keyword">if</span> (isPackageUpdate) &#123;</span><br><span class="line">                         r.append(<span class="string">"UPD:"</span>);</span><br><span class="line">                     &#125;</span><br><span class="line">                     r.append(pg.info.name);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 Slog.w(TAG, <span class="string">"Permission group "</span> + pg.info.name + <span class="string">" from package "</span></span><br><span class="line">                         + pg.info.packageName + <span class="string">" ignored: original from "</span></span><br><span class="line">                         + cur.info.packageName);</span><br><span class="line">                 <span class="keyword">if</span> (chatty) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                         r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         r.append(<span class="string">' '</span>);</span><br><span class="line">                     &#125;</span><br><span class="line">                     r.append(<span class="string">"DUP:"</span>);</span><br><span class="line">                     r.append(pg.info.name);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Permission Groups: "</span> + r);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         N = pkg.permissions.size();</span><br><span class="line">         r = <span class="keyword">null</span>;</span><br><span class="line">         <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">             PackageParser.Permission p = pkg.permissions.get(i);</span><br><span class="line"></span><br><span class="line">             <span class="comment">// Dont allow ephemeral apps to define new permissions.</span></span><br><span class="line">             <span class="keyword">if</span> ((scanFlags &amp; SCAN_AS_INSTANT_APP) != <span class="number">0</span>) &#123;</span><br><span class="line">                 Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                         + p.info.packageName</span><br><span class="line">                         + <span class="string">" ignored: instant apps cannot define new permissions."</span>);</span><br><span class="line">                 <span class="keyword">continue</span>;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="comment">// Assume by default that we did not install this permission into the system.</span></span><br><span class="line">             p.info.flags &amp;= ~PermissionInfo.FLAG_INSTALLED;</span><br><span class="line"></span><br><span class="line">             <span class="comment">// Now that permission groups have a special meaning, we ignore permission</span></span><br><span class="line">             <span class="comment">// groups for legacy apps to prevent unexpected behavior. In particular,</span></span><br><span class="line">             <span class="comment">// permissions for one app being granted to someone just because they happen</span></span><br><span class="line">             <span class="comment">// to be in a group defined by another app (before this had no implications).</span></span><br><span class="line">             <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt; Build.VERSION_CODES.LOLLIPOP_MR1) &#123;</span><br><span class="line">                 p.group = mPermissionGroups.get(p.info.group);</span><br><span class="line">                 <span class="comment">// Warn for a permission in an unknown group.</span></span><br><span class="line">                 <span class="keyword">if</span> (DEBUG_PERMISSIONS &amp;&amp; p.info.group != <span class="keyword">null</span> &amp;&amp; p.group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                     Slog.i(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                             + p.info.packageName + <span class="string">" in an unknown group "</span> + p.info.group);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             ArrayMap&lt;String, BasePermission&gt; permissionMap =</span><br><span class="line">                     p.tree ? mSettings.mPermissionTrees</span><br><span class="line">                             : mSettings.mPermissions;</span><br><span class="line">             BasePermission bp = permissionMap.get(p.info.name);</span><br><span class="line"></span><br><span class="line">             <span class="comment">// Allow system apps to redefine non-system permissions</span></span><br><span class="line">             <span class="keyword">if</span> (bp != <span class="keyword">null</span> &amp;&amp; !Objects.equals(bp.sourcePackage, p.info.packageName)) &#123;</span><br><span class="line">                 <span class="keyword">final</span> <span class="keyword">boolean</span> currentOwnerIsSystem = (bp.perm != <span class="keyword">null</span></span><br><span class="line">                         &amp;&amp; isSystemApp(bp.perm.owner));</span><br><span class="line">                 <span class="keyword">if</span> (isSystemApp(p.owner)) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (bp.type == BasePermission.TYPE_BUILTIN &amp;&amp; bp.perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                         <span class="comment">// It's a built-in permission and no owner, take ownership now</span></span><br><span class="line">                         bp.packageSetting = pkgSetting;</span><br><span class="line">                         bp.perm = p;</span><br><span class="line">                         bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                         bp.sourcePackage = p.info.packageName;</span><br><span class="line">                         p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line">                     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!currentOwnerIsSystem) &#123;</span><br><span class="line">                         String msg = <span class="string">"New decl "</span> + p.owner + <span class="string">" of permission  "</span></span><br><span class="line">                                 + p.info.name + <span class="string">" is system; overriding "</span> + bp.sourcePackage;</span><br><span class="line">                         reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">                         bp = <span class="keyword">null</span>;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                 bp = <span class="keyword">new</span> BasePermission(p.info.name, p.info.packageName,</span><br><span class="line">                         BasePermission.TYPE_NORMAL);</span><br><span class="line">                 permissionMap.put(p.info.name, bp);</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="keyword">if</span> (bp.perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (bp.sourcePackage == <span class="keyword">null</span></span><br><span class="line">                         || bp.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                     BasePermission tree = findPermissionTreeLP(p.info.name);</span><br><span class="line">                     <span class="keyword">if</span> (tree == <span class="keyword">null</span></span><br><span class="line">                             || tree.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                         bp.packageSetting = pkgSetting;</span><br><span class="line">                         bp.perm = p;</span><br><span class="line">                         bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                         bp.sourcePackage = p.info.packageName;</span><br><span class="line">                         p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line">                         <span class="keyword">if</span> (chatty) &#123;</span><br><span class="line">                             <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                 r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                 r.append(<span class="string">' '</span>);</span><br><span class="line">                             &#125;</span><br><span class="line">                             r.append(p.info.name);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                                 + p.info.packageName + <span class="string">" ignored: base tree "</span></span><br><span class="line">                                 + tree.name + <span class="string">" is from package "</span></span><br><span class="line">                                 + tree.sourcePackage);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                             + p.info.packageName + <span class="string">" ignored: original from "</span></span><br><span class="line">                             + bp.sourcePackage);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; <span class="keyword">else</span> <span class="keyword">if</span> (chatty) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                     r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     r.append(<span class="string">' '</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">                 r.append(<span class="string">"DUP:"</span>);</span><br><span class="line">                 r.append(p.info.name);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">if</span> (bp.perm == p) &#123;</span><br><span class="line">                 bp.protectionLevel = p.info.protectionLevel;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Permissions: "</span> + r);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         N = pkg.instrumentation.size();</span><br><span class="line">         r = <span class="keyword">null</span>;</span><br><span class="line">         <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">             PackageParser.Instrumentation a = pkg.instrumentation.get(i);</span><br><span class="line">             a.info.packageName = pkg.applicationInfo.packageName;</span><br><span class="line">             a.info.sourceDir = pkg.applicationInfo.sourceDir;</span><br><span class="line">             a.info.publicSourceDir = pkg.applicationInfo.publicSourceDir;</span><br><span class="line">             a.info.splitNames = pkg.splitNames;</span><br><span class="line">             a.info.splitSourceDirs = pkg.applicationInfo.splitSourceDirs;</span><br><span class="line">             a.info.splitPublicSourceDirs = pkg.applicationInfo.splitPublicSourceDirs;</span><br><span class="line">             a.info.splitDependencies = pkg.applicationInfo.splitDependencies;</span><br><span class="line">             a.info.dataDir = pkg.applicationInfo.dataDir;</span><br><span class="line">             a.info.deviceProtectedDataDir = pkg.applicationInfo.deviceProtectedDataDir;</span><br><span class="line">             a.info.credentialProtectedDataDir = pkg.applicationInfo.credentialProtectedDataDir;</span><br><span class="line">             a.info.nativeLibraryDir = pkg.applicationInfo.nativeLibraryDir;</span><br><span class="line">             a.info.secondaryNativeLibraryDir = pkg.applicationInfo.secondaryNativeLibraryDir;</span><br><span class="line">             mInstrumentation.put(a.getComponentName(), a);</span><br><span class="line">             <span class="keyword">if</span> (chatty) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                     r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     r.append(<span class="string">' '</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">                 r.append(a.info.name);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Instrumentation: "</span> + r);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (pkg.protectedBroadcasts != <span class="keyword">null</span>) &#123;</span><br><span class="line">             N = pkg.protectedBroadcasts.size();</span><br><span class="line">             <span class="keyword">synchronized</span> (mProtectedBroadcasts) &#123;</span><br><span class="line">                 <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                     mProtectedBroadcasts.add(pkg.protectedBroadcasts.get(i));</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>方法又很长，但是做的事大致就这么几件：</p>
<ul>
<li><p>设置PKMS中mPlatformPackage 、mAndroidApplication、mResolveActivity、mResolveInfo及mResolveComponentName等成员的值；</p>
</li>
<li><p>填充mSharedLibraries和mStaticLibsByDeclaringPackage这两个ArrayMap；</p>
</li>
<li><p>Add the new setting to mSettings：<code>mSettings.insertPackageSettingLPw(pkgSetting, pkg);</code></p>
</li>
<li><p>Add the new setting to mPackages：<code>mPackages.put(pkg.applicationInfo.packageName, pkg);</code></p>
</li>
<li><p>往下面四个解析器中添加解析后的组件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// All available activities, for your resolving pleasure.</span></span><br><span class="line"><span class="keyword">final</span> ActivityIntentResolver mActivities =</span><br><span class="line">        <span class="keyword">new</span> ActivityIntentResolver();</span><br><span class="line"></span><br><span class="line"><span class="comment">// All available receivers, for your resolving pleasure.</span></span><br><span class="line"><span class="keyword">final</span> ActivityIntentResolver mReceivers =</span><br><span class="line">        <span class="keyword">new</span> ActivityIntentResolver();</span><br><span class="line"></span><br><span class="line"><span class="comment">// All available services, for your resolving pleasure.</span></span><br><span class="line"><span class="keyword">final</span> ServiceIntentResolver mServices = <span class="keyword">new</span> ServiceIntentResolver();</span><br><span class="line"></span><br><span class="line"><span class="comment">// All available providers, for your resolving pleasure.</span></span><br><span class="line"><span class="keyword">final</span> ProviderIntentResolver mProviders = <span class="keyword">new</span> ProviderIntentResolver();</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>从名字上就可以看出来四大组件的解析肯定和这四个Resolver有关。组件解析过程之后再做了解。</p>
<ul>
<li><p>更新权限信息；</p>
</li>
<li><p>更新mInstrumentation，Instrumentation印象中是用来调试的，暂不了解；</p>
</li>
<li><p>填充mProtectedBroadcasts：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Broadcast actions that are only available to the system.</span></span><br><span class="line"><span class="meta">@GuardedBy</span>(<span class="string">"mProtectedBroadcasts"</span>)</span><br><span class="line"><span class="keyword">final</span> ArraySet&lt;String&gt; mProtectedBroadcasts = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>进过上面一系列的扫描过程一个apk就解析完了，不断重复该过程直到一个目录下的apk全部解析完成。六个目录下的apk解析过程类似，将所有的apk解析完之后mSetting和mPackage等信息也就构建完成了，之后就可以通过PKMS进行组件的查询和解析了。</p>
<ol start="3">
<li><p>生成data</p>
<p>首先是通过reconcileAppsDataLI生成coreApp的data（在/data/user/0下面），该方法返回跳过的非coreApp列表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; deferPackages = reconcileAppsDataLI(StorageManager.UUID_PRIVATE_INTERNAL,</span><br><span class="line">                    UserHandle.USER_SYSTEM, storageFlags, <span class="keyword">true</span> <span class="comment">/* migrateAppData */</span>,</span><br><span class="line">                    <span class="keyword">true</span> <span class="comment">/* onlyCoreApps */</span>);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>而<code>reconcileAppsDataLI</code>内部又调用了<code>prepareAppDataAndMigrateLIF</code>来准备应用的数据。</p>
<p>之后再通过<code>prepareAppDataAndMigrateLIF</code>方法逐个生成deferPackages中package的数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">mPrepareAppDataFuture = SystemServerInitThreadPool.get().submit(() -&gt; &#123;</span><br><span class="line">                TimingsTraceLog traceLog = <span class="keyword">new</span> TimingsTraceLog(<span class="string">"SystemServerTimingAsync"</span>,</span><br><span class="line">                        Trace.TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">                traceLog.traceBegin(<span class="string">"AppDataFixup"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mInstaller.fixupAppData(StorageManager.UUID_PRIVATE_INTERNAL,</span><br><span class="line">                            StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InstallerException e) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Trouble fixing GIDs"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                traceLog.traceEnd();</span><br><span class="line"></span><br><span class="line">                traceLog.traceBegin(<span class="string">"AppDataPrepare"</span>);</span><br><span class="line">                <span class="keyword">if</span> (deferPackages == <span class="keyword">null</span> || deferPackages.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (String pkgName : deferPackages) &#123;</span><br><span class="line">                    PackageParser.Package pkg = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                        PackageSetting ps = mSettings.getPackageLPr(pkgName);</span><br><span class="line">                        <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; ps.getInstalled(UserHandle.USER_SYSTEM)) &#123;</span><br><span class="line">                            pkg = ps.pkg;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                            prepareAppDataAndMigrateLIF(pkg, UserHandle.USER_SYSTEM, storageFlags,</span><br><span class="line">                                    <span class="keyword">true</span> <span class="comment">/* maybeMigrateAppData */</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        count++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                traceLog.traceEnd();</span><br><span class="line">                Slog.i(TAG, <span class="string">"Deferred reconcileAppsData finished "</span> + count + <span class="string">" packages"</span>);</span><br><span class="line">            &#125;, <span class="string">"prepareAppData"</span>);</span><br></pre></td></tr></table></figure>
<p>以上代码将一个Runnable和对该Runnable对象的描述作为参数传递给了SystemServerInitThreadPool，然后在线程池中执行Runnable，通过prepareAppDataAndMigrateLIF方法准备data,并最终返回一个Future对象。</p>
<p>也就是说，coreApp和非coreApp最终都是通过<code>prepareAppDataAndMigrateLIF</code>来为app准备数据的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareAppDataAndMigrateLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">int</span> userId, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> maybeMigrateAppData)</span> </span>&#123;</span><br><span class="line">    prepareAppDataLIF(pkg, userId, flags);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (maybeMigrateAppData &amp;&amp; maybeMigrateAppDataLIF(pkg, userId)) &#123;</span><br><span class="line">        <span class="comment">// We may have just shuffled around app data directories, so</span></span><br><span class="line">        <span class="comment">// prepare them one more time</span></span><br><span class="line">        prepareAppDataLIF(pkg, userId, flags);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的方法会通过Installer对象的<code>createAppData</code>方法来进行数据的准备工作，之后会到native层（frameworks/native/cmds/installd/InstalldNativeService.cpp），该过程就不了解了。</p>
<p>再回过头来看一下上面提到的<code>SystemServerInitThreadPool</code>，源码中的注释如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Thread pool used during initialization of system server.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;System services can &#123;<span class="doctag">@link</span> #submit(Runnable)&#125; tasks for execution during boot.</span></span><br><span class="line"><span class="comment"> * The pool will be shut down after &#123;<span class="doctag">@link</span> SystemService#PHASE_BOOT_COMPLETED&#125;.</span></span><br><span class="line"><span class="comment"> * New tasks &lt;em&gt;should not&lt;/em&gt; be submitted afterwards.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>该类是在System server创建过程中用到的线程池，在启动过程中系统服务可以通过submit方法向线程池中提交任务，SystemService#PHASE_BOOT_COMPLETED之后线程池会关闭。来看下该类的关键代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> SystemServerInitThreadPool sInstance;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ExecutorService mService = ConcurrentUtils.newFixedThreadPool(<span class="number">4</span>,</span><br><span class="line">        <span class="string">"system-server-init-thread"</span>, Process.THREAD_PRIORITY_FOREGROUND);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> SystemServerInitThreadPool <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sInstance = <span class="keyword">new</span> SystemServerInitThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line">    Preconditions.checkState(sInstance.mService != <span class="keyword">null</span>, <span class="string">"Cannot get "</span> + TAG</span><br><span class="line">            + <span class="string">" - it has been shut down"</span>);</span><br><span class="line">    <span class="keyword">return</span> sInstance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Future&lt;?&gt; submit(Runnable runnable, String description) &#123;</span><br><span class="line">    <span class="keyword">if</span> (IS_DEBUGGABLE) &#123;</span><br><span class="line">        <span class="keyword">return</span> mService.submit(() -&gt; &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Started executing "</span> + description);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                runnable.run();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                Slog.e(TAG, <span class="string">"Failure in "</span> + description + <span class="string">": "</span> + e, e);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Finished executing "</span>  + description);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mService.submit(runnable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该类采用了单例单例模式，内部维护了一个FixedThreadPool引用mServices,提交的任务实际上是提交给mServices。<code>mPrepareAppDataFuture = SystemServerInitThreadPool.get().submit</code>返回的对象仅在一处用到了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PKMS</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">waitForAppDataPrepared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPrepareAppDataFuture == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ConcurrentUtils.waitForFutureNoInterrupt(mPrepareAppDataFuture, <span class="string">"wait for prepareAppData"</span>);</span><br><span class="line">    mPrepareAppDataFuture = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而该方法会在System server的<code>startOtherService</code>中传递给AMS的runnable中调用，用来等待数据准备完成。</p>
<p><strong>总结</strong>：首次开机过程中应用的安装设计的代码很多，但是做的事情并不多，主要就是通过解析apk更新PKMS的成员变量的内容，例如mSettings、mPackages以及权限相关成员、lib库相关成员，以及更重要的四大组件的解析器信息，并准备apk的数据。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/07/26/Android “original-package” 机制解析/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          Android “original-package” 机制解析
        
      </div>
    </a>
  
  
    <a href="/2018/07/13/HashMap、LinkedHashMap、三级缓存/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">HashMap、LinkedHashMap、三级缓存</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、应用安装类型"><span class="nav-number">1.</span> <span class="nav-text">一、应用安装类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、安装过程"><span class="nav-number">2.</span> <span class="nav-text">二、安装过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#首次开机安装"><span class="nav-number">2.1.</span> <span class="nav-text">首次开机安装</span></a></li></ol></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2018 - 2019 得一 All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>


  <script src="/js/home.js"></script>



  <script src="/js/dialog.js"></script>









	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            得一
          </div>
          <div class="panel-body">
            Copyright © 2019 me All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>