<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>应用安装-adb方式进行安装 | 得一</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="PackageManagerServicePKMSAndroid" />
  
  
  
  
  <meta name="description" content="adb方式进行安装adb 相关代码在system&#x2F;core&#x2F;adb&#x2F;中，入口在&#x2F;system&#x2F;core&#x2F;adb&#x2F;client&#x2F;main.cpp的main方法中： 1234int main(int argc, char** argv) &amp;#123;    adb_trace_init(argv);    return a">
<meta property="og:type" content="article">
<meta property="og:title" content="应用安装-adb方式进行安装">
<meta property="og:url" content="https://mouzishuo.github.io/2018/07/28/adb%E5%AE%89%E8%A3%85%E5%BA%94%E7%94%A8/index.html">
<meta property="og:site_name" content="得一">
<meta property="og:description" content="adb方式进行安装adb 相关代码在system&#x2F;core&#x2F;adb&#x2F;中，入口在&#x2F;system&#x2F;core&#x2F;adb&#x2F;client&#x2F;main.cpp的main方法中： 1234int main(int argc, char** argv) &amp;#123;    adb_trace_init(argv);    return a">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://mouzishuo.github.io/.io//android/Documents/Notes/Map/stageDir.png">
<meta property="article:published_time" content="2018-07-28T06:21:08.000Z">
<meta property="article:modified_time" content="2019-01-16T01:14:47.564Z">
<meta property="article:author" content="me">
<meta property="article:tag" content="PackageManagerService">
<meta property="article:tag" content="PKMS">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mouzishuo.github.io/.io//android/Documents/Notes/Map/stageDir.png">
  

  

  <link rel="icon" href="/css/images/avatar.jpg">
  <link rel="apple-touch-icon" href="/css/images/avatar.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/jquery-3.1.1.min.js"></script>

  
<script src="/js/bootstrap.js"></script>


  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    
<link rel="stylesheet" href="/css/dialog.css">

  

  

  
    <link rel="stylesheet" href="/css/header-post.css" >
  

  
  
  

<meta name="generator" content="Hexo 6.3.0"></head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 5px;"  
                href="#" data-toggle="modal" data-target="#myModal" >
                  <img width="93px" height="93px" alt="Hike News" src="/css/images/avatar.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">分类</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div></li>
            </div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-adb安装应用" style="width: 75%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      应用安装-adb方式进行安装
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/07/28/adb%E5%AE%89%E8%A3%85%E5%BA%94%E7%94%A8/" class="article-date">
	  <time datetime="2018-07-28T06:21:08.000Z" itemprop="datePublished">2018-07-28</time>
	</a>

      
    <a class="article-category-link" href="/categories/Android/">Android</a><a class="article-category-link" href="/categories/Android/%E5%BA%94%E7%94%A8%E5%AE%89%E8%A3%85/">应用安装</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="adb方式进行安装"><a href="#adb方式进行安装" class="headerlink" title="adb方式进行安装"></a>adb方式进行安装</h3><p>adb 相关代码在system&#x2F;core&#x2F;adb&#x2F;中，入口在&#x2F;system&#x2F;core&#x2F;adb&#x2F;client&#x2F;main.cpp的main方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> &#123;</span><br><span class="line">    adb_trace_init(argv);</span><br><span class="line">    <span class="keyword">return</span> adb_commandline(argc - <span class="number">1</span>, const_cast&lt;const <span class="type">char</span>**&gt;(argv + <span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>命令的处理在system&#x2F;core&#x2F;adb&#x2F;commandline.cpp中，与安装相关的代码也在其中,经过参数解析调到下面的函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">install_app</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The last argument must be the APK file</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* file = argv[argc - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> (!android::base::<span class="built_in">EndsWithIgnoreCase</span>(file, <span class="string">&quot;.apk&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">syntax_error</span>(<span class="string">&quot;filename doesn&#x27;t end .apk: %s&quot;</span>, file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> sb;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">stat</span>(file, &amp;sb) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;adb: failed to stat %s: %s\n&quot;</span>, file, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> localFd = <span class="built_in">adb_open</span>(file, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (localFd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;adb: failed to open %s: %s\n&quot;</span>, file, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::string error;</span><br><span class="line">    std::string cmd = <span class="string">&quot;exec:cmd package&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// don&#x27;t copy the APK name, but, copy the rest of the arguments as-is</span></span><br><span class="line">    <span class="keyword">while</span> (argc-- &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        cmd += <span class="string">&quot; &quot;</span> + <span class="built_in">escape_arg</span>(std::<span class="built_in">string</span>(*argv++));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add size parameter [required for streaming installs]</span></span><br><span class="line">    <span class="comment">// do last to override any user specified value</span></span><br><span class="line">    cmd += <span class="string">&quot; &quot;</span> + android::base::<span class="built_in">StringPrintf</span>(<span class="string">&quot;-S %&quot;</span> PRIu64, <span class="built_in">static_cast</span>&lt;<span class="type">uint64_t</span>&gt;(sb.st_size));</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> remoteFd = <span class="built_in">adb_connect</span>(cmd, &amp;error);</span><br><span class="line">    <span class="keyword">if</span> (remoteFd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;adb: connect error for write: %s\n&quot;</span>, error.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="built_in">adb_close</span>(localFd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[BUFSIZ];</span><br><span class="line">    <span class="built_in">copy_to_file</span>(localFd, remoteFd);</span><br><span class="line">    <span class="built_in">read_status_line</span>(remoteFd, buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">adb_close</span>(localFd);</span><br><span class="line">    <span class="built_in">adb_close</span>(remoteFd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(<span class="string">&quot;Success&quot;</span>, buf, <span class="number">7</span>)) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(buf, stdout);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;adb: failed to install %s: %s&quot;</span>, file, buf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>其实是通过adb shell cmd package（包管理命令）进行安装，安装后adb 断开。也就是说在adb shell中通过cmd也可以调用各种adb的命令。但是不能用cmd package install 安装手机上的apk。通过cmd -l可以查看cmd支持的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">20|k400_o:/data/data # cmd -l                                                                                                                 </span><br><span class="line">Currently running services:</span><br><span class="line">  AAL</span><br><span class="line">  //省略</span><br><span class="line">  window</span><br></pre></td></tr></table></figure>

<p>输出结果和adb shell dumpsys -l结果一致。cmd对应的可执行文件为&#x2F;system&#x2F;bin&#x2F;cmd，对应的源码为frameworks&#x2F;native&#x2F;cmds&#x2F;cmd&#x2F;cmd.cpp，入口方法如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* <span class="type">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;   <span class="comment">//……</span></span><br><span class="line">    sp&lt;IServiceManager&gt; sm = <span class="built_in">defaultServiceManager</span>();</span><br><span class="line">    <span class="built_in">fflush</span>(stdout);</span><br><span class="line">	<span class="comment">//……</span></span><br><span class="line">    <span class="keyword">if</span> ((argc == <span class="number">2</span>) &amp;&amp; (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;-l&quot;</span>) == <span class="number">0</span>)) &#123;<span class="comment">//对应adb shell cmd -l命令</span></span><br><span class="line">        Vector&lt;String16&gt; services = sm-&gt;<span class="built_in">listServices</span>();</span><br><span class="line">        services.<span class="built_in">sort</span>(sort_func);</span><br><span class="line">        aout &lt;&lt; <span class="string">&quot;Currently running services:&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i=<span class="number">0</span>; i&lt;services.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            sp&lt;IBinder&gt; service = sm-&gt;<span class="built_in">checkService</span>(services[i]);</span><br><span class="line">            <span class="keyword">if</span> (service != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                aout &lt;&lt; <span class="string">&quot;  &quot;</span> &lt;&lt; services[i] &lt;&lt; endl;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Vector&lt;String16&gt; args;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">2</span>; i&lt;argc; i++) &#123;</span><br><span class="line">        args.<span class="built_in">add</span>(<span class="built_in">String16</span>(argv[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    String16 cmd = <span class="built_in">String16</span>(argv[<span class="number">1</span>]);<span class="comment">//cmd:package</span></span><br><span class="line">    sp&lt;IBinder&gt; service = sm-&gt;<span class="built_in">checkService</span>(cmd);</span><br><span class="line">    <span class="comment">//……</span></span><br><span class="line">    sp&lt;MyShellCallback&gt; cb = <span class="keyword">new</span> <span class="built_in">MyShellCallback</span>();</span><br><span class="line">    sp&lt;MyResultReceiver&gt; result = <span class="keyword">new</span> <span class="built_in">MyResultReceiver</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> block until a result is returned to MyResultReceiver.</span></span><br><span class="line">    <span class="type">status_t</span> err = IBinder::<span class="built_in">shellCommand</span>(service, STDIN_FILENO, STDOUT_FILENO, STDERR_FILENO, args, cb, result);</span><br><span class="line">    <span class="comment">//……</span></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PKMS在启动后会注册到ServiceManager中，所以这里的package服务应该就是PKMS了，看下c++层Binder的shellCommand方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">status_t IBinder::shellCommand(const sp&lt;IBinder&gt;&amp; target, <span class="type">int</span> in, <span class="type">int</span> out, <span class="type">int</span> err,</span><br><span class="line">    Vector&lt;String16&gt;&amp; args, const sp&lt;IShellCallback&gt;&amp; callback,</span><br><span class="line">    const sp&lt;IResultReceiver&gt;&amp; resultReceiver)</span><br><span class="line">&#123;</span><br><span class="line">    Parcel send;</span><br><span class="line">    Parcel reply;</span><br><span class="line">    send.writeFileDescriptor(in);</span><br><span class="line">    send.writeFileDescriptor(out);</span><br><span class="line">    send.writeFileDescriptor(err);</span><br><span class="line">    const <span class="type">size_t</span> <span class="variable">numArgs</span> <span class="operator">=</span> args.size();</span><br><span class="line">    send.writeInt32(numArgs);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numArgs; i++) &#123;</span><br><span class="line">        send.writeString16(args[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    send.writeStrongBinder(callback != NULL ? IInterface::asBinder(callback) : NULL);</span><br><span class="line">    send.writeStrongBinder(resultReceiver != NULL ? IInterface::asBinder(resultReceiver) : NULL);</span><br><span class="line">    <span class="keyword">return</span> target-&gt;transact(SHELL_COMMAND_TRANSACTION, send, &amp;reply);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只需要关心其中一句<code>return target-&gt;transact(SHELL_COMMAND_TRANSACTION, send, &amp;reply);</code>即可。这里的target不难推测应该就是PKMS，但是PKMS中并没用处理SHELL_COMMAND_TRANSACTION，transact的第一个参数从C++ 层到java层一般是不会变的，不停地往父类查找，发现该消息是在Binder.java中处理的。PKMS是Binder的间接子类，不难推测PKMS肯定覆写了Binder的某个方法，而在SHELL_COMMAND_TRANSACTION的后续处理中会调用到该方法，然后流程进入到PKMS中。来看下java层的Binder，看看收到SHELL_COMMAND_TRANSACTION消息会做些什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onTransact</span><span class="params">(<span class="type">int</span> code, <span class="meta">@NonNull</span> Parcel data, <span class="meta">@Nullable</span> Parcel reply,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> flags)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="keyword">if</span> (code == INTERFACE_TRANSACTION) &#123;</span><br><span class="line">        reply.writeString(getInterfaceDescriptor());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code == DUMP_TRANSACTION) &#123;对应adb shell dumpsys????</span><br><span class="line">        <span class="type">ParcelFileDescriptor</span> <span class="variable">fd</span> <span class="operator">=</span> data.readFileDescriptor();</span><br><span class="line">        String[] args = data.readStringArray();</span><br><span class="line">        <span class="keyword">if</span> (fd != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                dump(fd.getFileDescriptor(), args);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                IoUtils.closeQuietly(fd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Write the StrictMode header.</span></span><br><span class="line">        <span class="keyword">if</span> (reply != <span class="literal">null</span>) &#123;</span><br><span class="line">            reply.writeNoException();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            StrictMode.clearGatheredViolations();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code == SHELL_COMMAND_TRANSACTION) &#123;</span><br><span class="line">        <span class="comment">//……</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (out != <span class="literal">null</span>) &#123;</span><br><span class="line">                shellCommand(in != <span class="literal">null</span> ? in.getFileDescriptor() : <span class="literal">null</span>,</span><br><span class="line">                        out.getFileDescriptor(),</span><br><span class="line">                        err != <span class="literal">null</span> ? err.getFileDescriptor() : out.getFileDescriptor(),</span><br><span class="line">                        args, shellCallback, resultReceiver);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"> <span class="comment">//……</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>shellCommand方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shellCommand</span><span class="params">(<span class="meta">@Nullable</span> FileDescriptor in, <span class="meta">@Nullable</span> FileDescriptor out,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> FileDescriptor err,</span></span><br><span class="line"><span class="params">        <span class="meta">@NonNull</span> String[] args, <span class="meta">@Nullable</span> ShellCallback callback,</span></span><br><span class="line"><span class="params">        <span class="meta">@NonNull</span> ResultReceiver resultReceiver)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    onShellCommand(in, out, err, args, callback, resultReceiver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>onShellCommander方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onShellCommand</span><span class="params">(<span class="meta">@Nullable</span> FileDescriptor in, <span class="meta">@Nullable</span> FileDescriptor out,</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> FileDescriptor err,</span></span><br><span class="line"><span class="params">        <span class="meta">@NonNull</span> String[] args, <span class="meta">@Nullable</span> ShellCallback callback,</span></span><br><span class="line"><span class="params">        <span class="meta">@NonNull</span> ResultReceiver resultReceiver)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">fout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(err != <span class="literal">null</span> ? err : out);</span><br><span class="line">    <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FastPrintWriter</span>(fout);</span><br><span class="line">    pw.println(<span class="string">&quot;No shell command implementation.&quot;</span>);</span><br><span class="line">    pw.flush();</span><br><span class="line">    resultReceiver.send(<span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面是Binder.java实现的onShellCommand方法，而PKMS覆写了该方法，所以这里调用的应该是PKMS的<code>onShellCommand</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onShellCommand</span><span class="params">(FileDescriptor in, FileDescriptor out,</span></span><br><span class="line"><span class="params">        FileDescriptor err, String[] args, ShellCallback callback,</span></span><br><span class="line"><span class="params">        ResultReceiver resultReceiver)</span> &#123;</span><br><span class="line">    (<span class="keyword">new</span> <span class="title class_">PackageManagerShellCommand</span>(<span class="built_in">this</span>)).exec(</span><br><span class="line">            <span class="built_in">this</span>, in, out, err, args, callback, resultReceiver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>onShellCommand</code>调用了PackageManagerShellCommand的exec方法来执行命令行获取的命令，PackageManagerShellCommand继承自抽象类ShellCommand，而该类是用来辅助实现Binder.onShellCommand方法的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">exec</span><span class="params">(Binder target, FileDescriptor in, FileDescriptor out, FileDescriptor err,</span></span><br><span class="line"><span class="params">         String[] args, ShellCallback callback, ResultReceiver resultReceiver)</span> &#123;</span><br><span class="line">     String cmd;</span><br><span class="line">     <span class="comment">//……</span></span><br><span class="line">     mCmd = cmd;</span><br><span class="line">     mResultReceiver = resultReceiver;</span><br><span class="line">     <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         res = onCommand(mCmd);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (SecurityException e) &#123;<span class="comment">//……</span></span><br><span class="line">     &#125; <span class="keyword">catch</span> (Throwable e) &#123;<span class="comment">//……</span></span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">   <span class="comment">//……</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">&quot;Finished command &quot;</span> + mCmd + <span class="string">&quot; on &quot;</span> + mTarget);</span><br><span class="line">     <span class="keyword">return</span> res;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>onCommand方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">onCommand</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (cmd == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> handleDefaultCommands(cmd);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">final</span> <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> getOutPrintWriter();</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">switch</span>(cmd) &#123;</span><br><span class="line">             <span class="keyword">case</span> <span class="string">&quot;install&quot;</span>:</span><br><span class="line">                 <span class="keyword">return</span> runInstall();</span><br><span class="line">   <span class="comment">//省略代码</span></span><br><span class="line">             <span class="keyword">default</span>:</span><br><span class="line">                 <span class="keyword">return</span> handleDefaultCommands(cmd);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">         pw.println(<span class="string">&quot;Remote exception: &quot;</span> + e);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>支持的命令很多，这里只关心install，该命令对应<code>runInstall()</code>方法，<code>runInstall()</code>方法可以分为以下几个部分：</p>
<ol>
<li>参数解析</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">InstallParams</span> <span class="variable">params</span> <span class="operator">=</span> makeInstallParams();</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">inPath</span> <span class="operator">=</span> getNextArg();</span><br><span class="line">setParamsSize(params, inPath);</span><br></pre></td></tr></table></figure>

<p>这部分较简单，就是对前面安装命令中参数的解析并根据参数设置installFlags的标志位。</p>
<ol start="2">
<li>创建应用安装会话</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">sessionId</span> <span class="operator">=</span> doCreateSession(params.sessionParams,</span><br><span class="line">                params.installerPackageName, params.userId);<span class="comment">//adb安装，userid为0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">doCreateSession</span><span class="params">(SessionParams params, String installerPackageName, <span class="type">int</span> userId)</span></span><br><span class="line">        <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    userId = translateUserId(userId, <span class="string">&quot;runInstallCreate&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (userId == UserHandle.USER_ALL) &#123;</span><br><span class="line">        userId = UserHandle.USER_SYSTEM;</span><br><span class="line">        params.installFlags |= PackageManager.INSTALL_ALL_USERS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">sessionId</span> <span class="operator">=</span> mInterface.getPackageInstaller()</span><br><span class="line">            .createSession(params, installerPackageName, userId);</span><br><span class="line">    <span class="keyword">return</span> sessionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后调用到<code>PackageInstallerService</code>的<code>createSession()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">createSession</span><span class="params">(SessionParams params, String installerPackageName, <span class="type">int</span> userId)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createSessionInternal(params, installerPackageName, userId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionUtils.wrap(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">createSessionInternal</span><span class="params">(SessionParams params, String installerPackageName, <span class="type">int</span> userId)</span></span><br><span class="line">         <span class="keyword">throws</span> IOException &#123;<span class="comment">//userid为0</span></span><br><span class="line">     <span class="keyword">final</span> <span class="type">int</span> <span class="variable">callingUid</span> <span class="operator">=</span> Binder.getCallingUid();<span class="comment">//adb的linux uid为0</span></span><br><span class="line">     mPm.enforceCrossUserPermission(callingUid, userId, <span class="literal">true</span>, <span class="literal">true</span>, <span class="string">&quot;createSession&quot;</span>);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (mPm.isUserRestricted(userId, UserManager.DISALLOW_INSTALL_APPS)) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;User restriction prevents installing&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> ((callingUid == Process.SHELL_UID) || (callingUid == Process.ROOT_UID<span class="comment">/*0*/</span>)) &#123;</span><br><span class="line">         params.installFlags |= PackageManager.INSTALL_FROM_ADB;</span><br><span class="line"></span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         mAppOps.checkPackage(callingUid, installerPackageName);</span><br><span class="line"></span><br><span class="line">         params.installFlags &amp;= ~PackageManager.INSTALL_FROM_ADB;</span><br><span class="line">         params.installFlags &amp;= ~PackageManager.INSTALL_ALL_USERS;</span><br><span class="line">         params.installFlags |= PackageManager.INSTALL_REPLACE_EXISTING;</span><br><span class="line">         <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_VIRTUAL_PRELOAD) != <span class="number">0</span></span><br><span class="line">                 &amp;&amp; !mPm.isCallerVerifier(callingUid)) &#123;</span><br><span class="line">             params.installFlags &amp;= ~PackageManager.INSTALL_VIRTUAL_PRELOAD;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Only system components can circumvent runtime permissions when installing.</span></span><br><span class="line">     <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_GRANT_RUNTIME_PERMISSIONS) != <span class="number">0</span></span><br><span class="line">             &amp;&amp; mContext.checkCallingOrSelfPermission(Manifest.permission</span><br><span class="line">             .INSTALL_GRANT_RUNTIME_PERMISSIONS) == PackageManager.PERMISSION_DENIED) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;You need the &quot;</span></span><br><span class="line">                 + <span class="string">&quot;android.permission.INSTALL_GRANT_RUNTIME_PERMISSIONS permission &quot;</span></span><br><span class="line">                 + <span class="string">&quot;to use the PackageManager.INSTALL_GRANT_RUNTIME_PERMISSIONS flag&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_FORWARD_LOCK) != <span class="number">0</span></span><br><span class="line">             || (params.installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                 <span class="string">&quot;New installs into ASEC containers no longer supported&quot;</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// Defensively resize giant app icons</span></span><br><span class="line">     <span class="keyword">if</span> (params.appIcon != <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">final</span> <span class="type">ActivityManager</span> <span class="variable">am</span> <span class="operator">=</span> (ActivityManager) mContext.getSystemService(</span><br><span class="line">                 Context.ACTIVITY_SERVICE);</span><br><span class="line">         <span class="keyword">final</span> <span class="type">int</span> <span class="variable">iconSize</span> <span class="operator">=</span> am.getLauncherLargeIconSize();</span><br><span class="line">         <span class="keyword">if</span> ((params.appIcon.getWidth() &gt; iconSize * <span class="number">2</span>)</span><br><span class="line">                 || (params.appIcon.getHeight() &gt; iconSize * <span class="number">2</span>)) &#123;</span><br><span class="line">             params.appIcon = Bitmap.createScaledBitmap(params.appIcon, iconSize, iconSize,</span><br><span class="line">                     <span class="literal">true</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">switch</span> (params.mode) &#123;</span><br><span class="line">         <span class="keyword">case</span> SessionParams.MODE_FULL_INSTALL:</span><br><span class="line">         <span class="keyword">case</span> SessionParams.MODE_INHERIT_EXISTING:</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">default</span>:</span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Invalid install mode: &quot;</span> + params.mode);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// If caller requested explicit location, sanity check it, otherwise</span></span><br><span class="line">     <span class="comment">// resolve the best internal or adopted location.</span></span><br><span class="line">     <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">   <span class="comment">//……</span></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_EXTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//……</span></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_FORCE_VOLUME_UUID) != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// For now, installs to adopted media are treated as internal from</span></span><br><span class="line">         <span class="comment">// an install flag point-of-view.</span></span><br><span class="line">         params.setInstallFlagsInternal();</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123; <span class="comment">//adb 安装走这里</span></span><br><span class="line">         <span class="comment">// For now, installs to adopted media are treated as internal from</span></span><br><span class="line">         <span class="comment">// an install flag point-of-view.</span></span><br><span class="line">         params.setInstallFlagsInternal();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Resolve best location for install, based on combination of</span></span><br><span class="line">         <span class="comment">// requested install flags, delta size, and manifest settings.</span></span><br><span class="line">         <span class="keyword">final</span> <span class="type">long</span> <span class="variable">ident</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             params.volumeUuid = PackageHelper.resolveInstallVolume(mContext, params);</span><br><span class="line">         &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">             Binder.restoreCallingIdentity(ident);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">final</span> <span class="type">int</span> sessionId;</span><br><span class="line">     <span class="keyword">final</span> PackageInstallerSession session;</span><br><span class="line">     <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">         <span class="comment">// Sanity check that installer isn&#x27;t going crazy</span></span><br><span class="line">         <span class="comment">//……</span></span><br><span class="line">         sessionId = allocateSessionIdLocked();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">final</span> <span class="type">long</span> <span class="variable">createdMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">     <span class="comment">// We&#x27;re staging to exactly one location</span></span><br><span class="line">     <span class="type">File</span> <span class="variable">stageDir</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">     <span class="type">String</span> <span class="variable">stageCid</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">     <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isInstant</span> <span class="operator">=</span></span><br><span class="line">                 (params.installFlags &amp; PackageManager.INSTALL_INSTANT_APP) != <span class="number">0</span>;</span><br><span class="line">         stageDir = buildStageDir(params.volumeUuid, sessionId, isInstant);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         stageCid = buildExternalStageCid(sessionId);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     session = <span class="keyword">new</span> <span class="title class_">PackageInstallerSession</span>(mInternalCallback, mContext, mPm,</span><br><span class="line">             mInstallThread.getLooper(), sessionId, userId, installerPackageName, callingUid,</span><br><span class="line">             params, createdMillis, stageDir, stageCid, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">synchronized</span> (mSessions) &#123;</span><br><span class="line">         mSessions.put(sessionId, session);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     mCallbacks.notifySessionCreated(session.sessionId, session.userId);</span><br><span class="line">     writeSessionsAsync();</span><br><span class="line">     <span class="keyword">return</span> sessionId;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>上面方法的主要作用是创建PackageInstallerSession并添加到mSessions中，并将sessionId返回，该Session在安装结束或失败后都会被销毁。里面涉及到Binder的两种用法，因为和这里的主题关系不大，以后另作了解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">callingUid</span> <span class="operator">=</span> Binder.getCallingUid();<span class="comment">//</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">ident</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">Binder.restoreCallingIdentity(ident);</span><br></pre></td></tr></table></figure>

<p>上段代码里有个对安装流程比较关键的地方：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stageDir = buildStageDir(params.volumeUuid, sessionId, isInstant);</span><br></pre></td></tr></table></figure>

<p>该目录为&#x2F;data&#x2F;app&#x2F;vmdl×××××.tmp（之前了解开机扫描app的过程中好像看到过，这种目录在扫描中会被跳过），从adb读取的apk文件会暂时存放到该目录下，然后apk中的so文件也会提取到该目录。</p>
<p>session的具体创建过程就不了解了，只看下session创建时的参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">session = <span class="keyword">new</span> <span class="title class_">PackageInstallerSession</span>(mInternalCallback, mContext, mPm,</span><br><span class="line">        mInstallThread.getLooper(), sessionId, userId, installerPackageName, callingUid,</span><br><span class="line">        params, createdMillis, stageDir, stageCid, <span class="literal">false</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>mInternalCallback封装了Session生命周期中的回调；</li>
<li>mContext：Session的上下文</li>
<li>mPm：PackageManagerService的实例；</li>
<li>mInstallThread.getLooper()安装线程的looper，mInstallThread为HandlerThread实例，从这里可以推断应用安装是在子线程中进行的，该子线程是在PackageInstallerService初始化方法中创建的，而PackageInstallerService的初始化方法是在PKMS的初始化方法中调用的。</li>
<li>sessionId作为session的标示；</li>
<li>userId这里为0；</li>
<li>installerPackageName对应packageInstaller的包名，比如com.android.packageinstaller;</li>
<li>callingUid为0</li>
<li>params：安装参数；</li>
<li>stageDir:apk暂存目录；</li>
</ul>
<ol start="3">
<li>把apk复制到临时目录</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (doWriteSplit(sessionId, inPath, params.sessionParams.sizeBytes, <span class="string">&quot;base.apk&quot;</span>,</span><br><span class="line">        <span class="literal">false</span> <span class="comment">/*logSuccess*/</span>) != PackageInstaller.STATUS_SUCCESS) &#123;<span class="comment">//把base.apk拷贝到/data/app/vmdl1025879988.tmp目录下</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前面已经构建了应用安装的session信息，接下来这一步会根据sessionId获取session信息（SessionInfo类），然后从标准输入流读入apk文件并写入到&#x2F;data&#x2F;app&#x2F;vmdl×××××.tmp&#x2F;base.apk.</p>
<p>通过打断点的方式可以看到临时目录的信息：</p>
<p><img src="/.io//android/Documents/Notes/Map/stageDir.png" alt="stageDir"></p>
<p>nativeLib的复制会在下一步进行。</p>
<ol start="4">
<li>提交会话</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (doCommitSession(sessionId, <span class="literal">false</span> <span class="comment">/*logSuccess*/</span>)</span><br><span class="line">        != PackageInstaller.STATUS_SUCCESS) &#123;<span class="comment">//提取lib到/data/app/vmdl1025879988.tmp目录下???</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">doCommitSession</span><span class="params">(<span class="type">int</span> sessionId, <span class="type">boolean</span> logSuccess)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> getOutPrintWriter();</span><br><span class="line">    PackageInstaller.<span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        session = <span class="keyword">new</span> <span class="title class_">PackageInstaller</span>.Session(</span><br><span class="line">                mInterface.getPackageInstaller().openSession(sessionId));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">LocalIntentReceiver</span> <span class="variable">receiver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LocalIntentReceiver</span>();</span><br><span class="line">        session.commit(receiver.getIntentSender());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">result</span> <span class="operator">=</span> receiver.getResult();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> result.getIntExtra(PackageInstaller.EXTRA_STATUS,</span><br><span class="line">                PackageInstaller.STATUS_FAILURE);</span><br><span class="line">        <span class="keyword">if</span> (status == PackageInstaller.STATUS_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logSuccess) &#123;</span><br><span class="line">                pw.println(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            pw.println(<span class="string">&quot;Failure [&quot;</span></span><br><span class="line">                    + result.getStringExtra(PackageInstaller.EXTRA_STATUS_MESSAGE) + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用PackageInstaller.Session#commit()提交installersession，然后把执行的结果写到receiver中，并在标准输出输出结果。再来看下session.commit的具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Attempt to commit everything staged（暂存） in this session. This may require</span></span><br><span class="line"><span class="comment"> * user intervention（介入）, and so it may not happen immediately. The final</span></span><br><span class="line"><span class="comment"> * result of the commit will be reported through the given callback.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Once this method is called, the session is sealed and no additional</span></span><br><span class="line"><span class="comment"> * mutations may be performed on the session. If the device reboots</span></span><br><span class="line"><span class="comment"> * before the session has been finalized, you may commit the session again.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SecurityException if streams opened through</span></span><br><span class="line"><span class="comment"> *             &#123;<span class="doctag">@link</span> #openWrite(String, long, long)&#125; are still open.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(<span class="meta">@NonNull</span> IntentSender statusReceiver)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mSession.commit(statusReceiver, <span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 该方法一旦调用该installersession就会封存起来，不再允许进行改变。mSession为IPackageInstallerSession类型，具体类型为PackageInstallerSession，其commit方法实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(<span class="meta">@NonNull</span> IntentSender statusReceiver, <span class="type">boolean</span> forTransfer)</span> &#123;</span><br><span class="line">    Preconditions.checkNotNull(statusReceiver);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> wasSealed;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">       <span class="comment">//Check if the caller is the owner of this session. Otherwise throw a</span></span><br><span class="line">       <span class="comment">//SecurityException.</span></span><br><span class="line">        assertCallerIsOwnerOrRootLocked();</span><br><span class="line">        assertPreparedAndNotDestroyedLocked(<span class="string">&quot;commit&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">PackageInstallObserverAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageInstallObserverAdapter</span>(</span><br><span class="line">                mContext, statusReceiver, sessionId, isInstallerDeviceOwnerLocked(), userId);</span><br><span class="line">        mRemoteObserver = adapter.getBinder();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (forTransfer) &#123;<span class="comment">//adb安装forTransfer值为false</span></span><br><span class="line">            mContext.enforceCallingOrSelfPermission(Manifest.permission.INSTALL_PACKAGES, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (mInstallerUid == mOriginalInstallerUid) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Session has not been transferred&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mInstallerUid != mOriginalInstallerUid) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Session has been transferred&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        wasSealed = mSealed;</span><br><span class="line">        <span class="keyword">if</span> (!mSealed) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//Seal the session to prevent further modification and validate the contents of it.</span></span><br><span class="line">                sealAndValidateLocked();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                destroyInternal();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Cannot call dispatchFinal synchronous as this might be called from inside the</span></span><br><span class="line">                <span class="comment">// system server on the main thread. Hence the call back scheduled in</span></span><br><span class="line">                <span class="comment">// dispachFinal has to be scheduled on a different thread.</span></span><br><span class="line">                mHandler.obtainMessage(MSG_SESSION_FINISHED_WITH_EXCEPTION, e).sendToTarget();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Client staging is fully done at this point</span></span><br><span class="line">        <span class="comment">//更新callback中的进度，callback存在于Launcher和PackageInstaller中，本地安装</span></span><br><span class="line">        <span class="comment">//时会回调到packageInstaller中</span></span><br><span class="line">        mClientProgress = <span class="number">1f</span>;</span><br><span class="line">        computeProgressLocked(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This ongoing commit should keep session active, even though client</span></span><br><span class="line">        <span class="comment">// will probably close their end.</span></span><br><span class="line">        mActiveCount.incrementAndGet();</span><br><span class="line"></span><br><span class="line">        mCommitted = <span class="literal">true</span>;<span class="comment">//切换到安装线程，提交信息</span></span><br><span class="line">        mHandler.obtainMessage(MSG_COMMIT).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!wasSealed) &#123;</span><br><span class="line">        <span class="comment">// Persist the fact that we&#x27;ve sealed ourselves to prevent</span></span><br><span class="line">        <span class="comment">// mutations of any hard links we create. We do this without holding</span></span><br><span class="line">        <span class="comment">// the session lock, since otherwise it&#x27;s a lock inversion.</span></span><br><span class="line">        mCallback.onSessionSealedBlocking(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先进行了一些检测工作，之后封存session，然后更新进度，该过程会调用一系列的回调方法，最终通知Launcher和PackageInstaller等应用安装进度，再然后从binder线程切换到安装线程，正式进行session的提交，最后将封存的session信息写到&#x2F;data&#x2F;system&#x2F;install_sessions.xml中，该文件的内容大致如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27; standalone=&#x27;yes&#x27; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sessions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">session</span> <span class="attr">sessionId</span>=<span class="string">&quot;23005909&quot;</span> <span class="attr">userId</span>=<span class="string">&quot;0&quot;</span> <span class="attr">installerUid</span>=<span class="string">&quot;0&quot;</span> <span class="attr">createdMillis</span>=<span class="string">&quot;1533527321478&quot;</span> <span class="attr">sessionStageDir</span>=<span class="string">&quot;/data/app/vmdl23005909.tmp&quot;</span> <span class="attr">prepared</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sealed</span>=<span class="string">&quot;true&quot;</span> <span class="attr">mode</span>=<span class="string">&quot;1&quot;</span> <span class="attr">installFlags</span>=<span class="string">&quot;114&quot;</span> <span class="attr">installLocation</span>=<span class="string">&quot;1&quot;</span> <span class="attr">sizeBytes</span>=<span class="string">&quot;6003376&quot;</span> <span class="attr">originatingUid</span>=<span class="string">&quot;-1&quot;</span> <span class="attr">installRason</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sessions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面就该了解下MSG_COMMIT这个消息是怎么处理的了，该message是在Handler的callback中处理的，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MSG_COMMIT:</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            commitLocked();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">completeMsg</span> <span class="operator">=</span> ExceptionUtils.getCompleteMessage(e);</span><br><span class="line">            Slog.e(TAG,</span><br><span class="line">                    <span class="string">&quot;Commit of session &quot;</span> + sessionId + <span class="string">&quot; failed: &quot;</span> + completeMsg);</span><br><span class="line">            destroyInternal();</span><br><span class="line">            dispatchSessionFinished(e.error, completeMsg, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>首先调用<code>commitLocked()</code>提交会话，如果出现异常则进行一些清理工作，删除安装过程中创建的文件，并将该session标记为destroyed,然后分发session提交失败的消息，该分发过程在安装成功的情况下再介绍，这里先不管。</p>
<p>接着继续看commit的过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">commitLocked</span><span class="params">()</span></span><br><span class="line">          <span class="keyword">throws</span> PackageManagerException &#123;</span><br><span class="line">		<span class="comment">//省略一些检测代码</span></span><br><span class="line">      <span class="keyword">if</span> (needToAskForPermissionsLocked()) &#123;<span class="comment">//请求安装权限，adb安装不需要申请权限</span></span><br><span class="line">          <span class="comment">// User needs to accept permissions; give installer an intent they</span></span><br><span class="line">          <span class="comment">// can use to involve user.</span></span><br><span class="line">          <span class="keyword">final</span> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(PackageInstaller.ACTION_CONFIRM_PERMISSIONS);</span><br><span class="line">          intent.setPackage(mContext.getPackageManager().getPermissionControllerPackageName());</span><br><span class="line">          intent.putExtra(PackageInstaller.EXTRA_SESSION_ID, sessionId);</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              mRemoteObserver.onUserActionRequired(intent);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Commit was keeping session marked as active until now; release</span></span><br><span class="line">          <span class="comment">// that extra refcount so session appears idle.</span></span><br><span class="line">          closeInternal(<span class="literal">false</span>);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//……</span></span><br><span class="line">      <span class="comment">// Inherit any packages and native libraries from existing install that</span></span><br><span class="line">      <span class="comment">// haven&#x27;t been overridden.</span></span><br><span class="line">      <span class="keyword">if</span> (params.mode == SessionParams.MODE_INHERIT_EXISTING) &#123;</span><br><span class="line">   <span class="comment">//常见的安装模式是MODE_FULL_INSTALL=1，安装时带-p参数时会将该标志位置为1，</span></span><br><span class="line">          <span class="comment">//MODE_INHERIT_EXISTING的情况先不管</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> surface more granular state from dexopt</span></span><br><span class="line">      mInternalProgress = <span class="number">0.5f</span>;</span><br><span class="line">      computeProgressLocked(<span class="literal">true</span>);<span class="comment">//更新进度</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Unpack native libraries</span></span><br><span class="line">      extractNativeLibraries(mResolvedStageDir, params.abiOverride);</span><br><span class="line"><span class="comment">//……</span></span><br><span class="line">      <span class="comment">// We&#x27;ve reached point of no return; call into PMS to install the stage.</span></span><br><span class="line">      <span class="comment">// Regardless of success or failure we always destroy session.</span></span><br><span class="line">      <span class="keyword">final</span> <span class="type">IPackageInstallObserver2</span> <span class="variable">localObserver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IPackageInstallObserver2</span>.Stub() &#123;</span><br><span class="line">	    <span class="comment">//省略</span></span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> UserHandle user;</span><br><span class="line">      <span class="keyword">if</span> ((params.installFlags &amp; PackageManager.INSTALL_ALL_USERS) != <span class="number">0</span>) &#123;</span><br><span class="line">          user = UserHandle.ALL;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          user = <span class="keyword">new</span> <span class="title class_">UserHandle</span>(userId);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      mRelinquished = <span class="literal">true</span>;<span class="comment">//释放控制</span></span><br><span class="line">      mPm.installStage(mPackageName, stageDir, stageCid, localObserver, params,</span><br><span class="line">              mInstallerPackageName, mInstallerUid, user, mCertificates);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>首先是做一些检测，然后更新当前进度，之后调用<code>extractNativeLibraries</code>提取so文件到前面提过的临时目录，再然后构造观察者并传递给PKMS进行安装。</p>
<p>至此，会话的提交过程结束，PackageInstallerSession的用处也就到此为止了，接下来的过程会在PKMS中进行。</p>
<ol start="5">
<li>PKMS复制应用</li>
</ol>
<p>接着上部分，来看下PKMS的<code>installStage</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">void</span> <span class="title function_">installStage</span><span class="params">(String packageName, File stagedDir, String stagedCid,</span></span><br><span class="line"><span class="params">          IPackageInstallObserver2 observer, PackageInstaller.SessionParams sessionParams,</span></span><br><span class="line"><span class="params">          String installerPackageName, <span class="type">int</span> installerUid, UserHandle user,</span></span><br><span class="line"><span class="params">          Certificate[][] certificates)</span> &#123;</span><br><span class="line"><span class="comment">//……</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(INIT_COPY);</span><br><span class="line"><span class="comment">//……</span></span><br><span class="line">      msg.obj = params;</span><br><span class="line">      <span class="comment">//……</span></span><br><span class="line">      mHandler.sendMessage(msg);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>该方法大部分代码是在构造Message的obj对象，然后将message发送给消息循环进行处理。先来看下mHandler关联的looper是哪个，在PKMS的构造方法中找到mHandler的定义：</p>
<p><code>mHandler = new PackageHandler(mHandlerThread.getLooper());</code></p>
<p>再来看下mHandlerThread是什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mHandlerThread = <span class="keyword">new</span> <span class="title class_">ServiceThread</span>(TAG,</span><br><span class="line">        Process.THREAD_PRIORITY_BACKGROUND, <span class="literal">true</span> <span class="comment">/*allowIo*/</span>);</span><br></pre></td></tr></table></figure>

<p>再来看下ServiceThread的声明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Special handler thread that we create for system services that require their own loopers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceThread</span> <span class="keyword">extends</span> <span class="title class_">HandlerThread</span> &#123;<span class="comment">//……&#125;</span></span><br></pre></td></tr></table></figure>

<p>从上面的注释可以知道，ServiceThread是专为需要自己的looper的系统服务创建的HandlerThread，比如说PKMS，应用安装是一种耗时操作，需要在子线程中进行，但是在安装的不同阶段有需要从外界获取信息，以提供不同的服务，所以就需要自己的消息循环。</p>
<p>言归正传，来看下上面发送的消息是什么含义，找到mHandler对<code>INIT_COPY</code>的处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> INIT_COPY: &#123;</span><br><span class="line">                    <span class="type">HandlerParams</span> <span class="variable">params</span> <span class="operator">=</span> (HandlerParams) msg.obj;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> mPendingInstalls.size();</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">&quot;init_copy idx=&quot;</span> + idx + <span class="string">&quot;: &quot;</span> + params);</span><br><span class="line">                    <span class="comment">// If a bind was already initiated we dont really</span></span><br><span class="line">                    <span class="comment">// need to do anything. The pending install</span></span><br><span class="line">                    <span class="comment">// will be processed later on.</span></span><br><span class="line">                    <span class="keyword">if</span> (!mBound) &#123;</span><br><span class="line">                        Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;bindingMCS&quot;</span>,</span><br><span class="line">                                System.identityHashCode(mHandler));</span><br><span class="line">                        <span class="comment">// If this is the only one pending we might</span></span><br><span class="line">                        <span class="comment">// have to bind to the service again.</span></span><br><span class="line">                        <span class="keyword">if</span> (!connectToService()) &#123;</span><br><span class="line">                            Slog.e(TAG, <span class="string">&quot;Failed to bind to media container service&quot;</span>);</span><br><span class="line">                            params.serviceError();</span><br><span class="line">                            Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;bindingMCS&quot;</span>,</span><br><span class="line">                                    System.identityHashCode(mHandler));</span><br><span class="line">                            <span class="keyword">if</span> (params.traceMethod != <span class="literal">null</span>) &#123;</span><br><span class="line">                                Trace.asyncTraceEnd(TRACE_TAG_PACKAGE_MANAGER, params.traceMethod,</span><br><span class="line">                                        params.traceCookie);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// Once we bind to the service, the first</span></span><br><span class="line">                            <span class="comment">// pending request will be processed.</span></span><br><span class="line">                            mPendingInstalls.add(idx, params);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mPendingInstalls.add(idx, params);</span><br><span class="line">                        <span class="comment">// Already bound to the service. Just make</span></span><br><span class="line">                        <span class="comment">// sure we trigger off processing the first request.</span></span><br><span class="line">                        <span class="keyword">if</span> (idx == <span class="number">0</span>) &#123;</span><br><span class="line">                            mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>



<p>上面的代码大致做了两件事：调用 <code>connectToService</code>方法绑定服务，然后将Message传递过来的params添加到mPendingInstalls中。来看下<code>connectToService</code>方法干了些什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">connectToService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">&quot;Trying to bind to&quot;</span> +</span><br><span class="line">            <span class="string">&quot; DefaultContainerService&quot;</span>);</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>().setComponent(DEFAULT_CONTAINER_COMPONENT);</span><br><span class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_DEFAULT);</span><br><span class="line">    <span class="keyword">if</span> (mContext.bindServiceAsUser(service, mDefContainerConn,</span><br><span class="line">            Context.BIND_AUTO_CREATE, UserHandle.SYSTEM)) &#123;</span><br><span class="line">        Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">        mBound = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要就是绑定了下面这个component对应的服务，然后设定优先级：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_CONTAINER_PACKAGE</span> <span class="operator">=</span> <span class="string">&quot;com.android.defcontainer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ComponentName</span> <span class="variable">DEFAULT_CONTAINER_COMPONENT</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(</span><br><span class="line">        DEFAULT_CONTAINER_PACKAGE,</span><br><span class="line">        <span class="string">&quot;com.android.defcontainer.DefaultContainerService&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>来看下这是个什么服务，全局搜索<code>com.android.defcontainer</code>找到对应的AndroidManifest文件，进而找到该组件为frameworks&#x2F;base&#x2F;packages&#x2F;DefaultContainerService中的<code>DefaultContainerService.java</code>来看下这个类的注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Service that offers to inspect and copy files that may reside on removable</span></span><br><span class="line"><span class="comment"> * storage. This is designed to prevent the system process from holding onto</span></span><br><span class="line"><span class="comment"> * open files that cause the kernel to kill it when the underlying device is</span></span><br><span class="line"><span class="comment"> * removed.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>也就是说这个类是用来检测和copy可移除存储（从这里看应该也包括临时文件）的文件的。设计这个类的目的是防止持有这个文件的系统进程在存储设备被移除时被内核杀掉，好了，看来后面的copy操作这个类完成的，知道这么多就够了。</p>
<p>再来看下绑定服务时的ServiceConnection对象是怎么定义的，也就是说服务绑定后会发生什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">private</span> <span class="type">DefaultContainerConnection</span> <span class="variable">mDefContainerConn</span> <span class="operator">=</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">DefaultContainerConnection</span>();</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DefaultContainerConnection</span> <span class="keyword">implements</span> <span class="title class_">ServiceConnection</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">&quot;onServiceConnected&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">IMediaContainerService</span> <span class="variable">imcs</span> <span class="operator">=</span> IMediaContainerService.Stub</span><br><span class="line">                .asInterface(Binder.allowBlocking(service));</span><br><span class="line">        mHandler.sendMessage(mHandler.obtainMessage(MCS_BOUND, imcs));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName name)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SD_INSTALL) Log.i(TAG, <span class="string">&quot;onServiceDisconnected&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务绑定后获得<code>DefaultContainerService</code>服务的本地对象，然后发送MCS_BOUND消息，该消息的obj为服务的对象imcs,该消息是在INIT_COPY消息之后放入消息队列的，所以该消息会在INIT_COPY处理完之后再进行处理，也就是说上面代码中的<code>mPendingInstalls.add(idx, params);</code>会在处理MCS_BOUND消息之前执行。</p>
<p>之后就是在<code>MCS_BOUND</code>消息的处理过程中调用HandlerParams的startCopy()方法开始apk以及lib文件的复制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">startCopy</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> res;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">&quot;startCopy &quot;</span> + mUser + <span class="string">&quot;: &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (++mRetries &gt; MAX_RETRIES) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">&quot;Failed to invoke remote methods on default container service. Giving up&quot;</span>);</span><br><span class="line">            mHandler.sendEmptyMessage(MCS_GIVE_UP);</span><br><span class="line">            handleServiceError();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            handleStartCopy();</span><br><span class="line">            res = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">&quot;Posting install MCS_RECONNECT&quot;</span>);</span><br><span class="line">        mHandler.sendEmptyMessage(MCS_RECONNECT);</span><br><span class="line">        res = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    handleReturnCode();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从这些代码还看不出这里的copy到底是干吗的，再来看下<code>handleStartCopy()</code>方法的注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Invoke remote method to get package information and install</span></span><br><span class="line"><span class="comment"> * location values. Override install location based on default</span></span><br><span class="line"><span class="comment"> * policy if needed and then create install arguments based</span></span><br><span class="line"><span class="comment"> * on the install location.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>从上面的注释来看这里的copy是用来获取package信息和安装位置的信息的，如果有必要的话改变安装位置并根据安装位置创建安装参数。调试时发现并没有走copy的过程，结合<code>DefaultContainerService</code>的注释推测这部分的功能可能和SD的安装有关，<code>handleStartCopy()</code>会调用到<code>FileInstallArgs</code> 的<code>copyApk()</code>方法，最终借由<code>DefaultContainerService</code>完成apk的复制和重命名的过程，再借由<code>NativeLibraryHelper</code>完成native lib的复制。<strong>这部分代码量比较大，目前来看这部分对安装过程的理解帮助不大，所以暂时先不做了解了，目前只是推测可能和安装到sd卡有关系。复制完成后会发送<code>MCS_UNBIND</code>消息解除服务的绑定。</strong></p>
<p>到此，PKMS对应用的复制操作告一段落，接下来进行真正的安装过程。</p>
<ol start="6">
<li>应用安装</li>
</ol>
<p>上面了解了PKMS对apk的复制过程，在该过程结束后会返回安装成功与否（只是该阶段）的结果。上面还没有说这个结果是怎么处理的，这个结果是否成功关系着安装是否能继续下去，所以对结果的处理一就是下一步正式安装的开始。从上面的代码不难看出，该过程是在<code>handleReturnCode()</code>方法中进行的，该方法的实现在HandlerParams的子类InstallParams中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">handleReturnCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// If mArgs is null, then MCS couldn&#x27;t be reached. When it</span></span><br><span class="line">    <span class="comment">// reconnects, it will try again to install. At that point, this</span></span><br><span class="line">    <span class="comment">// will succeed.</span></span><br><span class="line">    <span class="keyword">if</span> (mArgs != <span class="literal">null</span>) &#123;</span><br><span class="line">        processPendingInstall(mArgs, mRet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processPendingInstall</span><span class="params">(<span class="keyword">final</span> InstallArgs args, <span class="keyword">final</span> <span class="type">int</span> currentStatus)</span> &#123;</span><br><span class="line">    <span class="comment">// Queue up an async operation since the package installation may take a little while.</span></span><br><span class="line">    mHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            mHandler.removeCallbacks(<span class="built_in">this</span>);</span><br><span class="line">             <span class="comment">// Result object to be returned</span></span><br><span class="line">            <span class="type">PackageInstalledInfo</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageInstalledInfo</span>();</span><br><span class="line">            res.setReturnCode(currentStatus);</span><br><span class="line">            res.uid = -<span class="number">1</span>;</span><br><span class="line">            res.pkg = <span class="literal">null</span>;</span><br><span class="line">            res.removedInfo = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                args.doPreInstall(res.returnCode);</span><br><span class="line">                <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                    installPackageTracedLI(args, res);</span><br><span class="line">                &#125;</span><br><span class="line">                args.doPostInstall(res.returnCode, res.uid);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// A restore should be performed at this point if (a) the install</span></span><br><span class="line">            <span class="comment">// succeeded, (b) the operation is not an update, and (c) the new</span></span><br><span class="line">            <span class="comment">// package has not opted out of backup participation.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">update</span> <span class="operator">=</span> res.removedInfo != <span class="literal">null</span></span><br><span class="line">                    &amp;&amp; res.removedInfo.removedPackage != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">flags</span> <span class="operator">=</span> (res.pkg == <span class="literal">null</span>) ? <span class="number">0</span> : res.pkg.applicationInfo.flags;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">doRestore</span> <span class="operator">=</span> !update</span><br><span class="line">                    &amp;&amp; ((flags &amp; ApplicationInfo.FLAG_ALLOW_BACKUP) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set up the post-install work request bookkeeping.  This will be used</span></span><br><span class="line">            <span class="comment">// and cleaned up by the post-install event handling regardless of whether</span></span><br><span class="line">            <span class="comment">// there&#x27;s a restore pass performed.  Token values are &gt;= 1.</span></span><br><span class="line">            <span class="type">int</span> token;</span><br><span class="line">            <span class="keyword">if</span> (mNextInstallToken &lt; <span class="number">0</span>) mNextInstallToken = <span class="number">1</span>;</span><br><span class="line">            token = mNextInstallToken++;</span><br><span class="line"></span><br><span class="line">            <span class="type">PostInstallData</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PostInstallData</span>(args, res);</span><br><span class="line">            mRunningInstalls.put(token, data);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">&quot;+ starting restore round-trip &quot;</span> + token);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED &amp;&amp; doRestore) &#123;</span><br><span class="line">                <span class="comment">// Pass responsibility to the Backup Manager.  It will perform a</span></span><br><span class="line">                <span class="comment">// restore if appropriate, then pass responsibility back to the</span></span><br><span class="line">                <span class="comment">// Package Manager to run the post-install observer callbacks</span></span><br><span class="line">                <span class="comment">// and broadcasts.</span></span><br><span class="line">                <span class="type">IBackupManager</span> <span class="variable">bm</span> <span class="operator">=</span> IBackupManager.Stub.asInterface(</span><br><span class="line">                        ServiceManager.getService(Context.BACKUP_SERVICE));</span><br><span class="line">                <span class="keyword">if</span> (bm != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">&quot;token &quot;</span> + token</span><br><span class="line">                            + <span class="string">&quot; to BM for possible restore&quot;</span>);</span><br><span class="line">                    Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;restore&quot;</span>, token);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// <span class="doctag">TODO:</span> http://b/22388012</span></span><br><span class="line">                        <span class="keyword">if</span> (bm.isBackupServiceActive(UserHandle.USER_SYSTEM)) &#123;</span><br><span class="line">                            bm.restoreAtInstall(res.pkg.applicationInfo.packageName, token);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            doRestore = <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        <span class="comment">// can&#x27;t happen; the backup manager is local</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        Slog.e(TAG, <span class="string">&quot;Exception trying to enqueue restore&quot;</span>, e);</span><br><span class="line">                        doRestore = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">&quot;Backup Manager not found!&quot;</span>);</span><br><span class="line">                    doRestore = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!doRestore) &#123;</span><br><span class="line">                <span class="comment">// No restore possible, or the Backup Manager was mysteriously not</span></span><br><span class="line">                <span class="comment">// available -- just fire the post-install work request directly.</span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INSTALL) Log.v(TAG, <span class="string">&quot;No restore - queue post-install for &quot;</span> + token);</span><br><span class="line"></span><br><span class="line">                Trace.asyncTraceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;postInstall&quot;</span>, token);</span><br><span class="line"></span><br><span class="line">                <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(POST_INSTALL, token, <span class="number">0</span>);</span><br><span class="line">                mHandler.sendMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键的地方有两个：</p>
<ul>
<li><code>installPackageTracedLI(args, res);</code></li>
<li>POST_INSTALL消息</li>
</ul>
<p>installPackageTracedLI进行应用的安装，而POST_INSTALL消息对应安装后的操作，比如发送广播告知其他角色进行相应的更新，例如launcher。</p>
<p>先来看下安装的过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installPackageTracedLI</span><span class="params">(InstallArgs args, PackageInstalledInfo res)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;installPackage&quot;</span>);</span><br><span class="line">        installPackageLI(args, res);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>installPackageLI</code>代码量较多就不全贴出来了，大致记录下这个方法做了些什么事：</p>
<ul>
<li><p>确定scanFlags的值</p>
</li>
<li><p>包解析生成Package对象<code>pkg = pp.parsePackage(tmpPackageFile, parseFlags);</code></p>
</li>
<li><p>更新pkg的信息，包括cpuAbiOverride，签名，证书，packageName，权限等内容，另外如果该应用已经存在，需要根据原有信息判断安装的apk是否与原apk兼容，包括包名以及是否是降级安装等，并将正在安装的应用包名改为和已有应用一致。</p>
</li>
<li><p>获取abi信息，更新sharedLibraries信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (args.move != <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="comment">//……</span></span><br><span class="line">    <span class="comment">// We did an in-place move, so dex is ready to roll</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!forwardLocked &amp;&amp; !pkg.applicationInfo.isExternalAsec()) &#123;</span><br><span class="line">    <span class="comment">// Enable SCAN_NO_DEX flag to skip dexopt at a later stage</span></span><br><span class="line">    scanFlags |= SCAN_NO_DEX;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">abiOverride</span> <span class="operator">=</span> (TextUtils.isEmpty(pkg.cpuAbiOverride) ?</span><br><span class="line">            args.abiOverride : pkg.cpuAbiOverride);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">extractNativeLibs</span> <span class="operator">=</span> !pkg.isLibrary();</span><br><span class="line">        derivePackageAbi(pkg, <span class="keyword">new</span> <span class="title class_">File</span>(pkg.codePath), abiOverride,</span><br><span class="line">                extractNativeLibs, mAppLib32InstallDir);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManagerException pme) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">&quot;Error deriving application ABI&quot;</span>, pme);</span><br><span class="line">        res.setError(INSTALL_FAILED_INTERNAL_ERROR, <span class="string">&quot;Error deriving application ABI&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Shared libraries for the package need to be updated.</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            updateSharedLibrariesLPr(pkg, <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">&quot;updateAllSharedLibrariesLPw failed: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>应用文件夹重命名，并更新pkg中的相关信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!args.doRename(res.returnCode, pkg, oldCodePath)) &#123;</span><br><span class="line">    res.setError(INSTALL_FAILED_INSUFFICIENT_STORAGE, <span class="string">&quot;Failed rename&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后应用所在的文件夹更名为类似于“com.u17.comic.phone-u3tLbNr2Lkty3W30ltXxFQ&#x3D;&#x3D;”的形式，该目录仍位于&#x2F;data&#x2F;app&#x2F;下。</p>
</li>
<li><p>需要的话，进行odex优化</p>
</li>
<li><p>验证IntentFilter<code>startIntentFilterVerifications(args.user.getIdentifier(), replace, pkg);</code></p>
</li>
<li><p>杀掉对应应用（如果该应用存在），调用<code>replacePackageLIF</code>替换已有应用或者调用<code>installNewPackageLIF</code>安装新的应用。现在只关心新应用的安装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installNewPackageLIF</span><span class="params">(PackageParser.Package pkg, <span class="keyword">final</span> <span class="type">int</span> policyFlags,</span></span><br><span class="line"><span class="params">          <span class="type">int</span> scanFlags, UserHandle user, String installerPackageName, String volumeUuid,</span></span><br><span class="line"><span class="params">          PackageInstalledInfo res, <span class="type">int</span> installReason)</span> &#123;</span><br><span class="line">      Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">&quot;installNewPackage&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Remember this for later, in case we need to rollback this install</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">pkgName</span> <span class="operator">=</span> pkg.packageName;</span><br><span class="line"><span class="comment">//检测是否是新应用，若不是则退出并保存错误信息</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          PackageParser.<span class="type">Package</span> <span class="variable">newPackage</span> <span class="operator">=</span> scanPackageTracedLI(pkg, policyFlags, scanFlags,</span><br><span class="line">                  System.currentTimeMillis(), user);</span><br><span class="line"></span><br><span class="line">          updateSettingsLI(newPackage, installerPackageName, <span class="literal">null</span>, res, user, installReason);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">              prepareAppDataAfterInstallLIF(newPackage);</span><br><span class="line"></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// Remove package from internal structures, but keep around any</span></span><br><span class="line">              <span class="comment">// data that might have already existed</span></span><br><span class="line">              deletePackageLIF(pkgName, UserHandle.ALL, <span class="literal">false</span>, <span class="literal">null</span>,</span><br><span class="line">                      PackageManager.DELETE_KEEP_DATA, res.removedInfo, <span class="literal">true</span>, <span class="literal">null</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">          res.setError(<span class="string">&quot;Package couldn&#x27;t be installed in &quot;</span> + pkg.codePath, e);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>关键的代码有三行：</p>
<ul>
<li><p><code>PackageParser.Package newPackage = scanPackageTracedLI(pkg, policyFlags, scanFlags,  System.currentTimeMillis(), user);</code>用来扫描pkg的信息，这部分在开机安装应用部分已经了解过了，主要就是更新PKMS中的PackageSetting等信息，并将包的信息添加到系统中，之后该包的信息就可以被查询和解析了。</p>
</li>
<li><p><code> updateSettingsLI(newPackage, installerPackageName, null, res, user, installReason);</code>更新mSettings中的信息，并写入到packages.xml中，这样再次开机就可以直接从该文件读取应用信息。</p>
</li>
<li><p><code> prepareAppDataAfterInstallLIF(newPackage);</code>准备应用的数据。</p>
<p>​</p>
</li>
</ul>
</li>
</ul>
<p>到这里<code>installPackageTracedLI(args, res);</code> 的工作就结束了，接下来要做的就是通知系统的其他角色应用已经安装完成，该工作是在对<code>POST_INSTALL</code>消息中进行处理的,为了节省控件就不贴这部分代码了，该消息的处理过程关键是调用<code>handlePackagePostInstall</code>方法。该方法的主要工作如下：</p>
<ul>
<li><p>授予应用权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Now that we successfully installed the package, grant runtime</span></span><br><span class="line"><span class="comment">// permissions if requested before broadcasting the install. Also</span></span><br><span class="line"><span class="comment">// for legacy apps in permission review mode we clear the permission</span></span><br><span class="line"><span class="comment">// review flag which is used to emulate runtime permissions for</span></span><br><span class="line"><span class="comment">// legacy apps.</span></span><br><span class="line"><span class="keyword">if</span> (grantPermissions) &#123;<span class="comment">//安装时带-g参数</span></span><br><span class="line">    grantRequestedRuntimePermissions(res.pkg, res.newUsers, grantedPermissions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>发送广播，其中包括<code>ACTION_PACKAGE_ADDED</code>和<code>ACTION_PACKAGE_REPLACED</code>等</p>
</li>
<li><p>调用installObserver的onPackageInstalled方法，installObserver是之前从InstallArgs中传递过来的，该回调中会发送ACTION_SESSION_COMMITTED广播，launcher会接受该广播，并更新应用的信息。</p>
</li>
</ul>
<p>广播的处理涉及到Launcher和PackageInstall等应用，这里暂时不做了解了，等以后有机会再说～～～</p>
<p><strong>adb安装应用大致过程：</strong></p>
<p>​	adb命令解析 : cmd.cpp -  PKMS - PackageManagerShellCommand</p>
<p>​		-&gt; 参数解析 ： InstallParams</p>
<p>​		-&gt;  创建session: PackageInstallerService - PackageInstallSession</p>
<p>​		-&gt; 应用复制到临时目录 </p>
<p>​		-&gt; 提交session： 更新进度，提取nativelib, 添加回调</p>
<p>​		-&gt;  应用安装：文件夹重命名，添加&#x2F;更新应用信息到系统</p>
<p>​		-&gt; 发送广播，调用回调，通知应用安装完成。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/07/28/ABI%E7%A1%AE%E5%AE%9A%E8%BF%87%E7%A8%8B/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          ABI确定过程
        
      </div>
    </a>
  
  
    <a href="/2018/07/26/Android%20%E2%80%9Coriginal-package%E2%80%9D%20%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">Android “original-package” 机制解析</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#adb%E6%96%B9%E5%BC%8F%E8%BF%9B%E8%A1%8C%E5%AE%89%E8%A3%85"><span class="nav-number">1.</span> <span class="nav-text">adb方式进行安装</span></a></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2018 - 2022 得一 All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/scripts.js"></script>



  
<script src="/js/home.js"></script>




  
<script src="/js/dialog.js"></script>










	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            得一
          </div>
          <div class="panel-body">
            Copyright © 2022 me All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>