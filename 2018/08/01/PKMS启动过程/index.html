<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>pkms启动过程 | 得一</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="PackageManagerServicePKMSAndroid系统服务">
  
  
  
  
  <meta name="description" content="PKMS启动过程参考：https://blog.csdn.net/u012124438/article/details/54882771 PackageManagerService，是Android系统中核心服务之一，管理着所有跟package相关的工作。Android是基于mashup（混搭）的风格设计的，程序是由一个个的组件拼凑起来的，而PackageManagerService的任务就是解析">
<meta name="keywords" content="PackageManagerService,PKMS,Android系统服务">
<meta property="og:type" content="article">
<meta property="og:title" content="PKMS启动过程">
<meta property="og:url" content="https://mouzishuo.github.io/2018/08/01/PKMS启动过程/index.html">
<meta property="og:site_name" content="得一">
<meta property="og:description" content="PKMS启动过程参考：https://blog.csdn.net/u012124438/article/details/54882771 PackageManagerService，是Android系统中核心服务之一，管理着所有跟package相关的工作。Android是基于mashup（混搭）的风格设计的，程序是由一个个的组件拼凑起来的，而PackageManagerService的任务就是解析">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://img-blog.csdn.net/20170205194259468?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMjEyNDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast">
<meta property="og:updated_time" content="2019-01-16T01:14:47.496Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PKMS启动过程">
<meta name="twitter:description" content="PKMS启动过程参考：https://blog.csdn.net/u012124438/article/details/54882771 PackageManagerService，是Android系统中核心服务之一，管理着所有跟package相关的工作。Android是基于mashup（混搭）的风格设计的，程序是由一个个的组件拼凑起来的，而PackageManagerService的任务就是解析">
<meta name="twitter:image" content="https://img-blog.csdn.net/20170205194259468?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMjEyNDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast">
  

  

  <link rel="icon" href="/css/images/avatar.jpg">
  <link rel="apple-touch-icon" href="/css/images/avatar.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">

  
    <link rel="stylesheet" href="/css/dialog.css">
  

  

  
    <link rel="stylesheet" href="/css/header-post.css">
  

  
  
  

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  
  <div id="container">
    <div id="wrap">
      
        <header>

    <div id="allheader" class="navbar navbar-default navbar-static-top" role="navigation">
        <div class="navbar-inner">
          
          <div class="container"> 
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>

            
              <a class="brand" style="
                 margin-top: 5px;" href="#" data-toggle="modal" data-target="#myModal">
                  <img width="93px" height="93px" alt="Hike News" src="/css/images/avatar.jpg">
              </a>
            
            
            <div class="navbar-collapse collapse">
              <ul class="hnav navbar-nav">
                
                  <li> <a class="main-nav-link" href="/">首页</a> </li>
                
                  <li> <a class="main-nav-link" href="/archives">归档</a> </li>
                
                  <li> <a class="main-nav-link" href="/categories">分类</a> </li>
                
                  <li> <a class="main-nav-link" href="/tags">标签</a> </li>
                
                  <li><div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div></li>
            </ul></div>
          </div>
                
      </div>
    </div>

</header>



      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-PKMS启动过程" style="width: 75%; float:left;" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      PKMS启动过程
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/08/01/PKMS启动过程/" class="article-date">
	  <time datetime="2018-08-01T06:23:08.000Z" itemprop="datePublished">2018-08-01</time>
	</a>

      
    <a class="article-category-link" href="/categories/Android/">Android</a>

      
	<a class="article-views">
	<span id="busuanzi_container_page_pv">
		阅读量<span id="busuanzi_value_page_pv"></span>
	</span>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="PKMS启动过程"><a href="#PKMS启动过程" class="headerlink" title="PKMS启动过程"></a>PKMS启动过程</h1><p>参考：<a href="https://blog.csdn.net/u012124438/article/details/54882771" target="_blank" rel="noopener">https://blog.csdn.net/u012124438/article/details/54882771</a></p>
<p>PackageManagerService，是Android系统中核心服务之一，管理着所有跟package相关的工作。Android是基于mashup（混搭）的风格设计的，程序是由一个个的组件拼凑起来的，而PackageManagerService的任务就是解析package，然后把其中的组件信息一个个的拆解出来把相关信息放到内存里，当然还要处理package中的其他东西，比如库文件什么的。在程序需要的时候组件管理器（AMS）会向PKMS查询组件信息，然后创建相应的组件并进行管理。</p>
<p>PKMS涉及的内容比较多，常见的比如安装、卸载应用、应用解析，查询应用信息等。 PKMS服务也是通过binder进行通信，IPackageManager.aidl由工具转换后自动生成binder的服务端IPackageManager.Stub和客户端IPackageManager.Stub.Proxy，具体关系如下： </p>
<p><img src="https://img-blog.csdn.net/20170205194259468?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMjEyNDQzOA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt=""></p>
<p>Binder服务端：PackageManagerService继承于IPackageManager.Stub；<br>Binder客户端：ApplicationPackageManager(简称APM)的成员变量mPM继承于IPackageManager.Stub.Proxy; 本身APM是继承于PackageManager对象。</p>
<p>首先先来看下PKMS的注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Keep track of all those APKs everywhere.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Internally there are two important locks:</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> #mPackages&#125; is used to guard all in-memory parsed package details</span></span><br><span class="line"><span class="comment"> * and other related state. It is a fine-grained lock that should only be held</span></span><br><span class="line"><span class="comment"> * momentarily, as it's one of the most contended locks in the system.</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;&#123;<span class="doctag">@link</span> #mInstallLock&#125; is used to guard all &#123;<span class="doctag">@code</span> installd&#125; access, whose</span></span><br><span class="line"><span class="comment"> * operations typically involve heavy lifting of application data on disk. Since</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> installd&#125; is single-threaded, and it's operations can often be slow,</span></span><br><span class="line"><span class="comment"> * this lock should never be acquired while already holding &#123;<span class="doctag">@link</span> #mPackages&#125;.</span></span><br><span class="line"><span class="comment"> * Conversely, it's safe to acquire &#123;<span class="doctag">@link</span> #mPackages&#125; momentarily while already</span></span><br><span class="line"><span class="comment"> * holding &#123;<span class="doctag">@link</span> #mInstallLock&#125;.</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> * Many internal methods rely on the caller to hold the appropriate locks, and</span></span><br><span class="line"><span class="comment"> * this contract is expressed through method name suffixes:</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;fooLI(): the caller must hold &#123;<span class="doctag">@link</span> #mInstallLock&#125;</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;fooLIF(): the caller must hold &#123;<span class="doctag">@link</span> #mInstallLock&#125; and the package</span></span><br><span class="line"><span class="comment"> * being modified must be frozen</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;fooLPr(): the caller must hold &#123;<span class="doctag">@link</span> #mPackages&#125; for reading</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;fooLPw(): the caller must hold &#123;<span class="doctag">@link</span> #mPackages&#125; for writing</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Because this class is very central to the platform's security; please run all</span></span><br><span class="line"><span class="comment"> * CTS and unit tests whenever making modifications:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * $ runtest -c android.content.pm.PackageManagerTests frameworks-core</span></span><br><span class="line"><span class="comment"> * $ cts-tradefed run commandAndExit cts -m CtsAppSecurityHostTestCases</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p><code>mPackages</code>同步锁，是指操作<code>mPackages</code>时，用<code>synchronized (mPackages) {}</code>保护起来。<code>mPackages</code>同步锁用来<strong>保护内存中已经解析的包信息和其他相关状态</strong>。<code>mPackages</code>同步锁是细粒度的锁，只能短时间持有这个锁，因为争抢<code>mPackages</code>锁的请求很多，短时间持有<code>mPackages</code>锁，可以让其他请求等待的时间短些。</p>
<p><code>mInstallLock</code>同步锁，是指安装App的时候，对安装的处理要用<code>synchronized (mInstaller) {}</code>保护起来。<strong>mInstallLock同步锁，用来保护所有对installd的访问。</strong><code>installd</code>通常包含对应用数据的繁重操作。</p>
<p>由于<code>installd</code>是单线程的，并且<code>installd</code>的操作通常很慢，所以在已经持有<code>mPackages</code>同步锁的时候，千万不要再请求<code>mInstallLock</code>同步锁。反之，<code>在已经持有mInstallLock</code>同步锁的时候，可以去请求<code>mPackages</code>同步锁。</p>
<p>PKMS中的很多方法带有LI、LIF、LPw、LPr等后缀，LI、LIF、LPw、LPr中的L，指的是Lock，而后面跟的I和P指的是两个锁，I表示<code>mInstallLock</code>同步锁。P表示<code>mPackages</code>同步锁。LPw、LPr中的w表示writing，r表示reading。LIF中的F表示Freeze。</p>
<p>该部分也可参考<a href="https://blog.csdn.net/u013553529/article/details/61962439。" target="_blank" rel="noopener">https://blog.csdn.net/u013553529/article/details/61962439。</a></p>
<h2 id="1-PKMS启动过程"><a href="#1-PKMS启动过程" class="headerlink" title="1. PKMS启动过程"></a>1. PKMS启动过程</h2><p>PKMS和其它系统服务一样是在SystemServer中启动的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Starts the small tangle of critical services that are needed to get</span></span><br><span class="line"><span class="comment">   * the system off the ground.  These services have complex mutual dependencies</span></span><br><span class="line"><span class="comment">   * which is why we initialize them all in one place here.  Unless your service</span></span><br><span class="line"><span class="comment">   * is also entwined in these dependencies, it should be initialized in one of</span></span><br><span class="line"><span class="comment">   * the other functions.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;<span class="comment">//Bootstrap：引导，启动引导服务</span></span><br><span class="line"><span class="comment">//……</span></span><br><span class="line">      <span class="comment">// Wait for installd to finish starting up so that it has a chance to</span></span><br><span class="line">      <span class="comment">// create critical directories such as /data/user with the appropriate</span></span><br><span class="line">      <span class="comment">// permissions.  We need this to complete before we initialize other services.</span></span><br><span class="line">      traceBeginAndSlog(<span class="string">"StartInstaller"</span>);</span><br><span class="line">      Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class="line">      traceEnd();</span><br><span class="line">      <span class="comment">//……</span></span><br><span class="line">      <span class="comment">// Only run "core" apps if we're encrypting the device.</span></span><br><span class="line">      String cryptState = SystemProperties.get(<span class="string">"vold.decrypt"</span>);</span><br><span class="line">      <span class="keyword">if</span> (ENCRYPTING_STATE.equals(cryptState)) &#123;</span><br><span class="line">          Slog.w(TAG, <span class="string">"Detected encryption in progress - only parsing core apps"</span>);</span><br><span class="line">          mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ENCRYPTED_STATE.equals(cryptState)) &#123;</span><br><span class="line">          Slog.w(TAG, <span class="string">"Device encrypted - only parsing core apps"</span>);</span><br><span class="line">          mOnlyCore = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Start the package manager.</span></span><br><span class="line">      <span class="keyword">if</span> (!mRuntimeRestart) &#123;</span><br><span class="line">          MetricsLogger.histogram(<span class="keyword">null</span>, <span class="string">"boot_package_manager_init_start"</span>,</span><br><span class="line">                  (<span class="keyword">int</span>) SystemClock.elapsedRealtime());</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">      traceBeginAndSlog(<span class="string">"StartPackageManagerService"</span>);</span><br><span class="line">      mPackageManagerService = PackageManagerService.main(mSystemContext, installer,</span><br><span class="line">              mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore);</span><br><span class="line">      mFirstBoot = mPackageManagerService.isFirstBoot();</span><br><span class="line">      mPackageManager = mSystemContext.getPackageManager();</span><br><span class="line">      traceEnd();</span><br><span class="line">      <span class="comment">//……</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>startBootstrapServices中启动的是系统中最关键的一批服务，所以也是在SystemServer中最先启动的一批服务。</p>
<p>SystemServer通过调用PKSM的main方法创建并启动PKMS服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title">main</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Self-check for initial settings.</span></span><br><span class="line">    PackageManagerServiceCompilerMapping.checkProperties();</span><br><span class="line"></span><br><span class="line">    PackageManagerService m = <span class="keyword">new</span> PackageManagerService(context, installer,</span><br><span class="line">            factoryTest, onlyCore);</span><br><span class="line">    m.enableSystemUserPackages();</span><br><span class="line">    ServiceManager.addService(<span class="string">"package"</span>, m);</span><br><span class="line">    <span class="keyword">final</span> PackageManagerNative pmn = m.new PackageManagerNative();</span><br><span class="line">    ServiceManager.addService(<span class="string">"package_native"</span>, pmn);</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先是PKMS的初始化过程：<code>PackageManagerService m = new PackageManagerService(context, installer,        factoryTest, onlyCore);</code>。</p>
<h3 id="1-1-PKMS构造过程"><a href="#1-1-PKMS构造过程" class="headerlink" title="1.1 PKMS构造过程"></a>1.1 PKMS构造过程</h3><p>Android系统提供了一种诊断工具来记录系统级的事件，该工具就是EventLog。PKMS的创建过程也通过EventLog进行了记录。根据EventLog来看，PKMS的创建可以分为5个阶段：</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;BOOT_PROGRESS_PMS_START</span><br><span class="line">&gt;BOOT_PROGRESS_PMS_SYSTEM_SCAN_START</span><br><span class="line">&gt;BOOT_PROGRESS_PMS_DATA_SCAN_START</span><br><span class="line">&gt;BOOT_PROGRESS_PMS_SCAN_END</span><br><span class="line">&gt;BOOT_PROGRESS_PMS_READY</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="阶段1：BOOT-PROGRESS-PMS-START"><a href="#阶段1：BOOT-PROGRESS-PMS-START" class="headerlink" title="阶段1：BOOT_PROGRESS_PMS_START"></a>阶段1：BOOT_PROGRESS_PMS_START</h4><p>该阶段代码如下，其中成员初始化的部分代码省略掉了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">    EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START,</span><br><span class="line">            SystemClock.uptimeMillis());</span><br><span class="line"> <span class="comment">// ……</span></span><br><span class="line">   <span class="comment">//构造Settings对象存储运行时的设置信息</span></span><br><span class="line">    mSettings = <span class="keyword">new</span> Settings(mPackages);</span><br><span class="line"><span class="comment">//添加系统的shareUID</span></span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">"android.uid.system"</span>, Process.SYSTEM_UID,</span><br><span class="line">            ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">"android.uid.phone"</span>, RADIO_UID,</span><br><span class="line">            ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">"android.uid.log"</span>, LOG_UID,</span><br><span class="line">            ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">"android.uid.nfc"</span>, NFC_UID,</span><br><span class="line">            ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">"android.uid.bluetooth"</span>, BLUETOOTH_UID,</span><br><span class="line">            ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">    mSettings.addSharedUserLPw(<span class="string">"android.uid.shell"</span>, SHELL_UID,</span><br><span class="line">            ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">    <span class="comment">//……</span></span><br><span class="line">    SystemConfig systemConfig = SystemConfig.getInstance();</span><br><span class="line"> <span class="comment">//……</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">    <span class="comment">// writer</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">		<span class="comment">//……</span></span><br><span class="line">        <span class="comment">// 添加内置权限配置到mSettings</span></span><br><span class="line">        <span class="comment">// Propagate permission configuration in to package manager.</span></span><br><span class="line">        ArrayMap&lt;String, SystemConfig.PermissionEntry&gt; permConfig</span><br><span class="line">                = systemConfig.getPermissions();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;permConfig.size(); i++) &#123;</span><br><span class="line">            SystemConfig.PermissionEntry perm = permConfig.valueAt(i);</span><br><span class="line">            BasePermission bp = mSettings.mPermissions.get(perm.name);</span><br><span class="line">            <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;<span class="comment">//android（framework-res.apk）这个应用拥有所有权限？</span></span><br><span class="line">                bp = <span class="keyword">new</span> BasePermission(perm.name, <span class="string">"android"</span>, BasePermission.TYPE_BUILTIN);</span><br><span class="line">                mSettings.mPermissions.put(perm.name, bp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (perm.gids != <span class="keyword">null</span>) &#123;</span><br><span class="line">                bp.setGids(perm.gids, perm.perUser);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取SharedLibraries信息</span></span><br><span class="line">        ArrayMap&lt;String, String&gt; libConfig = systemConfig.getSharedLibraries();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> builtInLibCount = libConfig.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; builtInLibCount; i++) &#123;</span><br><span class="line">            String name = libConfig.keyAt(i);</span><br><span class="line">            String path = libConfig.valueAt(i);</span><br><span class="line">            addSharedLibraryLPw(path, <span class="keyword">null</span>, name, SharedLibraryInfo.VERSION_UNDEFINED,</span><br><span class="line">                    SharedLibraryInfo.TYPE_BUILTIN, PLATFORM_PACKAGE_NAME, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mFoundPolicyFile = SELinuxMMAC.readInstallPolicy();</span><br><span class="line"></span><br><span class="line">        Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"read user settings"</span>);</span><br><span class="line">        <span class="comment">//尝试读取packages.xml内容，读取不到或者读取失败则判定为首次启动</span></span><br><span class="line">        mFirstBoot = !mSettings.readLPw(sUserManager.getUsers(<span class="keyword">false</span>));</span><br><span class="line">        Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line">        <span class="comment">// Clean up orphaned packages for which the code path doesn't exist</span></span><br><span class="line">        <span class="comment">// and they are an update to a system app - caused by bug/32321269</span></span><br><span class="line">        <span class="comment">//第一次启动时还没有生成packages.xml所以packageSettingCount为0</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> packageSettingCount = mSettings.mPackages.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = packageSettingCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line">            <span class="keyword">if</span> (!isExternal(ps) &amp;&amp; (ps.codePath == <span class="keyword">null</span> || !ps.codePath.exists())</span><br><span class="line">                    &amp;&amp; mSettings.getDisabledSystemPkgLPr(ps.name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mSettings.mPackages.removeAt(i);</span><br><span class="line">                mSettings.enableSystemPackageLPw(ps.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//等到dex文件拷贝完成，实际copy是在/system/extras/cppreopts/cppreopts.rc进行的</span></span><br><span class="line">        <span class="keyword">if</span> (mFirstBoot) &#123;</span><br><span class="line">            requestCopyPreoptedFiles();</span><br><span class="line">        &#125;</span><br><span class="line">   <span class="comment">//自定义的Intent resolver         </span></span><br><span class="line">        String customResolverActivity = Resources.getSystem().getString(</span><br><span class="line">                R.string.config_customResolverActivity);</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(customResolverActivity)) &#123;</span><br><span class="line">            customResolverActivity = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mCustomResolverComponentName = ComponentName.unflattenFromString(</span><br><span class="line">                    customResolverActivity);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>第一阶段前半部分没加锁，后半部分是在加锁的代码块里的。总的来说第一阶段主要做了这几件事：初始化成员变量、添加系统SharedUID信息到mSettings、加载权限信息、获取SharedLibraries信息以及清除找不到的package信息。</p>
<p>关键的变量有两个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mSettings = <span class="keyword">new</span> Settings(mPackages);<span class="comment">//对应packages.xml文件</span></span><br><span class="line">SystemConfig systemConfig = SystemConfig.getInstance();</span><br></pre></td></tr></table></figure>
<p>先来看下Setting的构造过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Settings(Object lock) &#123;</span><br><span class="line">    <span class="keyword">this</span>(Environment.getDataDirectory(), lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Settings(File dataDir, Object lock) &#123;</span><br><span class="line">    mLock = lock;</span><br><span class="line"></span><br><span class="line">    mRuntimePermissionsPersistence = <span class="keyword">new</span> RuntimePermissionPersistence(mLock);</span><br><span class="line"></span><br><span class="line">    mSystemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</span><br><span class="line">    mSystemDir.mkdirs();</span><br><span class="line">    FileUtils.setPermissions(mSystemDir.toString(),</span><br><span class="line">            FileUtils.S_IRWXU|FileUtils.S_IRWXG</span><br><span class="line">            |FileUtils.S_IROTH|FileUtils.S_IXOTH,</span><br><span class="line">            -<span class="number">1</span>, -<span class="number">1</span>);</span><br><span class="line">    mSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.xml"</span>);</span><br><span class="line">    mBackupSettingsFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-backup.xml"</span>);</span><br><span class="line">    mPackageListFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages.list"</span>);</span><br><span class="line">    FileUtils.setPermissions(mPackageListFilename, <span class="number">0640</span>, SYSTEM_UID, PACKAGE_INFO_GID);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> File kernelDir = <span class="keyword">new</span> File(<span class="string">"/config/sdcardfs"</span>);</span><br><span class="line">    mKernelMappingFilename = kernelDir.exists() ? kernelDir : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Deprecated: Needed for migration</span></span><br><span class="line">    mStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped.xml"</span>);</span><br><span class="line">    mBackupStoppedPackagesFilename = <span class="keyword">new</span> File(mSystemDir, <span class="string">"packages-stopped-backup.xml"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要是指定Settings相关的文件路径。Settings中保存了package的相关信息，包括应用本身信息和AndroidManifest.xml中的信息。Settings中保存了各个包的PackageSetting信息，PackageSetting继承自PackageSettingBase，PackageSettingBase又继承自SettingBase，PackageSetting中保存了一个PackageParser.Package的引用（保存从apk中解析出的信息），而该Package对象由持有一个ApplicationInfo对象（对应于AndroidManifest.xml中的application标签）的引用。</p>
<p>再来看下SettingConfig的创建过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SystemConfig <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">synchronized</span> (SystemConfig.class) &#123;</span><br><span class="line">         <span class="keyword">if</span> (sInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">             sInstance = <span class="keyword">new</span> SystemConfig();</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> sInstance;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line">SystemConfig() &#123;</span><br><span class="line">     <span class="comment">// Read configuration from system</span></span><br><span class="line">     readPermissions(Environment.buildPath(</span><br><span class="line">             Environment.getRootDirectory(), <span class="string">"etc"</span>, <span class="string">"sysconfig"</span>), ALLOW_ALL);</span><br><span class="line">     <span class="comment">// Read configuration from the old permissions dir</span></span><br><span class="line">     readPermissions(Environment.buildPath(</span><br><span class="line">             Environment.getRootDirectory(), <span class="string">"etc"</span>, <span class="string">"permissions"</span>), ALLOW_ALL);</span><br><span class="line">     <span class="comment">// Allow Vendor to customize system configs around libs, features, permissions and apps</span></span><br><span class="line">     <span class="keyword">int</span> vendorPermissionFlag = ALLOW_LIBS | ALLOW_FEATURES | ALLOW_PERMISSIONS |</span><br><span class="line">             ALLOW_APP_CONFIGS;</span><br><span class="line">     readPermissions(Environment.buildPath(</span><br><span class="line">             Environment.getVendorDirectory(), <span class="string">"etc"</span>, <span class="string">"sysconfig"</span>), vendorPermissionFlag);</span><br><span class="line">     readPermissions(Environment.buildPath(</span><br><span class="line">             Environment.getVendorDirectory(), <span class="string">"etc"</span>, <span class="string">"permissions"</span>), vendorPermissionFlag);</span><br><span class="line">     <span class="comment">// Allow ODM to customize system configs around libs, features and apps</span></span><br><span class="line">     <span class="keyword">int</span> odmPermissionFlag = ALLOW_LIBS | ALLOW_FEATURES | ALLOW_APP_CONFIGS;</span><br><span class="line">     readPermissions(Environment.buildPath(</span><br><span class="line">             Environment.getOdmDirectory(), <span class="string">"etc"</span>, <span class="string">"sysconfig"</span>), odmPermissionFlag);</span><br><span class="line">     readPermissions(Environment.buildPath(</span><br><span class="line">             Environment.getOdmDirectory(), <span class="string">"etc"</span>, <span class="string">"permissions"</span>), odmPermissionFlag);</span><br><span class="line">     <span class="comment">// Only allow OEM to customize features</span></span><br><span class="line">     readPermissions(Environment.buildPath(</span><br><span class="line">             Environment.getOemDirectory(), <span class="string">"etc"</span>, <span class="string">"sysconfig"</span>), ALLOW_FEATURES);</span><br><span class="line">     readPermissions(Environment.buildPath(</span><br><span class="line">             Environment.getOemDirectory(), <span class="string">"etc"</span>, <span class="string">"permissions"</span>), ALLOW_FEATURES);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>readPermissions()解析指定目录下的所有xml文件，所以，SystemConfig创建过程是对以下这六个目录中的所有xml进行解析来完成的。</p>
<blockquote>
<p>/system/etc/sysconfig<br>/system/etc/permissions<br>/vendor/etc/sysconfig<br>/vendor/etc/permissions<br>/oem/etc/sysconfig<br>/oem/etc/permissions</p>
</blockquote>
<p>权限分两类，存储在两个不同的变量中，<code>final SparseArray&lt;ArraySet&lt;String&gt;&gt; mSystemPermissions</code>表示系统权限，是一个uid到权限的映射，<code>final ArrayMap&lt;String, PermissionEntry&gt; mPermissions = new ArrayMap&lt;&gt;();</code>gid到权限的映射。系统权限在文件中的attribute为assign-permission，比如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">platform.xml</span><br><span class="line">144:    &lt;assign-permission name="android.permission.MODIFY_AUDIO_SETTINGS" uid="media" /&gt;</span><br><span class="line">151:    &lt;assign-permission name="android.permission.MODIFY_AUDIO_SETTINGS" uid="audioserver" /&gt;</span><br><span class="line">170:    &lt;assign-permission name="android.permission.PACKAGE_USAGE_STATS" uid="incidentd" /&gt;</span><br><span class="line">172:    &lt;assign-permission name="android.permission.ACCESS_LOWPAN_STATE" uid="lowpan" /&gt;</span><br><span class="line">177:    &lt;assign-permission name="android.permission.STATSCOMPANION" uid="statsd" /&gt;</span><br></pre></td></tr></table></figure>
<p>mPermissions在xml中对应的attribute为permissions：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">"android.permission.INTERNET"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">"inet"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">"android.permission.READ_LOGS"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">"log"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="阶段2：BOOT-PROGRESS-PMS-SYSTEM-SCAN-START"><a href="#阶段2：BOOT-PROGRESS-PMS-SYSTEM-SCAN-START" class="headerlink" title="阶段2：BOOT_PROGRESS_PMS_SYSTEM_SCAN_START"></a>阶段2：<strong>BOOT_PROGRESS_PMS_SYSTEM_SCAN_START</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line">      EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SYSTEM_SCAN_START,</span><br><span class="line">              startTime);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> String bootClassPath = System.getenv(<span class="string">"BOOTCLASSPATH"</span>);</span><br><span class="line">      <span class="keyword">final</span> String systemServerClassPath = System.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</span><br><span class="line">      <span class="comment">//……</span></span><br><span class="line">      <span class="comment">//system/framework/</span></span><br><span class="line">      File frameworkDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"framework"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> VersionInfo ver = mSettings.getInternalVersion();</span><br><span class="line">      mIsUpgrade = !Build.FINGERPRINT.equals(ver.fingerprint);</span><br><span class="line">      <span class="comment">//……</span></span><br><span class="line">      <span class="comment">// Set flag to monitor and not change apk file paths when</span></span><br><span class="line">      <span class="comment">// scanning install directories.</span></span><br><span class="line">      <span class="keyword">int</span> scanFlags = SCAN_BOOTING | SCAN_INITIAL;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (mIsUpgrade || mFirstBoot) &#123;</span><br><span class="line">          scanFlags = scanFlags | SCAN_FIRST_BOOT_OR_UPGRADE;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Collect vendor overlay packages. (Do this before scanning any apps.)</span></span><br><span class="line">      <span class="comment">// For security and version matching reason, only consider</span></span><br><span class="line">      <span class="comment">// overlay packages if they reside in the right directory.</span></span><br><span class="line">      scanDirTracedLI(<span class="keyword">new</span> File(VENDOR_OVERLAY_DIR), mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">              | PackageParser.PARSE_TRUSTED_OVERLAY, scanFlags | SCAN_TRUSTED_OVERLAY, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      mParallelPackageParserCallback.findStaticOverlayPackages();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Find base frameworks (resource packages without code).</span></span><br><span class="line">      scanDirTracedLI(frameworkDir, mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">              | PackageParser.PARSE_IS_PRIVILEGED,</span><br><span class="line">              scanFlags | SCAN_NO_DEX, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Collected privileged system packages.</span></span><br><span class="line">      <span class="keyword">final</span> File privilegedAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"priv-app"</span>);</span><br><span class="line">      scanDirTracedLI(privilegedAppDir, mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">              | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Collect ordinary system packages.</span></span><br><span class="line">      <span class="keyword">final</span> File systemAppDir = <span class="keyword">new</span> File(Environment.getRootDirectory(), <span class="string">"app"</span>);</span><br><span class="line">      scanDirTracedLI(systemAppDir, mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Collect all vendor packages.</span></span><br><span class="line">      File vendorAppDir = <span class="keyword">new</span> File(<span class="string">"/vendor/app"</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          vendorAppDir = vendorAppDir.getCanonicalFile();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          <span class="comment">// failed to look up canonical path, continue with original one</span></span><br><span class="line">      &#125;</span><br><span class="line">      scanDirTracedLI(vendorAppDir, mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Collect all OEM packages.</span></span><br><span class="line">      <span class="keyword">final</span> File oemAppDir = <span class="keyword">new</span> File(Environment.getOemDirectory(), <span class="string">"app"</span>);</span><br><span class="line">      scanDirTracedLI(oemAppDir, mDefParseFlags</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">              | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Prune any system packages that no longer exist.</span></span><br><span class="line">      <span class="keyword">final</span> List&lt;String&gt; possiblyDeletedUpdatedSystemApps = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">      <span class="comment">// Stub packages must either be replaced with full versions in the /data</span></span><br><span class="line">      <span class="comment">// partition or be disabled.</span></span><br><span class="line">      <span class="keyword">final</span> List&lt;String&gt; stubSystemApps = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">      <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">          <span class="comment">// do this first before mucking with mPackages for the "expecting better" case</span></span><br><span class="line">          <span class="keyword">final</span> Iterator&lt;PackageParser.Package&gt; pkgIterator = mPackages.values().iterator();</span><br><span class="line">          <span class="keyword">while</span> (pkgIterator.hasNext()) &#123;</span><br><span class="line">              <span class="keyword">final</span> PackageParser.Package pkg = pkgIterator.next();</span><br><span class="line">              <span class="keyword">if</span> (pkg.isStub) &#123;</span><br><span class="line">                  stubSystemApps.add(pkg.packageName);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">final</span> Iterator&lt;PackageSetting&gt; psit = mSettings.mPackages.values().iterator();</span><br><span class="line">          <span class="keyword">while</span> (psit.hasNext()) &#123;</span><br><span class="line">              PackageSetting ps = psit.next();</span><br><span class="line"></span><br><span class="line">              <span class="comment">/*</span></span><br><span class="line"><span class="comment">               * If this is not a system app, it can't be a</span></span><br><span class="line"><span class="comment">               * disable system app.OTA的升级只涉及到系统app。</span></span><br><span class="line"><span class="comment">               */</span></span><br><span class="line">              <span class="keyword">if</span> ((ps.pkgFlags &amp; ApplicationInfo.FLAG_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">                  <span class="keyword">continue</span>;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/*</span></span><br><span class="line"><span class="comment">               * If the package is scanned, it's not erased.</span></span><br><span class="line"><span class="comment">               */</span></span><br><span class="line">              <span class="keyword">final</span> PackageParser.Package scannedPkg = mPackages.get(ps.name);</span><br><span class="line">              <span class="keyword">if</span> (scannedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   * If the system app is both scanned and in the</span></span><br><span class="line"><span class="comment">                   * disabled packages list, then it must have been</span></span><br><span class="line"><span class="comment">                   * added via OTA. Remove it from the currently</span></span><br><span class="line"><span class="comment">                   * scanned package so the previously user-installed</span></span><br><span class="line"><span class="comment">                   * application can be scanned.</span></span><br><span class="line"><span class="comment">                   */</span></span><br><span class="line">                  <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">                      removePackageLI(scannedPkg, <span class="keyword">true</span>);</span><br><span class="line">                      mExpectingBetter.put(ps.name, ps.codePath);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">continue</span>;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (!mSettings.isDisabledSystemPackageLPr(ps.name)) &#123;</span><br><span class="line">                  psit.remove();</span><br><span class="line">                  logCriticalInfo(Log.WARN, <span class="string">"System package "</span> + ps.name</span><br><span class="line">                          + <span class="string">" no longer exists; it's data will be wiped"</span>);</span><br><span class="line">                  <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">                  <span class="comment">// reconciliation step</span></span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// we still have a disabled system package, but, it still might have</span></span><br><span class="line">                  <span class="comment">// been removed. check the code path still exists and check there's</span></span><br><span class="line">                  <span class="comment">// still a package. the latter can happen if an OTA keeps the same</span></span><br><span class="line">                  <span class="comment">// code path, but, changes the package name.</span></span><br><span class="line">                  <span class="keyword">final</span> PackageSetting disabledPs =</span><br><span class="line">                          mSettings.getDisabledSystemPkgLPr(ps.name);</span><br><span class="line">                  <span class="keyword">if</span> (disabledPs.codePath == <span class="keyword">null</span> || !disabledPs.codePath.exists()</span><br><span class="line">                          || disabledPs.pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                      possiblyDeletedUpdatedSystemApps.add(ps.name);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//look for any incomplete package installations</span></span><br><span class="line"><span class="comment">//删除未完成安装的package</span></span><br><span class="line">      ArrayList&lt;PackageSetting&gt; deletePkgsList = mSettings.getListOfIncompleteInstallPackagesLPr();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deletePkgsList.size(); i++) &#123;</span><br><span class="line">          <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">          <span class="comment">// reconciliation step</span></span><br><span class="line">          <span class="keyword">final</span> String packageName = deletePkgsList.get(i).name;</span><br><span class="line">          logCriticalInfo(Log.WARN, <span class="string">"Cleaning up incompletely installed app: "</span> + packageName);</span><br><span class="line">          <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">              mSettings.removePackageLPw(packageName);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//delete tmp files</span></span><br><span class="line">      deleteTempPackageFiles();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> cachedSystemApps = PackageParser.sCachedPackageReadCount.get();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Remove any shared userIDs that have no associated packages</span></span><br><span class="line">      mSettings.pruneSharedUsersLPw();</span><br></pre></td></tr></table></figure>
<p>环境变量: 那可通过adb shell env来查看系统所有的环境变量及相应值。也可通过命令adb shell echo $SYSTEMSERVERCLASSPATH。 </p>
<p>SYSTEMSERVERCLASSPATH：主要包括/system/framework目录下services.jar，ethernet-service.jar，wifi-service.jar这3个文件。<br>BOOTCLASSPATH：该环境变量内容较多，不同ROM可能有所不同，常见内容包含/system/framework目录下的framework.jar，ext.jar，core-libart.jar，telephony-common.jar，ims-common.jar，core-junit.jar等文件。</p>
<p>scanDirLI(): 扫描指定目录下的apk文件，最终调用PackageParser.parseBaseApk来完成AndroidManifest.xml文件的解析，生成Application, activity,service,broadcast, provider等信息。<br>/vendor/overlay<br>/system/framework<br>/system/priv-app<br>/system/app<br>/vendor/priv-app<br>/vendor/app<br>/oem/app</p>
<p>该部分代码的细节暂不了解，以后有需要了再专门了解。</p>
<h4 id="阶段3：-BOOT-PROGRESS-PMS-DATA-SCAN-START"><a href="#阶段3：-BOOT-PROGRESS-PMS-DATA-SCAN-START" class="headerlink" title="阶段3： BOOT_PROGRESS_PMS_DATA_SCAN_START"></a>阶段3： <strong>BOOT_PROGRESS_PMS_DATA_SCAN_START</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">          EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START,</span><br><span class="line">                  SystemClock.uptimeMillis());</span><br><span class="line">          <span class="comment">// /data/app/</span></span><br><span class="line">          scanDirTracedLI(mAppInstallDir, <span class="number">0</span>, scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// /data/app-private/</span></span><br><span class="line">          scanDirTracedLI(mDrmAppPrivateInstallDir, mDefParseFlags</span><br><span class="line">                  | PackageParser.PARSE_FORWARD_LOCK,</span><br><span class="line">                  scanFlags | SCAN_REQUIRE_KNOWN, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Remove disable package settings for updated system apps that were</span></span><br><span class="line">          <span class="comment">// removed via an OTA. If the update is no longer present, remove the</span></span><br><span class="line">          <span class="comment">// app completely. Otherwise, revoke their system privileges.</span></span><br><span class="line">          <span class="keyword">for</span> (String deletedAppName : possiblyDeletedUpdatedSystemApps) &#123;</span><br><span class="line">              PackageParser.Package deletedPkg = mPackages.get(deletedAppName);</span><br><span class="line">              mSettings.removeDisabledSystemPackageLPw(deletedAppName);</span><br><span class="line"></span><br><span class="line">              <span class="keyword">final</span> String msg;</span><br><span class="line">              <span class="keyword">if</span> (deletedPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="comment">// should have found an update, but, we didn't; remove everything</span></span><br><span class="line">                  msg = <span class="string">"Updated system package "</span> + deletedAppName</span><br><span class="line">                          + <span class="string">" no longer exists; removing its data"</span>;</span><br><span class="line">                  <span class="comment">// Actual deletion of code and data will be handled by later</span></span><br><span class="line">                  <span class="comment">// reconciliation step</span></span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// found an update; revoke system privileges</span></span><br><span class="line">                  msg = <span class="string">"Updated system package + "</span> + deletedAppName</span><br><span class="line">                          + <span class="string">" no longer exists; revoking system privileges"</span>;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">// Don't do anything if a stub is removed from the system image. If</span></span><br><span class="line">                  <span class="comment">// we were to remove the uncompressed version from the /data partition,</span></span><br><span class="line">                  <span class="comment">// this is where it'd be done.</span></span><br><span class="line"></span><br><span class="line">                  <span class="keyword">final</span> PackageSetting deletedPs = mSettings.mPackages.get(deletedAppName);</span><br><span class="line">                  deletedPkg.applicationInfo.flags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">                  deletedPs.pkgFlags &amp;= ~ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">              &#125;</span><br><span class="line">              logCriticalInfo(Log.WARN, msg);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">           * Make sure all system apps that we expected to appear on</span></span><br><span class="line"><span class="comment">           * the userdata partition actually showed up. If they never</span></span><br><span class="line"><span class="comment">           * appeared, crawl back and revive the system version.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mExpectingBetter.size(); i++) &#123;</span><br><span class="line">              <span class="keyword">final</span> String packageName = mExpectingBetter.keyAt(i);</span><br><span class="line">              <span class="keyword">if</span> (!mPackages.containsKey(packageName)) &#123;</span><br><span class="line">                  <span class="keyword">final</span> File scanFile = mExpectingBetter.valueAt(i);</span><br><span class="line"></span><br><span class="line">                  logCriticalInfo(Log.WARN, <span class="string">"Expected better "</span> + packageName</span><br><span class="line">                          + <span class="string">" but never showed up; reverting to system"</span>);</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">int</span> reparseFlags = mDefParseFlags;</span><br><span class="line">                  <span class="keyword">if</span> (FileUtils.contains(privilegedAppDir, scanFile)) &#123;</span><br><span class="line">                      reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                              | PackageParser.PARSE_IS_SYSTEM_DIR</span><br><span class="line">                              | PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(systemAppDir, scanFile)) &#123;</span><br><span class="line">                      reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                              | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(vendorAppDir, scanFile)) &#123;</span><br><span class="line">                      reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                              | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FileUtils.contains(oemAppDir, scanFile)) &#123;</span><br><span class="line">                      reparseFlags = PackageParser.PARSE_IS_SYSTEM</span><br><span class="line">                              | PackageParser.PARSE_IS_SYSTEM_DIR;</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      Slog.e(TAG, <span class="string">"Ignoring unexpected fallback path "</span> + scanFile);</span><br><span class="line">                      <span class="keyword">continue</span>;</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  mSettings.enableSystemPackageLPw(packageName);</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      scanPackageTracedLI(scanFile, reparseFlags, scanFlags, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                      Slog.e(TAG, <span class="string">"Failed to parse original system package: "</span></span><br><span class="line">                              + e.getMessage());</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Uncompress and install any stubbed system applications.</span></span><br><span class="line">          <span class="comment">// This must be done last to ensure all stubs are replaced or disabled.</span></span><br><span class="line">          decompressSystemApplications(stubSystemApps, scanFlags);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> cachedNonSystemApps = PackageParser.sCachedPackageReadCount.get()</span><br><span class="line">                          - cachedSystemApps;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">long</span> dataScanTime = SystemClock.uptimeMillis() - systemScanTime - startTime;</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> dataPackagesCount = mPackages.size() - systemPackagesCount;</span><br><span class="line">          Slog.i(TAG, <span class="string">"Finished scanning non-system apps. Time: "</span> + dataScanTime</span><br><span class="line">                  + <span class="string">" ms, packageCount: "</span> + dataPackagesCount</span><br><span class="line">                  + <span class="string">" , timePerPackage: "</span></span><br><span class="line">                  + (dataPackagesCount == <span class="number">0</span> ? <span class="number">0</span> : dataScanTime / dataPackagesCount)</span><br><span class="line">                  + <span class="string">" , cached: "</span> + cachedNonSystemApps);</span><br><span class="line">          <span class="keyword">if</span> (mIsUpgrade &amp;&amp; dataPackagesCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              MetricsLogger.histogram(<span class="keyword">null</span>, <span class="string">"ota_package_manager_data_app_avg_scan_time"</span>,</span><br><span class="line">                      ((<span class="keyword">int</span>) dataScanTime) / dataPackagesCount);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      mExpectingBetter.clear();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Resolve the storage manager.</span></span><br><span class="line">      mStorageManagerPackage = getStorageManagerPackageName();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Resolve protected action filters. Only the setup wizard is allowed to</span></span><br><span class="line">      <span class="comment">// have a high priority filter for these actions.</span></span><br><span class="line">      mSetupWizardPackage = getSetupWizardPackageName();</span><br><span class="line">      <span class="keyword">if</span> (mProtectedFilters.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (DEBUG_FILTERS &amp;&amp; mSetupWizardPackage == <span class="keyword">null</span>) &#123;</span><br><span class="line">              Slog.i(TAG, <span class="string">"No setup wizard;"</span></span><br><span class="line">                  + <span class="string">" All protected intents capped to priority 0"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">for</span> (ActivityIntentInfo filter : mProtectedFilters) &#123;</span><br><span class="line">              <span class="keyword">if</span> (filter.activity.info.packageName.equals(mSetupWizardPackage)) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (DEBUG_FILTERS) &#123;</span><br><span class="line">                      Slog.i(TAG, <span class="string">"Found setup wizard;"</span></span><br><span class="line">                          + <span class="string">" allow priority "</span> + filter.getPriority() + <span class="string">";"</span></span><br><span class="line">                          + <span class="string">" package: "</span> + filter.activity.info.packageName</span><br><span class="line">                          + <span class="string">" activity: "</span> + filter.activity.className</span><br><span class="line">                          + <span class="string">" priority: "</span> + filter.getPriority());</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="comment">// skip setup wizard; allow it to keep the high priority filter</span></span><br><span class="line">                  <span class="keyword">continue</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (DEBUG_FILTERS) &#123;</span><br><span class="line">                  Slog.i(TAG, <span class="string">"Protected action; cap priority to 0;"</span></span><br><span class="line">                          + <span class="string">" package: "</span> + filter.activity.info.packageName</span><br><span class="line">                          + <span class="string">" activity: "</span> + filter.activity.className</span><br><span class="line">                          + <span class="string">" origPrio: "</span> + filter.getPriority());</span><br><span class="line">              &#125;</span><br><span class="line">              filter.setPriority(<span class="number">0</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      mDeferProtectedFilters = <span class="keyword">false</span>;</span><br><span class="line">      mProtectedFilters.clear();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Now that we know all of the shared libraries, update all clients to have</span></span><br><span class="line">      <span class="comment">// the correct library paths.</span></span><br><span class="line">      updateAllSharedLibrariesLPw(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (SharedUserSetting setting : mSettings.getAllSharedUsersLPw()) &#123;</span><br><span class="line">          <span class="comment">// <span class="doctag">NOTE:</span> We ignore potential failures here during a system scan (like</span></span><br><span class="line">          <span class="comment">// the rest of the commands above) because there's precious little we</span></span><br><span class="line">          <span class="comment">// can do about it. A settings error is reported, though.</span></span><br><span class="line">          adjustCpuAbisForSharedUserLPw(setting.packages, <span class="keyword">null</span> <span class="comment">/*scannedPackage*/</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Now that we know all the packages we are keeping,</span></span><br><span class="line">      <span class="comment">// read and update their last usage times.</span></span><br><span class="line">      mPackageUsage.read(mPackages);</span><br><span class="line">      mCompilerStats.read();</span><br></pre></td></tr></table></figure>
<p>当mOnlyCore = false时，则scanDirLI()还会收集如下目录中的apk：<br>/data/app<br>/data/app-private：DRM保护的APK文件</p>
<h4 id="阶段4：BOOT-PROGRESS-PMS-SCAN-END"><a href="#阶段4：BOOT-PROGRESS-PMS-SCAN-END" class="headerlink" title="阶段4：BOOT_PROGRESS_PMS_SCAN_END"></a>阶段4：<strong>BOOT_PROGRESS_PMS_SCAN_END</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SCAN_END,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">            Slog.i(TAG, <span class="string">"Time to scan packages: "</span></span><br><span class="line">                    + ((SystemClock.uptimeMillis()-startTime)/<span class="number">1000f</span>)</span><br><span class="line">                    + <span class="string">" seconds"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If the platform SDK has changed since the last time we booted,</span></span><br><span class="line">            <span class="comment">// we need to re-grant app permission to catch any new ones that</span></span><br><span class="line">            <span class="comment">// appear.  This is really a hack, and means that apps can in some</span></span><br><span class="line">            <span class="comment">// cases get permissions that the user didn't initially explicitly</span></span><br><span class="line">            <span class="comment">// allow...  it would be nice to have some better way to handle</span></span><br><span class="line">            <span class="comment">// this situation.</span></span><br><span class="line">            <span class="keyword">int</span> updateFlags = UPDATE_PERMISSIONS_ALL;</span><br><span class="line">            <span class="keyword">if</span> (ver.sdkVersion != mSdkVersion) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Platform changed from "</span> + ver.sdkVersion + <span class="string">" to "</span></span><br><span class="line">                        + mSdkVersion + <span class="string">"; regranting permissions for internal storage"</span>);</span><br><span class="line">                updateFlags |= UPDATE_PERMISSIONS_REPLACE_PKG | UPDATE_PERMISSIONS_REPLACE_ALL;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//当sdk版本不一致时，,更新相关信息，并给需要使用权限的apk分配相应的权限</span></span><br><span class="line">            updatePermissionsLPw(<span class="keyword">null</span>, <span class="keyword">null</span>, StorageManager.UUID_PRIVATE_INTERNAL, updateFlags);</span><br><span class="line">            ver.sdkVersion = mSdkVersion;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this is the first boot or an update from pre-M, and it is a normal</span></span><br><span class="line">            <span class="comment">// boot, then we need to initialize the default preferred apps across</span></span><br><span class="line">            <span class="comment">// all defined users.</span></span><br><span class="line">            <span class="comment">//当这是ota后的首次启动，正常启动则需要清除目录的缓存代码</span></span><br><span class="line">            <span class="keyword">if</span> (!onlyCore &amp;&amp; (mPromoteSystemApps || !mRestoredSettings)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (UserInfo user : sUserManager.getUsers(<span class="keyword">true</span>)) &#123;</span><br><span class="line">                    mSettings.applyDefaultPreferredAppsLPw(<span class="keyword">this</span>, user.id);</span><br><span class="line">                    applyFactoryDefaultBrowserLPw(user.id);</span><br><span class="line">                    primeDomainVerificationsLPw(user.id);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Prepare storage for system user really early during boot,</span></span><br><span class="line">            <span class="comment">// since core system apps like SettingsProvider and SystemUI</span></span><br><span class="line">            <span class="comment">// can't wait for user to start</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> storageFlags;</span><br><span class="line">            <span class="keyword">if</span> (StorageManager.isFileEncryptedNativeOrEmulated()) &#123;</span><br><span class="line">                storageFlags = StorageManager.FLAG_STORAGE_DE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                storageFlags = StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE;</span><br><span class="line">            &#125;</span><br><span class="line">            reconcileAppsDataLI(StorageManager.UUID_PRIVATE_INTERNAL, UserHandle.USER_SYSTEM,</span><br><span class="line">                    storageFlags);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this is first boot after an OTA, and a normal boot, then</span></span><br><span class="line">            <span class="comment">// we need to clear code cache directories.</span></span><br><span class="line">            <span class="comment">// Note that we do *not* clear the application profiles. These remain valid</span></span><br><span class="line">            <span class="comment">// across OTAs and are used to drive profile verification (post OTA) and</span></span><br><span class="line">            <span class="comment">// profile compilation (without waiting to collect a fresh set of profiles).</span></span><br><span class="line">            <span class="keyword">if</span> (mIsUpgrade &amp;&amp; !onlyCore) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Build fingerprint changed; clearing code caches"</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSettings.mPackages.size(); i++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.valueAt(i);</span><br><span class="line">                    <span class="keyword">if</span> (Objects.equals(StorageManager.UUID_PRIVATE_INTERNAL, ps.volumeUuid)) &#123;</span><br><span class="line">                        <span class="comment">// No apps are running this early, so no need to freeze</span></span><br><span class="line">                        clearAppDataLIF(ps.pkg, UserHandle.USER_ALL,</span><br><span class="line">                                StorageManager.FLAG_STORAGE_DE | StorageManager.FLAG_STORAGE_CE</span><br><span class="line">                                        | Installer.FLAG_CLEAR_CODE_CACHE_ONLY);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                ver.fingerprint = Build.FINGERPRINT;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            checkDefaultBrowser();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// clear only after permissions and other defaults have been updated</span></span><br><span class="line">            <span class="comment">//当权限和其他默认项都完成更新，则清理相关信息</span></span><br><span class="line">            mExistingSystemPackages.clear();</span><br><span class="line">            mPromoteSystemApps = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// All the changes are done during package scanning.</span></span><br><span class="line">            ver.databaseVersion = Settings.CURRENT_DATABASE_VERSION;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// can downgrade to reader</span></span><br><span class="line">            <span class="comment">//信息写回packages.xml文件</span></span><br><span class="line">            mSettings.writeLPr();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Perform dexopt on all apps that mark themselves as coreApps. We do this pretty</span></span><br><span class="line">            <span class="comment">// early on (before the package manager declares itself as early) because other</span></span><br><span class="line">            <span class="comment">// components in the system server might ask for package contexts for these apps.</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// Note that "onlyCore" in this context means the system is encrypted or encrypting</span></span><br><span class="line">            <span class="comment">// (i.e, that the data partition is unavailable).</span></span><br><span class="line">            <span class="keyword">if</span> ((isFirstBoot() || isUpgrade() || VMRuntime.didPruneDalvikCache()) &amp;&amp; !onlyCore) &#123;</span><br><span class="line">                <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">                List&lt;PackageParser.Package&gt; coreApps = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                <span class="keyword">for</span> (PackageParser.Package pkg : mPackages.values()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (pkg.coreApp) &#123;</span><br><span class="line">                        coreApps.add(pkg);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span>[] stats = performDexOpt(coreApps, <span class="keyword">false</span>,</span><br><span class="line">                        getCompilerFilterForReason(REASON_CORE_APP));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> elapsedTimeSeconds =</span><br><span class="line">                        (<span class="keyword">int</span>) TimeUnit.NANOSECONDS.toSeconds(System.nanoTime() - start);</span><br><span class="line">                MetricsLogger.histogram(mContext, <span class="string">"opt_coreapps_time_s"</span>, elapsedTimeSeconds);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_DEXOPT) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Dex-opt core apps took : "</span> + elapsedTimeSeconds + <span class="string">" seconds ("</span> +</span><br><span class="line">                            stats[<span class="number">0</span>] + <span class="string">", "</span> + stats[<span class="number">1</span>] + <span class="string">", "</span> + stats[<span class="number">2</span>] + <span class="string">")"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<h4 id="阶段5：BOOT-PROGRESS-PMS-READY"><a href="#阶段5：BOOT-PROGRESS-PMS-READY" class="headerlink" title="阶段5：BOOT_PROGRESS_PMS_READY"></a>阶段5：<strong>BOOT_PROGRESS_PMS_READY</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_READY,</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mOnlyCore) &#123;</span><br><span class="line">                mRequiredVerifierPackage = getRequiredButNotReallyRequiredVerifierLPr();</span><br><span class="line">                mRequiredInstallerPackage = getRequiredInstallerLPr();</span><br><span class="line">                mIntentFilterVerifierComponent = getIntentFilterVerifierComponentNameLPr();</span><br><span class="line">                mIntentFilterVerifier = <span class="keyword">new</span> IntentVerifierProxy(mContext,</span><br><span class="line">                        mIntentFilterVerifierComponent);</span><br><span class="line">                mServicesSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">                        PackageManager.SYSTEM_SHARED_LIBRARY_SERVICES);</span><br><span class="line">                mSharedSystemSharedLibraryPackageName = getRequiredSharedLibraryLPr(</span><br><span class="line">                        PackageManager.SYSTEM_SHARED_LIBRARY_SHARED);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mRequiredVerifierPackage = <span class="keyword">null</span>;</span><br><span class="line">                mRequiredInstallerPackage = <span class="keyword">null</span>;</span><br><span class="line">                mIntentFilterVerifierComponent = <span class="keyword">null</span>;</span><br><span class="line">                mIntentFilterVerifier = <span class="keyword">null</span>;</span><br><span class="line">                mServicesSystemSharedLibraryPackageName = <span class="keyword">null</span>;</span><br><span class="line">                mSharedSystemSharedLibraryPackageName = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mInstallerService = <span class="keyword">new</span> PackageInstallerService(context, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> ComponentName ephemeralResolverComponent = getEphemeralResolverLPr();</span><br><span class="line">            <span class="keyword">final</span> ComponentName ephemeralInstallerComponent = getEphemeralInstallerLPr();</span><br><span class="line">            <span class="comment">// both the installer and resolver must be present to enable ephemeral</span></span><br><span class="line">            <span class="keyword">if</span> (ephemeralInstallerComponent != <span class="keyword">null</span> &amp;&amp; ephemeralResolverComponent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_EPHEMERAL) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Ephemeral activated; resolver: "</span> + ephemeralResolverComponent</span><br><span class="line">                            + <span class="string">" installer:"</span> + ephemeralInstallerComponent);</span><br><span class="line">                &#125;</span><br><span class="line">                mEphemeralResolverComponent = ephemeralResolverComponent;</span><br><span class="line">                mEphemeralInstallerComponent = ephemeralInstallerComponent;</span><br><span class="line">                setUpEphemeralInstallerActivityLP(mEphemeralInstallerComponent);</span><br><span class="line">                mEphemeralResolverConnection =</span><br><span class="line">                        <span class="keyword">new</span> EphemeralResolverConnection(mContext, mEphemeralResolverComponent);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_EPHEMERAL) &#123;</span><br><span class="line">                    <span class="keyword">final</span> String missingComponent =</span><br><span class="line">                            (ephemeralResolverComponent == <span class="keyword">null</span>)</span><br><span class="line">                            ? (ephemeralInstallerComponent == <span class="keyword">null</span>)</span><br><span class="line">                                    ? <span class="string">"resolver and installer"</span></span><br><span class="line">                                    : <span class="string">"resolver"</span></span><br><span class="line">                            : <span class="string">"installer"</span>;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Ephemeral deactivated; missing "</span> + missingComponent);</span><br><span class="line">                &#125;</span><br><span class="line">                mEphemeralResolverComponent = <span class="keyword">null</span>;</span><br><span class="line">                mEphemeralInstallerComponent = <span class="keyword">null</span>;</span><br><span class="line">                mEphemeralResolverConnection = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mEphemeralApplicationRegistry = <span class="keyword">new</span> EphemeralApplicationRegistry(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="comment">// synchronized (mPackages)</span></span><br><span class="line">        &#125; <span class="comment">// synchronized (mInstallLock)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now after opening every single application zip, make sure they</span></span><br><span class="line">        <span class="comment">// are all flushed.  Not really needed, but keeps things nice and</span></span><br><span class="line">        <span class="comment">// tidy.</span></span><br><span class="line">        Runtime.getRuntime().gc();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The initial scanning above does many calls into installd while</span></span><br><span class="line">        <span class="comment">// holding the mPackages lock, but we're mostly interested in yelling</span></span><br><span class="line">        <span class="comment">// once we have a booted system.</span></span><br><span class="line">        mInstaller.setWarnIfHeld(mPackages);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Expose private service for system components to use.</span></span><br><span class="line">        LocalServices.addService(PackageManagerInternal.class, <span class="keyword">new</span> PackageManagerInternalImpl());</span><br></pre></td></tr></table></figure>
<p>创建PackageInstallerService服务。</p>
<p><strong>PKMS初始化过程，分为5个阶段：</strong><br><strong>PMS_START阶段：</strong><br>创建Settings对象；<br>将6类shareUserId到mSettings；<br>初始化SystemConfig；<br>创建名为“PackageManager”的handler线程mHandlerThread;<br>创建UserManagerService多用户管理服务；<br>通过解析4大目录中的xmL文件构造共享mSharedLibraries；<br><strong>PMS_SYSTEM_SCAN_START阶段：</strong><br>扫描系统apk;<br><strong>PMS_DATA_SCAN_START阶段：</strong><br>扫描/data/app目录下的apk;<br>扫描/data/app-private目录下的apk;<br><strong>PMS_SCAN_END阶段：</strong><br>将上述信息写回/data/system/packages.xml;<br><strong>PMS_READY阶段：</strong><br>创建服务PackageInstallerService；</p>
<p>回到PKMS的main方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title">main</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// Self-check for initial settings.</span></span><br><span class="line">     PackageManagerServiceCompilerMapping.checkProperties();</span><br><span class="line"></span><br><span class="line">     PackageManagerService m = <span class="keyword">new</span> PackageManagerService(context, installer,</span><br><span class="line">             factoryTest, onlyCore);</span><br><span class="line">     m.enableSystemUserPackages();</span><br><span class="line">     ServiceManager.addService(<span class="string">"package"</span>, m);</span><br><span class="line">     <span class="keyword">final</span> PackageManagerNative pmn = m.new PackageManagerNative();</span><br><span class="line">     ServiceManager.addService(<span class="string">"package_native"</span>, pmn);</span><br><span class="line">     <span class="keyword">return</span> m;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>PKSM初始化后会将服务添加到ServiceManager中。之后在SystemServer的startOtherServices()方法中会调用PKSM的systemReady()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    enforceSystemOrRoot(<span class="string">"Only the system can claim the system is ready"</span>);</span><br><span class="line"></span><br><span class="line">    mSystemReady = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">final</span> ContentResolver resolver = mContext.getContentResolver();</span><br><span class="line">    ContentObserver co = <span class="keyword">new</span> ContentObserver(mHandler) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChange</span><span class="params">(<span class="keyword">boolean</span> selfChange)</span> </span>&#123;</span><br><span class="line">            mEphemeralAppsDisabled =</span><br><span class="line">                    (Global.getInt(resolver, Global.ENABLE_EPHEMERAL_FEATURE, <span class="number">1</span>) == <span class="number">0</span>) ||</span><br><span class="line">                            (Secure.getInt(resolver, Secure.INSTANT_APPS_ENABLED, <span class="number">1</span>) == <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    mContext.getContentResolver().registerContentObserver(android.provider.Settings.Global</span><br><span class="line">                    .getUriFor(Global.ENABLE_EPHEMERAL_FEATURE),</span><br><span class="line">            <span class="keyword">false</span>, co, UserHandle.USER_SYSTEM);</span><br><span class="line">    mContext.getContentResolver().registerContentObserver(android.provider.Settings.Global</span><br><span class="line">                    .getUriFor(Secure.INSTANT_APPS_ENABLED), <span class="keyword">false</span>, co, UserHandle.USER_SYSTEM);</span><br><span class="line">    co.onChange(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Disable any carrier apps. We do this very early in boot to prevent the apps from being</span></span><br><span class="line">    <span class="comment">// disabled after already being started.</span></span><br><span class="line">    CarrierAppUtils.disableCarrierAppsUntilPrivileged(mContext.getOpPackageName(), <span class="keyword">this</span>,</span><br><span class="line">            mContext.getContentResolver(), UserHandle.USER_SYSTEM);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read the compatibilty setting when the system is ready.</span></span><br><span class="line">    <span class="keyword">boolean</span> compatibilityModeEnabled = android.provider.Settings.Global.getInt(</span><br><span class="line">            mContext.getContentResolver(),</span><br><span class="line">            android.provider.Settings.Global.COMPATIBILITY_MODE, <span class="number">1</span>) == <span class="number">1</span>;</span><br><span class="line">    PackageParser.setCompatibilityModeEnabled(compatibilityModeEnabled);</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SETTINGS) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"compatibility mode:"</span> + compatibilityModeEnabled);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] grantPermissionsUserIds = EMPTY_INT_ARRAY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// Verify that all of the preferred activity components actually</span></span><br><span class="line">        <span class="comment">// exist.  It is possible for applications to be updated and at</span></span><br><span class="line">        <span class="comment">// that point remove a previously declared activity component that</span></span><br><span class="line">        <span class="comment">// had been set as a preferred activity.  We try to clean this up</span></span><br><span class="line">        <span class="comment">// the next time we encounter that preferred activity, but it is</span></span><br><span class="line">        <span class="comment">// possible for the user flow to never be able to return to that</span></span><br><span class="line">        <span class="comment">// situation so here we do a sanity check to make sure we haven't</span></span><br><span class="line">        <span class="comment">// left any junk around.</span></span><br><span class="line">        ArrayList&lt;PreferredActivity&gt; removed = <span class="keyword">new</span> ArrayList&lt;PreferredActivity&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mSettings.mPreferredActivities.size(); i++) &#123;</span><br><span class="line">            PreferredIntentResolver pir = mSettings.mPreferredActivities.valueAt(i);</span><br><span class="line">            removed.clear();</span><br><span class="line">            <span class="keyword">for</span> (PreferredActivity pa : pir.filterSet()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mActivities.mActivities.get(pa.mPref.mComponent) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    removed.add(pa);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (removed.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;removed.size(); r++) &#123;</span><br><span class="line">                    PreferredActivity pa = removed.get(r);</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Removing dangling preferred activity: "</span></span><br><span class="line">                            + pa.mPref.mComponent);</span><br><span class="line">                    pir.removeFilter(pa);</span><br><span class="line">                &#125;</span><br><span class="line">                mSettings.writePackageRestrictionsLPr(</span><br><span class="line">                        mSettings.mPreferredActivities.keyAt(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> userId : UserManagerService.getInstance().getUserIds()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSettings.areDefaultRuntimePermissionsGrantedLPr(userId)) &#123;</span><br><span class="line">                grantPermissionsUserIds = ArrayUtils.appendInt(</span><br><span class="line">                        grantPermissionsUserIds, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sUserManager.systemReady();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we upgraded grant all default permissions before kicking off.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> userId : grantPermissionsUserIds) &#123;</span><br><span class="line">        mDefaultPermissionPolicy.grantDefaultPermissions(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we did not grant default permissions, we preload from this the</span></span><br><span class="line">    <span class="comment">// default permission exceptions lazily to ensure we don't hit the</span></span><br><span class="line">    <span class="comment">// disk on a new user creation.</span></span><br><span class="line">    <span class="keyword">if</span> (grantPermissionsUserIds == EMPTY_INT_ARRAY) &#123;</span><br><span class="line">        mDefaultPermissionPolicy.scheduleReadDefaultPermissionExceptions();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Kick off any messages waiting for system ready</span></span><br><span class="line">    <span class="keyword">if</span> (mPostSystemReadyMessages != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Message msg : mPostSystemReadyMessages) &#123;</span><br><span class="line">            msg.sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">        mPostSystemReadyMessages = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Watch for external volumes that come and go over time</span></span><br><span class="line">    <span class="keyword">final</span> StorageManager storage = mContext.getSystemService(StorageManager.class);</span><br><span class="line">    storage.registerListener(mStorageListener);</span><br><span class="line"></span><br><span class="line">    mInstallerService.systemReady();</span><br><span class="line">    mPackageDexOptimizer.systemReady();</span><br><span class="line"></span><br><span class="line">    StorageManagerInternal StorageManagerInternal = LocalServices.getService(</span><br><span class="line">            StorageManagerInternal.class);</span><br><span class="line">    StorageManagerInternal.addExternalStoragePolicy(</span><br><span class="line">            <span class="keyword">new</span> StorageManagerInternal.ExternalStorageMountPolicy() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMountMode</span><span class="params">(<span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (Process.isIsolated(uid)) &#123;</span><br><span class="line">                <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_NONE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (checkUidPermission(WRITE_MEDIA_STORAGE, uid) == PERMISSION_GRANTED) &#123;</span><br><span class="line">                <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_DEFAULT;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (checkUidPermission(READ_EXTERNAL_STORAGE, uid) == PERMISSION_DENIED) &#123;</span><br><span class="line">                <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_DEFAULT;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (checkUidPermission(WRITE_EXTERNAL_STORAGE, uid) == PERMISSION_DENIED) &#123;</span><br><span class="line">                <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_READ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_WRITE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasExternalStorage</span><span class="params">(<span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now that we're mostly running, clean up stale users and apps</span></span><br><span class="line">    sUserManager.reconcileUsers(StorageManager.UUID_PRIVATE_INTERNAL);</span><br><span class="line">    reconcileApps(StorageManager.UUID_PRIVATE_INTERNAL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPrivappPermissionsViolations != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG,<span class="string">"Signature|privileged permissions not in "</span></span><br><span class="line">                + <span class="string">"privapp-permissions whitelist: "</span> + mPrivappPermissionsViolations);</span><br><span class="line">        mPrivappPermissionsViolations = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，PKMS启动完毕。</p>
<h2 id="已知的PKMS获取方式"><a href="#已知的PKMS获取方式" class="headerlink" title="已知的PKMS获取方式"></a>已知的PKMS获取方式</h2><p>PackageManager -&gt;ApplicationPackageManager -&gt; mPm</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IBinder b = ServiceManager.getService(<span class="string">"package"</span>);</span><br><span class="line"><span class="comment">//Slog.v("PackageManager", "default service binder = " + b);</span></span><br><span class="line">PackageManager packageManager = IPackageManager.Stub.asInterface(b);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.getPackageManager();</span><br></pre></td></tr></table></figure>
<p>上面的所有代码基于Android O，有些细节没做了解，有些流程还没有理清，待以后进一步熟悉后再做补充完善，先对已了解内容做个记录。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
      

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/08/28/应用安装-点击apk安装/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          应用安装-点击apk安装
        
      </div>
    </a>
  
  
    <a href="/2018/07/28/ABI确定过程/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">ABI确定过程</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="toc-sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#PKMS启动过程"><span class="nav-number">1.</span> <span class="nav-text">PKMS启动过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-PKMS启动过程"><span class="nav-number">1.1.</span> <span class="nav-text">1. PKMS启动过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-PKMS构造过程"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1 PKMS构造过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#阶段1：BOOT-PROGRESS-PMS-START"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">阶段1：BOOT_PROGRESS_PMS_START</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#阶段2：BOOT-PROGRESS-PMS-SYSTEM-SCAN-START"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">阶段2：BOOT_PROGRESS_PMS_SYSTEM_SCAN_START</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#阶段3：-BOOT-PROGRESS-PMS-DATA-SCAN-START"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">阶段3： BOOT_PROGRESS_PMS_DATA_SCAN_START</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#阶段4：BOOT-PROGRESS-PMS-SCAN-END"><span class="nav-number">1.1.1.4.</span> <span class="nav-text">阶段4：BOOT_PROGRESS_PMS_SCAN_END</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#阶段5：BOOT-PROGRESS-PMS-READY"><span class="nav-number">1.1.1.5.</span> <span class="nav-text">阶段5：BOOT_PROGRESS_PMS_READY</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#已知的PKMS获取方式"><span class="nav-number">1.2.</span> <span class="nav-text">已知的PKMS获取方式</span></a></li></ol></li></ol>
    
    </div>
  </aside>

</section>
        
      </div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2018 - 2019 得一 All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>


  <script src="/js/home.js"></script>



  <script src="/js/dialog.js"></script>









	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            得一
          </div>
          <div class="panel-body">
            Copyright © 2019 me All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
    <a id="menu-switch"><i class="fa fa-bars fa-lg"></i></a>
  
</body>
</html>